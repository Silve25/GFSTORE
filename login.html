<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Se connecter ‚Äî GF Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Connectez-vous √† votre compte GF Store pour suivre vos commandes et acc√©der √† vos informations." />
  <meta name="format-detection" content="telephone=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="css/vendor.css">
  <link rel="stylesheet" href="style.css">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;700&family=Marcellus&display=swap" rel="stylesheet" />

  <style>
    :root{ --cardW: 640px; }
    body{ background:#fafafa; }
    .auth-wrap{ min-height:100vh; display:flex; align-items:center; padding:32px 0; }
    .brand-mini{ font-family: "Marcellus", serif; letter-spacing:.02em; }
    .card-auth{ max-width:var(--cardW); margin:0 auto; border:1px solid #eee; box-shadow:0 12px 40px rgba(0,0,0,.06); }
    .input-icon{ position:relative }
    .input-icon .toggle-eye{ position:absolute; right:.75rem; top:50%; transform:translateY(-50%); background:none; border:0; padding:0; }
    .toast-container{ z-index:1080 }
    .link-muted{ color:inherit; opacity:.75; text-decoration:none }
    .link-muted:hover{ opacity:1; }
    .small-help{ opacity:.8 }
  </style>
</head>
<body>

  <!-- Header simple -->
  <nav class="navbar navbar-expand-lg bg-white border-bottom fixed-top">
    <div class="container">
      <a class="navbar-brand brand-mini" href="index.html">GF Store</a>
      <div class="d-flex gap-2">
        <a class="btn btn-sm btn-outline-secondary d-none d-md-inline" href="catalogue.html">Catalogue</a>
        <a class="btn btn-sm btn-dark" href="register.html">Cr√©er un compte</a>
      </div>
    </div>
  </nav>

  <main class="auth-wrap">
    <div class="container">
      <div class="card card-auth rounded-4">
        <div class="row g-0">
          <!-- Visuel (masqu√© en mobile) -->
          <div class="col-lg-5 d-none d-lg-block">
            <div class="h-100 w-100" style="background:url('images/single-image-2.jpg') center/cover no-repeat; border-top-left-radius:1rem; border-bottom-left-radius:1rem;"></div>
          </div>

          <!-- Formulaire -->
          <div class="col-lg-7">
            <div class="p-4 p-md-5">
              <h1 class="h3 mb-1">Se connecter</h1>
              <p class="text-secondary mb-4">Renseignez vos identifiants pour acc√©der √† votre compte. <a class="link-muted" href="register.html">Nouveau client ?</a></p>

              <form id="loginForm" novalidate>
                <div class="row g-3">
                  <div class="col-12">
                    <label class="form-label" for="email">Email</label>
                    <input class="form-control" id="email" name="email" type="email" autocomplete="email" required>
                    <div class="invalid-feedback">Adresse email invalide.</div>
                  </div>

                  <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center">
                      <label class="form-label mb-1" for="password">Mot de passe</label>
                      <a href="password-reset.html" class="small link-muted">Mot de passe oubli√© ?</a>
                    </div>
                    <div class="input-icon">
                      <input class="form-control" id="password" name="password" type="password" required>
                      <button class="toggle-eye" type="button" tabindex="-1" aria-label="Afficher/masquer">üëÅÔ∏è</button>
                      <div class="invalid-feedback">Veuillez entrer votre mot de passe.</div>
                    </div>
                  </div>

                  <div class="col-12 d-flex justify-content-between align-items-center">
                    <div class="form-check">
                      <input class="form-check-input" id="remember" type="checkbox">
                      <label class="form-check-label" for="remember">Se souvenir de moi</label>
                    </div>
                    <a class="small link-muted" href="confidentialite.html">Confidentialit√©</a>
                  </div>

                  <div class="col-12">
                    <button class="btn btn-dark w-100" type="submit">Connexion</button>
                  </div>

                  <div class="col-12">
                    <p class="small text-secondary mb-0 small-help">
                      En continuant, vous acceptez nos <a href="cgu.html">Conditions G√©n√©rales</a>. Paiement accept√© : <strong>Virement bancaire uniquement</strong>.
                    </p>
                  </div>
                </div>
              </form>

              <hr class="my-4">
              <div class="d-flex justify-content-between">
                <a class="btn btn-outline-secondary" href="index.html#nouveautes">Nouveaut√©s</a>
                <a class="btn btn-outline-secondary" href="catalogue.html">Voir le catalogue</a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- toasts -->
      <div class="position-fixed top-0 end-0 p-3 toast-container">
        <div id="toastOK" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">Connexion r√©ussie. Redirection‚Ä¶</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fermer"></button>
          </div>
        </div>
        <div id="toastErr" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">Identifiants invalides. R√©essayez.</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fermer"></button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer mini -->
  <footer class="py-4 border-top">
    <div class="container d-flex flex-wrap justify-content-between align-items-center gap-3">
      <small>¬© 2025 GF Store</small>
      <div class="small text-secondary">Besoin d‚Äôaide ? <a href="contact.html">Contact</a> ¬∑ <a href="faq.html">FAQ</a></div>
    </div>
  </footer>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="js/app.js"></script>

  <script>
    (function(){
      const form = document.getElementById('loginForm');
      const email = document.getElementById('email');
      const password = document.getElementById('password');
      const remember = document.getElementById('remember');

      // show/hide password
      document.querySelectorAll('.toggle-eye').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          password.type = password.type === 'password' ? 'text' : 'password';
        });
      });

      const toastOK = new bootstrap.Toast(document.getElementById('toastOK'), {delay:1500});
      const toastErr = new bootstrap.Toast(document.getElementById('toastErr'), {delay:2200});

      function setInvalid(el, cond){
        if(cond){ el.classList.add('is-invalid'); } else { el.classList.remove('is-invalid'); }
      }

      // R√©cup√®re un √©ventuel redirect (?redirect=/checkout.html)
      function getRedirect(){
        const u = new URL(window.location.href);
        let r = u.searchParams.get('redirect') || '';
        try {
          // anti open-redirect : on n'autorise que des chemins locaux
          const url = new URL(r, window.location.origin);
          if(url.origin !== window.location.origin) return 'index.html';
          return url.pathname + url.search + url.hash;
        } catch { return 'index.html'; }
      }

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        // validations basiques
        setInvalid(email, !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.value));
        setInvalid(password, !password.value);

        if (document.querySelectorAll('.is-invalid').length) { toastErr.show(); return; }

        const payload = {
          email: email.value.trim().toLowerCase(),
          password: password.value,
          remember: !!remember.checked
        };

        try{
          if(window.App && typeof App.login === 'function'){
            await App.login(payload);
          } else {
            // Fallback local : v√©rifier dans localStorage (cr√©√© par register.html)
            const users = JSON.parse(localStorage.getItem('gf_users') || '[]');
            const found = users.find(u => u.email === payload.email);
            if(!found) throw new Error('notfound');
            // ici, simple check = m√™me password (DEMO). En prod, utiliser un hash c√¥t√© serveur.
            if(found.password !== payload.password) throw new Error('badpass');

            // Session
            const session = { email: found.email, firstName: found.firstName || '' };
            localStorage.setItem('gf_session', JSON.stringify(session));
            if(payload.remember){
              // cookie de confort (non-sensible), 30 jours
              document.cookie = `gf_rmb=${encodeURIComponent(found.email)}; Max-Age=${30*24*3600}; Path=/; SameSite=Lax`;
            }
          }

          toastOK.show();
          setTimeout(()=>{
            const redirect = getRedirect();
            window.location.href = redirect || 'index.html';
          }, 1200);
        }catch(err){
          console.error(err);
          const b = document.querySelector('#toastErr .toast-body');
          b.textContent = (err && (err.message==='notfound' || err.message==='badpass'))
            ? 'Email ou mot de passe incorrect.'
            : "Connexion impossible pour le moment.";
          toastErr.show();
        }
      });

      // Pr√©-remplir email depuis cookie remember le cas √©ch√©ant
      const m = document.cookie.match(/(?:^|;\s*)gf_rmb=([^;]+)/);
      if(m){ try{ email.value = decodeURIComponent(m[1]); }catch{} }
    })();
  </script>
</body>
</html>
