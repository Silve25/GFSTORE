<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GF Store â€” Accueil</title>
  <meta name="description" content="GF Store â€” Ã‰lectronique premium. Livraison 24â€‘48h, assistance 24/7, paiement sÃ©curisÃ©." />

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --muted:#6b7280; --text:#0f172a; --accent:#0ea5a4; --danger:#ef4444;
      --glass: rgba(255,255,255,0.6); --shadow: 0 10px 30px rgba(15,23,42,0.10);
      --ring: 0 0 0 3px rgba(14,165,164,0.2);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:linear-gradient(180deg,var(--bg), #e9eef6 160%); color:var(--text); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    a{color:inherit}

    /* Topbar */
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:18px 28px;backdrop-filter: blur(8px);background:var(--glass);box-shadow:var(--shadow);position:sticky;top:0;z-index:50}
    .brand{display:flex;gap:12px;align-items:center}
    .brand .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#06b6d4);display:flex;align-items:center;justify-content:center;color:white;font-weight:800}
    .search{flex:1;margin:0 20px}
    .searchbox{position:relative}
    .search input{width:100%;padding:12px 14px 12px 40px;border-radius:14px;border:1px solid rgba(0,0,0,0.06);background:transparent;color:var(--text);box-shadow:0 1px 0 rgba(0,0,0,0.02)}
    .search input:focus{outline:none; box-shadow:var(--ring)}
    .search .lens{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:14px;color:var(--muted)}
    .suggest{position:absolute;top:100%;left:0;right:0;background:var(--card);border:1px solid rgba(0,0,0,0.06);border-radius:12px;box-shadow:var(--shadow);margin-top:6px;display:none;z-index:60;max-height:50vh;overflow:auto}
    .suggest.open{display:block}
    .suggest-item{padding:10px 12px;display:flex;gap:10px;align-items:center;cursor:pointer}
    .suggest-item:hover{background:rgba(0,0,0,0.04)}
    .suggest-item img{width:36px;height:36px;object-fit:contain;border-radius:8px}

    .actions{display:flex;gap:12px;align-items:center}
    .btn{position:relative;overflow:hidden;padding:10px 14px;border-radius:12px;border:0;background:var(--card);box-shadow:var(--shadow);cursor:pointer;transition:transform .06s ease}
    .btn:active{transform:scale(0.98)}
    .icon-btn{display:inline-flex;align-items:center;gap:8px}

    /* Icons */
    .icon{width:18px;height:18px;object-fit:contain;display:inline-block;vertical-align:middle}
    .icon-lg{width:22px;height:22px}
    .icon-white{filter: invert(1) brightness(2)}

    /* Ripple */
    .ripple{position:absolute;border-radius:999px;transform:scale(0);animation:rip 600ms ease-out;pointer-events:none;background:rgba(0,0,0,0.08)}
    @keyframes rip{to{transform:scale(6);opacity:0}}

    /* Hero */
    .hero{display:grid;grid-template-columns:1fr 420px;gap:24px;padding:32px}
    .hero-card{background:var(--card);padding:22px;border-radius:16px;box-shadow:var(--shadow)}
    .promo{display:flex;gap:12px;align-items:center}
    .promo .badge{background:linear-gradient(90deg,#ff7a59,#ffb86b);color:#fff;padding:6px 10px;border-radius:10px;font-weight:800}

    /* Controls (filtres) */
    .controls{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:6px 0 12px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{padding:8px 12px;background:rgba(14,165,164,0.10);color:var(--accent);border:1px solid rgba(14,165,164,0.18);border-radius:999px;font-weight:700;cursor:pointer}
    .chip.active{background:linear-gradient(90deg,var(--accent),#06b6d4);color:#fff;border-color:transparent}
    .field{display:flex;gap:8px;align-items:center}
    .field input,.field select{padding:10px 12px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);background:transparent}
    .field input:focus,.field select:focus{outline:none; box-shadow:var(--ring)}

    /* Grid */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(230px,1fr));gap:18px;padding:20px}
    .product{background:var(--card);padding:12px;border-radius:14px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:12px;transition:transform .18s ease, box-shadow .18s ease}
    .product:hover{transform:translateY(-2px)}
    .product img{width:100%;height:170px;object-fit:contain;border-radius:10px;background:linear-gradient(180deg, rgba(0,0,0,0.03), rgba(0,0,0,0.01))}
    .meta{display:flex;justify-content:space-between;align-items:center}
    .title{font-weight:700}
    .price{font-size:1.06rem;font-weight:800}
    .old{color:var(--muted);text-decoration:line-through;font-size:0.9rem;margin-left:8px}
    .badges{display:flex;gap:6px;flex-wrap:wrap}
    .badge-small{background:rgba(14,165,164,0.12);color:var(--accent);padding:6px;border-radius:8px;font-weight:700;font-size:0.8rem}

    .cta{display:flex;gap:8px}
    .add{flex:1;padding:10px;border-radius:10px;background:linear-gradient(90deg,var(--accent),#06b6d4);color:white;border:0;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px}
    .info{padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:transparent;cursor:pointer}

    /* Mini cart */
    .minicart{position:fixed;right:18px;bottom:18px;background:var(--card);padding:12px;border-radius:14px;box-shadow:var(--shadow);width:360px;max-height:70vh;overflow:auto}
    .minicart h4{margin:0}
    .minicart .head{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .close-x{background:transparent;border:0;font-size:18px;cursor:pointer;border-radius:10px;width:32px;height:32px}
    .close-x:hover{background:rgba(0,0,0,0.06)}
    .cart-item{display:flex;gap:10px;align-items:center;padding:8px 0;border-bottom:1px dashed rgba(0,0,0,0.06)}
    .cart-item img{width:48px;height:48px;object-fit:contain}

    /* Cart FAB (bulle) */
    .fab{position:fixed;right:18px;bottom:18px;border:0;border-radius:999px;padding:14px 16px;background:linear-gradient(90deg,var(--accent),#06b6d4);color:#fff;box-shadow:var(--shadow);display:flex;align-items:center;gap:8px;cursor:pointer}
    .badge-dot{display:inline-flex;align-items:center;justify-content:center;min-width:22px;height:22px;border-radius:999px;background:#fff;color:#0f172a;font-weight:800;font-size:12px;padding:0 6px}

    /* Footer */
    footer{padding:18px 28px;color:var(--muted);font-size:0.95rem}

    /* Compteur rÃ©sultats */
    .count{font-size:0.95rem;color:var(--muted);margin:4px 20px}

    /* Modal (product quick view) */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:20px}
    .modal.open{display:flex}
    .modal-card{background:var(--card);max-width:920px;width:100%;border-radius:16px;box-shadow:var(--shadow);padding:16px}
    .modal-body{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .thumbs{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:8px}
    .thumbs img{width:100%;height:70px;object-fit:contain;border:1px solid rgba(0,0,0,.06);border-radius:8px;cursor:pointer}

    /* Skeleton */
    .skeleton{background:linear-gradient(90deg, rgba(0,0,0,0.06), rgba(0,0,0,0.02), rgba(0,0,0,0.06));background-size:200% 100%;animation:shimmer 1.2s infinite;}
    @keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}

    /* Responsive */
    @media (max-width:1024px){
      .hero{grid-template-columns:1fr;gap:16px;padding:20px}
      .minicart{width:92vw;right:4vw}
    }
    @media (max-width:600px){
      .topbar{padding:14px 16px}
      .search{margin:0 8px}
      .grid{gap:12px;padding:14px}
      .product img{height:150px}
      .btn{padding:10px 12px;border-radius:12px}
      .add{padding:12px}
      .fab{right:14px;bottom:14px}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">GF</div>
      <div>
        <div style="font-weight:800">GF Store</div>
        <div style="font-size:12px;color:var(--muted)">Ã‰lectronique premium â€” Livraison 24â€‘48h</div>
      </div>
    </div>

    <div class="search">
      <div class="searchbox">
        <span class="lens">ðŸ”Ž</span>
        <input id="searchInput" placeholder="Rechercher : iPhone, AirPods, PCâ€¦" />
        <div id="searchSuggest" class="suggest"></div>
      </div>
    </div>

    <div class="actions">
      <!-- ThÃ¨me retirÃ© (mode clair forcÃ©) -->
      <button class="btn icon-btn" id="accountBtn"><img class="icon" alt="compte" src="https://img.icons8.com/?size=100&id=n8DrUm77sR3l&format=png&color=000000"/> Compte</button>
      <button class="btn icon-btn" id="cartBtn"><img id="cartIcon" class="icon" alt="panier" src="https://img.icons8.com/?size=100&id=AaWM1DnCz2bQ&format=png&color=000000"/> Panier (<span id="cartCount">0</span>)</button>
    </div>
  </header>

  <main>
    <section class="hero">
      <div class="hero-card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:16px;flex-wrap:wrap">
          <div style="min-width:260px">
            <h1 style="margin:0;display:flex;align-items:center;gap:8px">GF Store â€” Boutique highâ€‘tech <img class="icon" alt="livraison" src="https://img.icons8.com/?size=100&id=plGFB4oatud2&format=png&color=000000"/></h1>
            <p style="margin:6px 0;color:var(--muted)">Produits premium. Assistance 24/7. Paiement sÃ©curisÃ©. Garantie 1 an min.</p>

            <div class="promo" style="margin-top:12px">
              <div class="badge">Offre flash -20%</div>
              <div id="flashTimer" style="font-weight:800;color:var(--danger)">Chargementâ€¦</div>
            </div>

            <div style="margin-top:14px">
              <button class="btn" id="openCatalog">Voir le catalogue</button>
              <button class="btn" id="openBundles">Bundles</button>
            </div>
          </div>

          <aside style="width:340px;min-width:260px">
            <div style="background:linear-gradient(180deg,#fff,#f1f7fb);padding:14px;border-radius:12px">
              <h3 style="margin:0;display:flex;align-items:center;gap:8px"><img class="icon" alt="livraison" src="https://img.icons8.com/?size=100&id=plGFB4oatud2&format=png&color=000000"/> Livraison rapide</h3>
              <p style="margin:6px 0;color:var(--muted)">24â€‘48h sur la majoritÃ© des produits.</p>
              <ul style="margin:0;padding-left:18px;color:var(--muted)">
                <li>Assistance 24/7</li>
                <li>Paiement 100% sÃ©curisÃ©</li>
                <li>Garantie lÃ©gale respectÃ©e</li>
              </ul>
            </div>
          </aside>
        </div>
      </div>

      <div class="hero-card">
        <h3>Top ventes</h3>
        <div id="topList" style="display:grid;gap:10px;margin-top:10px"></div>
      </div>
    </section>

    <section style="padding:12px 20px">
      <h2 style="margin:8px 0">Nos produits</h2>

      <!-- Barre de filtres -->
      <div class="controls">
        <div class="chips" id="catChips"></div>
        <div class="field"><label for="minPrice">Min</label><input id="minPrice" type="number" placeholder="0" min="0" style="width:110px"></div>
        <div class="field"><label for="maxPrice">Max</label><input id="maxPrice" type="number" placeholder="2000" min="0" style="width:110px"></div>
        <div class="field"><input id="inStock" type="checkbox" /><label for="inStock">En stock</label></div>
        <div class="field"><label for="sortSel">Tri</label>
          <select id="sortSel">
            <option value="reco">RecommandÃ©</option>
            <option value="price-asc">Prix â†‘</option>
            <option value="price-desc">Prix â†“</option>
            <option value="name">Nom Aâ†’Z</option>
          </select>
        </div>
        <button class="btn" id="clearFilters">RÃ©initialiser</button>
      </div>

      <div class="count" id="resultCount"></div>

      <div class="grid" id="productsGrid">
        <!-- skeletons -->
        <article class="product skeleton" style="height:270px"></article>
        <article class="product skeleton" style="height:270px"></article>
        <article class="product skeleton" style="height:270px"></article>
        <article class="product skeleton" style="height:270px"></article>
      </div>
      <div id="sourceNote" style="margin:10px 20px;color:var(--muted);font-size:12px"></div>
    </section>
  </main>

  <div id="minicart" class="minicart" hidden>
    <div class="head">
      <h4>Panier</h4>
      <button id="cartClose" class="close-x" title="Fermer">âœ•</button>
    </div>
    <div id="cartItems"></div>
    <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
      <div><strong>Total:</strong> <span id="cartTotal">0 â‚¬</span></div>
      <div>
        <button class="btn icon-btn" id="goCheckout"><img class="icon" alt="checkout" src="https://img.icons8.com/?size=100&id=qVsd2YOgeizO&format=png&color=000000"/> Commander</button>
      </div>
    </div>
  </div>

  <!-- Cart bubble -->
  <button id="cartFab" class="fab" aria-label="Panier" hidden>
    <img id="fabIcon" class="icon icon-white" alt="panier" src="https://img.icons8.com/?size=100&id=AaWM1DnCz2bQ&format=png&color=000000"/>
    <span id="fabCount" class="badge-dot">0</span>
  </button>

  <!-- Quick view modal -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px">
        <h3 id="modalTitle" style="margin:0"></h3>
        <button class="btn" id="modalClose">Fermer</button>
      </div>
      <div class="modal-body">
        <div>
          <img id="modalImage" src="" alt="" style="width:100%;height:300px;object-fit:contain;border-radius:10px" />
          <div id="modalThumbs" class="thumbs"></div>
        </div>
        <div>
          <div id="modalPrice" class="price"></div>
          <p id="modalDesc" style="color:var(--muted)"></p>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="add" id="modalAdd"><img class="icon icon-white" alt="acheter" src="https://img.icons8.com/?size=100&id=ditUhfRlUOQg&format=png&color=000000"/> Ajouter au panier</button>
            <button class="info" id="modalInfo">DÃ©tails</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    Â© GF Store â€” Tous droits rÃ©servÃ©s â€¢ Paiement sÃ©curisÃ© â€¢ Assistance 24/7
  </footer>

  <script>
    /*********************** Configuration ************************/
    // IMPORTANT : loader robuste â€” INTACT pour prÃ©server le systÃ¨me produits
    const CANDIDATES = [
      './produits.json', './products.json', './products.cleaned.json',
      './data/produits.json', './data/products.json', './data/products.cleaned.json',
      '/GFSTORE/produits.json', '/GFSTORE/data/produits.json', '/GFSTORE/data/products.json'
    ];

    const FLASH_HOURS = 24;

    // IcÃ´nes
    const ICONS = {
      buy: 'https://img.icons8.com/?size=100&id=ditUhfRlUOQg&format=png&color=000000',
      cart: 'https://img.icons8.com/?size=100&id=AaWM1DnCz2bQ&format=png&color=000000',
      cartFull: 'https://img.icons8.com/?size=100&id=K5Jv3BfpxPYa&format=png&color=000000',
      checkout: 'https://img.icons8.com/?size=100&id=qVsd2YOgeizO&format=png&color=000000',
      truck: 'https://img.icons8.com/?size=100&id=plGFB4oatud2&format=png&color=000000',
      logout: 'https://img.icons8.com/?size=100&id=IKneRwT2PRjz&format=png&color=000000',
      user: 'https://img.icons8.com/?size=100&id=n8DrUm77sR3l&format=png&color=000000'
    };

    /*********************** Utilitaires **************************/
    const $ = sel => document.querySelector(sel);
    const $all = sel => Array.from(document.querySelectorAll(sel));
    const fmt = val => (typeof val === 'number' ? val.toFixed(2).replace('.',',') + ' â‚¬' : (val||''));

    const PLACEHOLDER = 'https://via.placeholder.com/600x400?text=GF+Store';
    const firstImage = (p) => p?.imageCover || (Array.isArray(p?.images) && p.images[0]) || p?.image || PLACEHOLDER;

    function safeImg(img){
      img.loading = 'lazy';
      img.decoding = 'async';
      img.referrerPolicy = 'no-referrer';
      img.onerror = () => { img.onerror = null; img.src = PLACEHOLDER; };
    }

    // Normalisation simple pour recherche sans accents
    const normalize = (s='') => s.toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();

    // Debounce
    const debounce = (fn, d=220)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), d); } };

    // Ripple helper
    function addRipple(e){
      const btn = e.currentTarget; const rect = btn.getBoundingClientRect();
      const span = document.createElement('span'); span.className='ripple';
      const size = Math.max(rect.width, rect.height); span.style.width = span.style.height = size+'px';
      span.style.left = (e.clientX - rect.left - size/2)+'px'; span.style.top = (e.clientY - rect.top - size/2)+'px';
      btn.appendChild(span); setTimeout(()=> span.remove(), 600);
    }

    /*********************** Panier ********************************/
    const CART_KEY = 'gf_cart_v1';
    const loadCart = ()=>{ try{ return JSON.parse(localStorage.getItem(CART_KEY) || '[]') }catch(e){return []} };
    const saveCart = (c)=>{ localStorage.setItem(CART_KEY, JSON.stringify(c)); renderCartCount(); };
    function addToCart(id, p){ const cart = loadCart(); const it = cart.find(i=>i.id===id); if(it){ it.qty++; } else { cart.push({id, title:p.name, price:p.price, image:firstImage(p), qty:1}); } saveCart(cart); openMiniCart(); }
    function renderCartCount(){ const cart = loadCart(); const total = cart.reduce((s,i)=>s+i.qty,0); $('#cartCount').textContent = total; $('#fabCount').textContent = total; const has = total>0; $('#cartFab').hidden = !has; $('#fabIcon').src = has ? ICONS.cartFull : ICONS.cart; $('#cartIcon').src = has ? ICONS.cartFull : ICONS.cart; }
    function renderMiniCart(){ const items = loadCart(); const ctn = $('#cartItems'); ctn.innerHTML=''; if(items.length===0){ ctn.innerHTML='<div style="color:var(--muted)">Votre panier est vide.</div>'; $('#cartTotal').textContent = '0 â‚¬'; return; }
      let total = 0; items.forEach(it=>{ total += it.price * it.qty; const d = document.createElement('div'); d.className='cart-item'; d.innerHTML = `
        <img src="${it.image}" alt="" />
        <div style="flex:1"><div style="font-weight:700">${it.title}</div><div style="font-size:.9rem;color:var(--muted)">${it.qty} x ${fmt(it.price)}</div></div>
        <div style="display:flex;flex-direction:column;gap:6px"><button class="info" onclick="window.__gf_changeQty('${it.id}',1)">+</button><button class="info" onclick="window.__gf_changeQty('${it.id}',-1)">-</button></div>`; ctn.appendChild(d); });
      $('#cartTotal').textContent = fmt(total);
    }
    window.__gf_changeQty = (id,delta)=>{ const cart = loadCart(); const i = cart.findIndex(x=>x.id===id); if(i===-1) return; cart[i].qty += delta; if(cart[i].qty<=0) cart.splice(i,1); saveCart(cart); renderMiniCart(); };
    function openMiniCart(){ $('#minicart').hidden=false; renderMiniCart(); $('#cartFab').hidden = true; }
    function closeMiniCart(){ $('#minicart').hidden=true; const has = (loadCart().reduce((s,i)=>s+i.qty,0))>0; $('#cartFab').hidden = !has; }
    $('#cartBtn').addEventListener('click', openMiniCart);
    $('#cartClose').addEventListener('click', closeMiniCart);
    $('#cartFab').addEventListener('click', openMiniCart);
    $('#goCheckout').addEventListener('click', ()=>alert('Page checkout non implÃ©mentÃ©e dans ce fichier.'));
    renderCartCount();

    // RÃ©duire le panier au dÃ©filement
    let lastScrollY = window.scrollY;
    window.addEventListener('scroll', ()=>{
      if(!$('#minicart').hidden){ const dy = Math.abs(window.scrollY - lastScrollY); if(dy>8){ closeMiniCart(); } }
      lastScrollY = window.scrollY;
    }, {passive:true});

    /*********************** Produits ******************************/
    let PRODUCTS = [];

    async function tryFetch(url){
      try{
        const r = await fetch(url, {cache:'no-store'});
        if(!r.ok) throw new Error('HTTP '+r.status);
        const data = await r.json();
        if(Array.isArray(data)) return data; if(Array.isArray(data.products)) return data.products; return null;
      }catch(e){ return null }
    }

    async function loadProducts(){
      let used = null; let data = null;
      for(const u of CANDIDATES){ data = await tryFetch(u); if(data){ used = u; break; } }
      if(!data){
        console.warn('Aucun produits.json trouvÃ© â€” fallback dÃ©mo.');
        PRODUCTS = [
          {id:'demo-1', name:'AirPods (dÃ©mo)', category:'Audio', price:199, stock:8, images:[PLACEHOLDER]},
          {id:'demo-2', name:'iPhone (dÃ©mo)', category:'Smartphones', price:999, oldPrice:1099, stock:2, images:[PLACEHOLDER]},
          {id:'demo-3', name:'MacBook (dÃ©mo)', category:'Informatique', price:2499, stock:4, images:[PLACEHOLDER]},
        ];
        $('#sourceNote').textContent = 'âš ï¸ Placez "produits.json" prÃ¨s de index.html (ou dans ./data).';
        return;
      }
      PRODUCTS = data.map((p,idx)=>({
        // Normalisation minimale sans dÃ©naturer les donnÃ©es dâ€™origine
        id: p.id || p.slug || 'p-'+idx,
        name: p.name || p.title || 'Produit',
        price: p.price ?? p.prix ?? 0,
        oldPrice: p.oldPrice || p.compareAtPrice || null,
        category: p.category || p.categorie || '',
        imageCover: p.imageCover || undefined,
        images: Array.isArray(p.images) ? p.images : (p.image ? [p.image] : []),
        description: p.description || '' ,
        rating: p.rating || p.note || null,
        stock: p.stock ?? p.quantity ?? null,
        _raw:p
      }));
      $('#sourceNote').textContent = 'ChargÃ© depuis : ' + used + ' â€” Images: imageCover ou premiÃ¨re image disponible.';
    }

    function productCard(p){
      const el = document.createElement('article'); el.className='product';
      const imgSrc = firstImage(p);
      el.innerHTML = `
        <img src="${imgSrc}" alt="${p.name}" />
        <div class="meta"><div class="title">${p.name}</div><div class="price">${fmt(p.price)}${p.oldPrice?'<span class="old">'+fmt(p.oldPrice)+'</span>':''}</div></div>
        <div style="color:var(--muted);font-size:.9rem">${p.category||''}</div>
        <div class="badges">${ p.stock!=null && p.stock<=5 ? '<div class="badge-small">Stock: '+p.stock+'</div>' : '' }</div>
        <div class="cta" style="margin-top:auto">
          <button class="info" data-view>Voir</button>
          <button class="add" data-add><img class="icon icon-white" alt="acheter" src="${ICONS.buy}"/> Ajouter</button>
        </div>`;
      const img = el.querySelector('img'); safeImg(img);
      el.querySelector('[data-add]').addEventListener('click', ()=> addToCart(p.id, p));
      el.querySelector('[data-view]').addEventListener('click', ()=> openQuickView(p));
      return el;
    }

    function renderProducts(list){ const grid = $('#productsGrid'); grid.innerHTML=''; list.forEach(p=> grid.appendChild(productCard(p))); }

    function renderTop(){ const top = PRODUCTS.slice(0,4); const container = $('#topList'); container.innerHTML=''; top.forEach(t=>{
      const wrap = document.createElement('div'); wrap.style.display='flex'; wrap.style.alignItems='center'; wrap.style.gap='10px'; wrap.style.cursor='pointer'; wrap.setAttribute('role','button'); wrap.setAttribute('tabindex','0');
      const img = document.createElement('img'); img.src = firstImage(t); img.style.width='64px'; img.style.height='64px'; img.style.objectFit='contain'; img.style.borderRadius='8px'; safeImg(img);
      wrap.appendChild(img); const meta = document.createElement('div'); meta.innerHTML = `<div style="font-weight:800">${t.name}</div><div style="color:var(--muted)">${fmt(t.price)}</div>`; wrap.appendChild(meta); container.appendChild(wrap);
      wrap.addEventListener('click', ()=> openQuickView(t));
      wrap.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); openQuickView(t);} });
    }); }

    // --- Recherche amÃ©liorÃ©e (dynamique + suggestions) ---
    const state = { q:'', category:null, minPrice:null, maxPrice:null, inStock:false, sort:'reco' };

    function applyFilters(){
      let list = PRODUCTS.slice();
      // recherche texte
      const nq = normalize(state.q);
      if(nq){
        const tokens = nq.split(/\s+/).filter(Boolean);
        list = list.filter(p=>{
          const hay = normalize((p.name||'') + ' ' + (p.category||'') + ' ' + (p.description||''));
          return tokens.every(t=> hay.includes(t));
        });
      }
      // catÃ©gorie
      if(state.category){ list = list.filter(p=> (p.category||'') === state.category); }
      // prix
      if(state.minPrice!=null && state.minPrice!==''){ list = list.filter(p=> Number(p.price||0) >= Number(state.minPrice)); }
      if(state.maxPrice!=null && state.maxPrice!==''){ list = list.filter(p=> Number(p.price||0) <= Number(state.maxPrice)); }
      // stock
      if(state.inStock){ list = list.filter(p=> (p.stock==null) ? true : p.stock>0 ); }
      // tri
      if(state.sort==='price-asc'){ list.sort((a,b)=> (a.price||0)-(b.price||0)); }
      else if(state.sort==='price-desc'){ list.sort((a,b)=> (b.price||0)-(a.price||0)); }
      else if(state.sort==='name'){ list.sort((a,b)=> (a.name||'').localeCompare(b.name||'')); }

      renderProducts(list);
      // mise Ã  jour du compteur
      $('#resultCount').textContent = list.length + ' produit' + (list.length>1?'s':'');
      // surlignage lÃ©ger des correspondances
      if(nq){ highlightTitles(tokens=list.map(()=>null) && nq.split(/\s+/).filter(Boolean)); }
      attachRipples();
    }

    function highlightTitles(tokens){
      const titles = $all('.product .title');
      const rx = new RegExp('(' + tokens.map(t=> t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')).join('|') + ')','gi');
      titles.forEach(t=>{ t.innerHTML = t.textContent.replace(rx,'<mark>$1</mark>'); });
    }

    function buildCategories(){
      const cats = Array.from(new Set(PRODUCTS.map(p=> p.category).filter(Boolean))).sort();
      const ctn = $('#catChips'); ctn.innerHTML='';
      const mk = (label,val)=>{ const b = document.createElement('button'); b.className='chip'; b.textContent = label; b.addEventListener('click',()=>{ $all('.chip').forEach(x=>x.classList.remove('active')); if(state.category===val){ state.category=null; } else { state.category=val; b.classList.add('active'); } applyFilters(); }); return b; };
      if(cats.length){ ctn.appendChild(mk('Toutes', null)); }
      cats.forEach(c=> ctn.appendChild(mk(c,c)));
    }

    function bindControls(){
      const onSearch = debounce((e)=>{ state.q = e.target.value; buildSuggestions(state.q); applyFilters(); }, 200);
      $('#searchInput').addEventListener('input', onSearch);

      $('#minPrice').addEventListener('input', (e)=>{ state.minPrice = e.target.value; applyFilters(); });
      $('#maxPrice').addEventListener('input', (e)=>{ state.maxPrice = e.target.value; applyFilters(); });
      $('#inStock').addEventListener('change', (e)=>{ state.inStock = e.target.checked; applyFilters(); });
      $('#sortSel').addEventListener('change', (e)=>{ state.sort = e.target.value; applyFilters(); });
      $('#clearFilters').addEventListener('click', ()=>{ state.q=''; state.category=null; state.minPrice=''; state.maxPrice=''; state.inStock=false; state.sort='reco';
        $('#searchInput').value=''; $('#minPrice').value=''; $('#maxPrice').value=''; $('#inStock').checked=false; $('#sortSel').value='reco'; $all('.chip').forEach(x=>x.classList.remove('active')); applyFilters(); });

      // suggestions masquage
      document.addEventListener('click', (e)=>{ if(!$('.searchbox').contains(e.target)) $('#searchSuggest').classList.remove('open'); });
    }

    function buildSuggestions(q){
      const box = $('#searchSuggest');
      const nq = normalize(q);
      if(!nq){ box.classList.remove('open'); box.innerHTML=''; return; }
      const res = PRODUCTS.filter(p=> normalize(p.name||'').includes(nq) || normalize(p.category||'').includes(nq)).slice(0,6);
      if(!res.length){ box.classList.remove('open'); box.innerHTML=''; return; }
      box.innerHTML='';
      res.forEach(p=>{
        const row = document.createElement('div'); row.className='suggest-item';
        row.innerHTML = `<img src="${firstImage(p)}" alt=""><div><div style="font-weight:700">${p.name}</div><div style="font-size:12px;color:var(--muted)">${p.category||''} â€¢ ${fmt(p.price)}</div></div>`;
        row.addEventListener('click', ()=>{ $('#searchInput').value = p.name; state.q = p.name; applyFilters(); $('#searchSuggest').classList.remove('open'); openQuickView(p); });
        box.appendChild(row);
      });
      box.classList.add('open');
    }

    /*********************** Quick View ***************************/
    function openQuickView(p){
      $('#modalTitle').textContent = p.name;
      $('#modalDesc').textContent = p.description || '';
      $('#modalPrice').textContent = fmt(p.price) + (p.oldPrice? ' ' + '('+fmt(p.oldPrice)+')':'' );
      const main = $('#modalImage'); main.src = firstImage(p); safeImg(main);
      const thumbs = $('#modalThumbs'); thumbs.innerHTML=''; (p.images||[]).forEach(u=>{ const im = document.createElement('img'); im.src = u; safeImg(im); im.addEventListener('click', ()=>{ main.src = u; }); thumbs.appendChild(im); });
      $('#modalAdd').onclick = ()=> addToCart(p.id, p);
      $('#modalInfo').onclick = ()=> alert(p.name + "\n\n" + (p.description||'Aucune description disponible.'));
      $('#modal').classList.add('open'); $('#modal').setAttribute('aria-hidden','false');
    }
    $('#modalClose').addEventListener('click', ()=>{ $('#modal').classList.remove('open'); $('#modal').setAttribute('aria-hidden','true'); });
    $('#modal').addEventListener('click', (e)=>{ if(e.target.id==='modal') $('#modalClose').click(); });

    /*********************** Flash timer **************************/
    function initFlash(){
      const key = 'gf_flash_end'; let end = localStorage.getItem(key);
      if(!end){ end = Date.now() + FLASH_HOURS*3600*1000; localStorage.setItem(key, end); }
      function tick(){ const remaining = parseInt(end) - Date.now(); if(remaining<=0){ $('#flashTimer').textContent = 'Offre terminÃ©e'; return; } const h = Math.floor(remaining/3600000); const m = Math.floor((remaining%3600000)/60000); const s = Math.floor((remaining%60000)/1000); $('#flashTimer').textContent = `-${20}% â€¢ ${h}h ${m}m ${s}s`; }
      tick(); setInterval(tick,1000);
    }

    /*********************** Divers UI ****************************/
    function attachRipples(){ $all('.btn, .add, .info, .chip, .fab').forEach(b=>{ b.removeEventListener('click', addRipple); b.addEventListener('click', addRipple); }); }
    $('#accountBtn').addEventListener('click', ()=> alert('Espace compte â€” bientÃ´t disponible.\nDÃ©connexion ' + ICONS.logout));

    /*********************** Boot ********************************/
    (async function(){
      await loadProducts();
      renderProducts(PRODUCTS);
      renderTop();
      buildCategories();
      bindControls();
      applyFilters();
      initFlash();
      attachRipples();
      // scroll to grid
      document.getElementById('openCatalog').addEventListener('click', ()=> document.getElementById('productsGrid').scrollIntoView({behavior:'smooth'}));
      document.getElementById('openBundles').addEventListener('click', ()=> document.getElementById('productsGrid').scrollIntoView({behavior:'smooth'}));
    })();
  </script>
</body>
</html>
