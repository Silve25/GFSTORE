<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mon compte â€” GF Store</title>
  <meta name="description" content="Tableau de bord de votre compte GF Store : profil, commandes, adresses.">
  <style>
    :root{--w:1200px;--c:#0f172a;--a:#2563eb;--bg:#f5f7fb;--r:16px}
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;color:var(--c);background:var(--bg)}
    a{color:inherit}
    /* Header */
    header{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid #e5e7eb;backdrop-filter:saturate(140%) blur(4px)}
    .hwrap{max-width:var(--w);margin:auto;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;text-decoration:none}
    .brand .logo{height:40px;width:auto;display:block}
    .nav{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .nav a,.iconbtn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid #e5e7eb;background:#fff;border-radius:12px;text-decoration:none;box-shadow:0 1px 0 rgba(0,0,0,.02)}
    .nav a:hover,.iconbtn:hover{box-shadow:0 2px 10px rgba(0,0,0,.06)}
    .iconbtn{cursor:pointer}
    .ic{width:16px;height:16px;display:inline-block}
    .dropdown{position:relative}
    .menu{position:absolute;right:0;top:calc(100% + 8px);background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:6px;min-width:220px;box-shadow:0 10px 24px rgba(0,0,0,.12);display:none;z-index:60}
    .menu.show{display:block}
    .menu a{display:block;padding:8px 10px;border-radius:8px;text-decoration:none}
    .menu a:hover{background:#f3f4f6}
    /* Bandeau promo */
    .banner{background:linear-gradient(90deg,#1e3a8a,#2563eb,#0ea5e9);color:#fff;text-align:center;padding:10px 14px}
    .banner .timer{font-weight:700;border-radius:999px;padding:2px 8px;background:rgba(255,255,255,.15);display:inline-block}
    .banner .sep{opacity:.6;padding:0 6px}
    /* Layout */
    .wrap{max-width:var(--w);margin:12px auto 28px;padding:0 12px;display:grid;gap:14px;grid-template-columns:1.1fr 1fr}
    @media (max-width:900px){ .wrap{grid-template-columns:1fr} }
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:12px;box-shadow:0 1px 0 rgba(0,0,0,.02)}
    .hdr{display:flex;gap:12px;align-items:center;margin-bottom:10px}
    .avatar{width:56px;height:56px;border-radius:999px;display:grid;place-items:center;font-weight:800;background:#eff6ff;border:1px solid #dbeafe;color:#1d4ed8}
    h1{font-size:18px;margin:0}
    .muted{opacity:.75;font-size:12px}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;cursor:pointer;text-decoration:none}
    .btn.primary{border-color:#1e40af;background:linear-gradient(180deg,#2563eb,#1e40af);color:#fff;box-shadow:0 6px 14px rgba(30,64,175,.25)}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width:640px){ .kpis{grid-template-columns:1fr 1fr} }
    .kpi{background:linear-gradient(180deg,#ffffff,#f8fbff);border:1px solid #e5e7eb;border-radius:12px;padding:10px}
    .kpi .n{font-weight:800;font-size:18px}
    .list{display:grid;gap:10px}
    .order{border:1px solid #e5e7eb;border-radius:12px;padding:10px;display:grid;gap:6px}
    .order .top{display:flex;gap:8px;align-items:center;font-size:13px}
    .pill{display:inline-grid;place-items:center;border:1px solid #e5e7eb;padding:2px 8px;border-radius:999px;font-size:12px;background:#fff}
    .addr{border:1px dashed #e5e7eb;border-radius:12px;padding:10px;background:#fcfcfe}
    .empty{opacity:.7}
    .hint{font-size:12px;opacity:.8;margin-top:6px}
    footer{background:#fff;border-top:1px solid #e5e7eb}
    .fwrap{max-width:var(--w);margin:0 auto;padding:16px 12px;display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center;font-size:12px}
    .fwrap a{text-decoration:none;color:inherit;opacity:.9}
    .fwrap a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="banner">ðŸŽ‰ Offres du moment : <b>-25% Ã  -30%</b> sur PC, tÃ©lÃ©phones et consoles <span class="sep">â€¢</span> <span id="countdown" class="timer" aria-live="polite"></span></div>

  <header>
    <div class="hwrap">
      <a id="homeLink" class="brand" aria-label="Accueil">
        <img src="../assets/img/logopnggfstore.png" class="logo" alt="GF Store" width="180" height="52" decoding="async">
      </a>
      <nav class="nav" aria-label="Navigation">
        <a id="accountLink"><img class="ic" id="icAccount" alt=""> Mon compte</a>
        <a id="cartBtn" class="iconbtn">Panier</a>
        <div class="dropdown">
          <button class="iconbtn" id="menuBtn" aria-label="Menu"><img class="ic" id="icMenu" alt=""></button>
          <div id="menuDrop" class="menu">
            <a id="aboutLink">Ã€ propos</a>
            <a id="cgvLink">CGV</a>
            <a id="legalLink">Mentions lÃ©gales</a>
            <a id="privacyLink">ConfidentialitÃ©</a>
            <a id="contactLink">Contact</a>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <main class="wrap" aria-live="polite">
    <!-- Colonne principale -->
    <section class="card">
      <div class="hdr">
        <div class="avatar" id="avatar">?</div>
        <div>
          <h1>Bonjour <span id="userName">â€”</span></h1>
          <div class="muted" id="userEmail">â€”</div>
          <div class="muted" id="lastLogin" style="margin-top:2px"></div>
        </div>
      </div>

      <div class="row" style="gap:8px;margin-bottom:10px">
        <a id="btnProfile" class="btn"><img class="ic" id="icProfile" alt=""> Modifier mon profil</a>
        <a id="btnPwd" class="btn"><img class="ic" id="icKey" alt=""> Changer mon mot de passe</a>
        <button id="logoutBtn" class="btn"><img class="ic" id="icLogout" alt=""> Se dÃ©connecter</button>
      </div>

      <div class="kpis" id="kpis">
        <div class="kpi"><div class="n" id="kpiOrders">0</div><div class="muted">Commandes</div></div>
        <div class="kpi"><div class="n" id="kpiAddresses">0</div><div class="muted">Adresses</div></div>
        <div class="kpi"><div class="n" id="kpiCart">0</div><div class="muted">Articles panier</div></div>
      </div>
    </section>

    <!-- Colonne latÃ©rale -->
    <aside class="list">
      <section class="card">
        <div class="hdr"><img class="ic" id="icBox" alt=""><strong>Mes derniÃ¨res commandes</strong></div>
        <div id="ordersWrap" class="list empty">Aucune commande pour le moment.</div>
      </section>

      <section class="card">
        <div class="hdr"><img class="ic" id="icHome" alt=""><strong>Mon adresse principale</strong></div>
        <div id="addrBox" class="addr empty">Aucune adresse enregistrÃ©e.</div>
        <div class="row" style="margin-top:8px">
          <a id="btnEditAddress" class="btn"><img class="ic" id="icEdit" alt=""> Ajouter / Modifier</a>
        </div>
      </section>
    </aside>
  </main>

  <footer>
    <div class="fwrap">
      <div>Â© GF Store 2025 â€” SimplicitÃ©, sÃ©curitÃ©, crypto-friendly.</div>
      <nav>
        <a id="aboutLink2">Ã€ propos</a> Â· 
        <a id="cgvLink2">CGV</a> Â· 
        <a id="legalLink2">Mentions lÃ©gales</a> Â· 
        <a id="privacyLink2">ConfidentialitÃ©</a> Â· 
        <a id="contactLink2">Contact</a>
      </nav>
    </div>
  </footer>

  <!-- Backend/API & session helpers -->
  <script src="js/auth.js" defer></script>

  <script>
  // Tableau de bord "Mon compte"
  (function(){
    "use strict";
    const $=(s,root)=> (root||document).querySelector(s);

    // GH_ROOT (GitHub Pages friendly)
    const GH_ROOT = (()=>{ 
      const parts = location.pathname.split('/').filter(Boolean);
      return (location.host.endsWith('github.io') && parts.length) ? `/${parts[0]}/` : '/';
    })();

    // IcÃ´nes (petites, sobres)
    const ICONS = {
      account:'https://img.icons8.com/?size=100&id=60655&format=png&color=000000',
      menu:'https://img.icons8.com/?size=100&id=RzDomvpIKGI9&format=png&color=000000',
      profile:'https://img.icons8.com/?size=100&id=7820&format=png&color=000000',
      key:'https://img.icons8.com/?size=100&id=107272&format=png&color=000000',
      logout:'https://img.icons8.com/?size=100&id=IKneRwT2PRjz&format=png&color=000000',
      box:'https://img.icons8.com/?size=100&id=59812&format=png&color=000000',
      home:'https://img.icons8.com/?size=100&id=98956&format=png&color=000000',
      edit:'https://img.icons8.com/?size=100&id=67884&format=png&color=000000'
    };
    const setSrc=(id,src)=>{ const el=document.getElementById(id); if(el) el.src=src; };
    function setIcons(){
      setSrc('icAccount', ICONS.account);
      setSrc('icMenu', ICONS.menu);
      setSrc('icProfile', ICONS.profile);
      setSrc('icKey', ICONS.key);
      setSrc('icLogout', ICONS.logout);
      setSrc('icBox', ICONS.box);
      setSrc('icHome', ICONS.home);
      setSrc('icEdit', ICONS.edit);
    }

    // Liens
    function link(id,path){ const el=document.getElementById(id); if(el) el.href = GH_ROOT + path; }
    function wireLinks(){
      document.getElementById('homeLink').href = GH_ROOT;
      link('accountLink','compte/index.html');
      link('cartBtn','checkout.html');
      const pages = {about:'a-propos', cgv:'cgv', legal:'mentions-legales', privacy:'confidentialite', contact:'contact'};
      Object.entries(pages).forEach(([k,slug])=>{
        link(k+'Link','pages/'+slug+'.html');
        link(k+'Link2','pages/'+slug+'.html');
      });
    }

    // Menu
    function wireMenu(){
      const btn=$('#menuBtn'), drop=$('#menuDrop');
      if(!btn||!drop) return;
      btn.addEventListener('click',e=>{e.stopPropagation();drop.classList.toggle('show')});
      document.addEventListener('click',e=>{ if(!drop.contains(e.target) && e.target!==btn) drop.classList.remove('show'); });
    }

    // Countdown (48h)
    function wireCountdown(){
      const el=$('#countdown'); if(!el) return;
      const END=new Date(Date.now()+48*60*60*1000); const two=n=>String(n).padStart(2,'0');
      function tick(){
        const now=new Date(); let diff=END-now;
        if(diff<=0){ el.textContent='DerniÃ¨res heures !'; return; }
        const d=Math.floor(diff/86400000); diff%=86400000;
        const h=Math.floor(diff/3600000); diff%=3600000;
        const m=Math.floor(diff/60000); const s=Math.floor((diff%60000)/1000);
        el.textContent=`${d?d+'j ':''}${two(h)}:${two(m)}:${two(s)} restants`;
      }
      tick(); setInterval(tick,1000);
    }

    // Helpers stockage local
    const KEY_CART='gf_cart';
    const KEY_ORDERS='gf_orders';
    const getCart=()=>{ try{return JSON.parse(localStorage.getItem(KEY_CART)||'[]')}catch{return[]} };
    const cartCount=()=>getCart().reduce((s,x)=>s+Number(x.qty||0),0);
    const getOrders=()=>{ try{return JSON.parse(localStorage.getItem(KEY_ORDERS)||'[]')}catch{return[]} };

    // SÃ©curitÃ© / session (via auth.js)
    async function ensureSession(){
      const s = (window.GFAuth && window.GFAuth.getSession) ? window.GFAuth.getSession() : null;
      if(!s || !s.email){
        location.replace(GH_ROOT+'compte/login.html?next='+encodeURIComponent(location.href));
        return null;
      }
      return s;
    }

    // Rendu dashboard
    function fillIdentity(sess, userObj){
      const name = (userObj?.name || sess.name || sess.email?.split('@')[0] || 'Client').trim();
      const email = userObj?.email || sess.email || '';
      const who = document.getElementById('userName');
      const mail= document.getElementById('userEmail');
      const last= document.getElementById('lastLogin');
      const avatar=document.getElementById('avatar');

      if(who) who.textContent = name;
      if(mail) mail.textContent = email;
      if(avatar) avatar.textContent = (name[0]||'?').toUpperCase();
      if(last && sess.loggedAt){
        const d=new Date(sess.loggedAt); if(!isNaN(+d)) last.textContent = 'DerniÃ¨re connexion : ' + d.toLocaleString('fr-FR');
      }
    }

    function fillKPIs(sess, userObj){
      // Commandes (local si prÃ©sentes)
      const allOrders = getOrders();
      const myOrders = allOrders.filter(o => {
        const uid = String(o.userId||'').toLowerCase();
        return uid === String(sess.email||'').toLowerCase() || uid === String(sess.id||'').toLowerCase();
      });
      document.getElementById('kpiOrders').textContent = myOrders.length;
      // Adresses
      const hasAddress = !!(userObj && (userObj.address || userObj.city || userObj.zip || userObj.country));
      document.getElementById('kpiAddresses').textContent = hasAddress ? '1' : '0';
      // Panier
      document.getElementById('kpiCart').textContent = String(cartCount());
    }

    function renderOrders(sess){
      const wrap=document.getElementById('ordersWrap');
      const EUR=v=>Number(v||0).toLocaleString('fr-FR',{style:'currency',currency:'EUR'});
      const all = getOrders();
      const mine = all.filter(o => {
        const uid = String(o.userId||'').toLowerCase();
        return uid === String(sess.email||'').toLowerCase() || uid === String(sess.id||'').toLowerCase();
      });

      if(!mine.length){ wrap.classList.add('empty'); wrap.textContent='Aucune commande pour le moment.'; return; }
      wrap.classList.remove('empty');

      wrap.innerHTML = mine.slice(-5).reverse().map(o=>{
        const total = (o.items||[]).reduce((s,x)=>s + Number(x.price||0)*Number(x.qty||1),0);
        const itemsTxt = (o.items||[]).map(x=>`${x.qty}Ã— ${x.name}`).join(' â€¢ ');
        return `
          <div class="order">
            <div class="top">
              <strong>Commande #${o.id||'â€”'}</strong>
              <span class="pill">${new Date(o.date||Date.now()).toLocaleString('fr-FR')}</span>
              <span class="pill">${o.status||'PayÃ©e'}</span>
              <span style="margin-left:auto;font-weight:700">${EUR(total)}</span>
            </div>
            <div class="muted">${itemsTxt || 'â€”'}</div>
            <div class="row">
              <a class="btn" href="${GH_ROOT}orders.html">Voir</a>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderAddress(userObj, fallbackName){
      const box=document.getElementById('addrBox');
      if(userObj && (userObj.address || userObj.city || userObj.zip || userObj.country)){
        box.classList.remove('empty');
        const name = userObj.name || fallbackName || '';
        const line = [userObj.address, userObj.zip, userObj.city].filter(Boolean).join(', ');
        box.innerHTML = `
          <div><strong>${name}</strong></div>
          <div>${line}</div>
          <div>${userObj.country||''}</div>
          ${userObj.phone ? `<div class="muted" style="margin-top:6px">â˜Ž ${userObj.phone}</div>` : '' }
        `;
      } else {
        box.classList.add('empty');
        box.textContent = 'Aucune adresse enregistrÃ©e.';
      }
    }

    // Actions boutons
    function wireActions(){
      const go=(p)=> location.href = GH_ROOT + p;
      const btnEdit=document.getElementById('btnEditAddress');
      if(btnEdit) btnEdit.addEventListener('click',()=> go('compte/profile.html#adresse'));
      const btnPwd=document.getElementById('btnPwd');
      if(btnPwd) btnPwd.addEventListener('click',()=> go('compte/password-change.html'));
      const btnProf=document.getElementById('btnProfile');
      if(btnProf) btnProf.addEventListener('click',()=> go('compte/profile.html'));
      const btnCart=document.getElementById('cartBtn');
      if(btnCart) btnCart.addEventListener('click',(e)=>{ e.preventDefault(); go('checkout.html'); });
      const btnLogout=document.getElementById('logoutBtn');
      if(btnLogout) btnLogout.addEventListener('click',(e)=>{ e.preventDefault(); if(window.GFAuth){ GFAuth.clearSession(); } location.replace(GH_ROOT+'compte/login.html'); });
    }

    async function init(){
      wireLinks(); wireMenu(); wireCountdown(); setIcons();

      // Session requise
      const sess = await ensureSession(); if(!sess) return;

      // RÃ©cupÃ©rer l'utilisateur depuis l'API pour infos fraÃ®ches
      let me = null;
      try{
        if(window.GFAuth && GFAuth.api){
          const list = await GFAuth.api.listUsers();
          if(Array.isArray(list)){
            me = list.find(u => (u.email||'').toLowerCase() === String(sess.email||'').toLowerCase()) || null;
          }
        }
      }catch{/* silencieux */}

      // UI
      fillIdentity(sess, me);
      fillKPIs(sess, me);
      renderOrders(sess);
      renderAddress(me, (sess.name||''));

      // Actions
      wireActions();
    }

    document.addEventListener('DOMContentLoaded', init);
  })();
  </script>
</body>
</html>
