<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Finaliser ma commande — GF Store</title>
  <meta name="description" content="Page de paiement GF Store : Crypto & Virement priorisés, Carte & PayPal en maintenance. Récapitulatif clair, économies affichées, responsive.">
  <style>
    :root{
      --bg:#f6f8fb; --panel:#fff; --text:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --brand:#2563eb; --accent:#1e40af; --ok:#059669; --warn:#a16207; --danger:#dc2626;
      --radius:16px; --rsm:12px; --shadow:0 12px 30px rgba(2,6,23,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    a{color:inherit;text-decoration:none}

    /* Header */
    header{position:sticky;top:0;z-index:40;background:#fff;border-bottom:1px solid var(--line);backdrop-filter:saturate(140%) blur(6px)}
    .hwrap{max-width:1200px;margin:auto;padding:10px 12px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{height:40px;width:auto;display:block}
    @media (max-width:640px){ .brand .logo{height:24px} } /* logo plus discret sur mobile */
    .nav{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .nav a,.iconbtn{display:inline-flex;align-items:center;gap:8px;padding:9px 12px;border:1px solid var(--line);background:#fff;border-radius:12px;box-shadow:0 1px 0 rgba(0,0,0,.02)}
    .iconbtn{cursor:pointer}
    .ic{width:16px;height:16px;display:inline-block}
    .dropdown{position:relative}
    .menu{position:absolute;right:0;top:calc(100% + 8px);background:#fff;border:1px solid var(--line);border-radius:12px;padding:6px;min-width:220px;box-shadow:0 10px 24px rgba(0,0,0,.12);display:none;z-index:60}
    .menu.show{display:block}
    .menu a{display:block;padding:8px 10px;border-radius:10px}
    .menu a:hover{background:#f3f4f6}

    /* Layout */
    .wrap{max-width:1200px;margin:16px auto 28px;padding:0 12px;display:grid;gap:16px;grid-template-columns:1.2fr .8fr}
    @media (max-width:980px){ .wrap{grid-template-columns:1fr} }
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
    .bd{padding:14px 16px}

    .title{font-weight:800;font-size:18px}
    .muted{color:var(--muted);font-size:13px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#f3f6ff;border:1px solid #e1e9ff;font-size:12px;color:#0a56d8}

    /* Forms */
    form{display:grid;gap:12px}
    label{display:block;font-weight:700;margin:4px 0}
    .req::after{content:" *";color:var(--danger)}
    input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#fbfdff;outline:none}
    input:focus,select:focus,textarea:focus{box-shadow:0 8px 24px rgba(37,99,235,.08);border-color:rgba(37,99,235,.38)}
    .row{display:grid;gap:12px}
    .cols-2{grid-template-columns:1fr 1fr}
    .cols-3{grid-template-columns:1fr 1fr 1fr}
    @media (max-width:760px){.cols-2,.cols-3{grid-template-columns:1fr}}

    /* Methods */
    .methods{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width:900px){.methods{grid-template-columns:repeat(2,1fr)}}
    .tab{position:relative;border:1px solid var(--line);background:#ffffff;border-radius:14px;padding:12px;display:flex;flex-direction:column;align-items:center;gap:10px;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease}
    .tab:hover{transform:translateY(-2px);box-shadow:0 10px 26px rgba(0,0,0,.06)}
    .tab[aria-selected="true"]{border-color:var(--brand);box-shadow:0 16px 40px rgba(37,99,235,.12)}
    .tab .logos{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;align-items:center;min-height:22px}
    .tab .logos img{height:18px;opacity:.9}
    .tab .badge{position:absolute;top:8px;right:8px;font-size:11px;background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46;padding:4px 8px;border-radius:999px}
    .tab .badge.maint{background:#fff6e6;border-color:#ffe3b8;color:#a16207}
    .tab.disabled{opacity:.7;cursor:not-allowed}
    .note{font-size:11px;color:#0a56d8;opacity:.9}

    /* Panels */
    .pm{display:none;margin-top:12px;border:1px dashed var(--line);background:#fbfdff;border-radius:14px;padding:12px}
    .pm.show{display:block}
    .pair{display:grid;gap:12px}
    @media(min-width:740px){.pair{grid-template-columns:1.2fr .8fr}}
    .copyline{display:grid;grid-template-columns:1fr auto;gap:10px}
    .copy-btn{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:700}
    .qr{display:flex;align-items:center;justify-content:center;height:210px;border-radius:12px;border:1px dashed #dbe7ff;background:#f3f6ff;color:var(--muted);font-weight:700}

    .split{display:flex;gap:8px;flex-wrap:wrap}
    .split .opt{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);background:#fff;border-radius:12px;padding:8px 10px;cursor:pointer}
    .split input{margin:0}

    /* Summary */
    .mini{display:flex;flex-direction:column;gap:10px}
    .ci{display:grid;grid-template-columns:60px 1fr auto;gap:8px}
    .ci img{width:60px;height:60px;object-fit:cover;border-radius:10px;border:1px solid var(--line);background:#f8fafc}
    .sum{display:grid;gap:10px;margin-top:10px}
    .sum-row{display:flex;align-items:center;justify-content:space-between}
    .total{font-size:18px;font-weight:900}
    .save{font-size:12px;color:#065f46;background:#ecfdf5;border:1px solid #bbf7d0;border-radius:12px;padding:6px 8px}

    /* Buttons */
    .btn{display:inline-flex;gap:10px;align-items:center;justify-content:center;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--text);cursor:pointer;font-weight:800}
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(90deg,var(--brand),var(--accent));border:none;color:#fff;box-shadow:0 14px 34px rgba(37,99,235,.25)}
    .btn.secondary{background:#fff;border:1px solid var(--line);color:#0f172a}
    .btn.ghost{background:#fafcff}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    /* Toast */
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#111;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 12px 24px rgba(0,0,0,.25);display:none;z-index:20000}
    .toast.show{display:block}

    /* Footer */
    footer{background:#fff;border-top:1px solid var(--line);margin-top:16px}
    .fwrap{max-width:1200px;margin:0 auto;padding:16px 12px;display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center;font-size:12px}
    .fwrap a{opacity:.9}
    .fwrap a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <header>
    <div class="hwrap">
      <a id="homeLink" class="brand" aria-label="Accueil">
        <img src="assets/img/logopnggfstore.png" class="logo" alt="GF Store" width="160" height="46" decoding="async">
      </a>
      <nav class="nav" aria-label="Navigation principale">
        <a id="accountLink">
          <svg class="ic" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4.418 3.582-8 8-8s8 3.582 8 8"/></svg>
          Compte
        </a>
        <a id="backShop">
          <svg class="ic" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M15 18l-6-6 6-6"/></svg>
          Continuer mes achats
        </a>
        <div class="dropdown">
          <button class="iconbtn" id="menuBtn" aria-label="Menu">
            <!-- hamburger toujours visible -->
            <svg class="ic" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M4 6h16M4 12h16M4 18h16"/></svg>
            Menu
          </button>
          <div id="menuDrop" class="menu" role="menu">
            <a id="aboutLink">À propos</a>
            <a id="cgvLink">CGV</a>
            <a id="legalLink">Mentions légales</a>
            <a id="privacyLink">Confidentialité</a>
            <a id="contactLink">Contact</a>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <main class="wrap" aria-live="polite">
    <!-- LEFT -->
    <section class="card">
      <div class="hd">
        <div>
          <div class="title">Paiement sécurisé <span id="orderIdHeader" class="muted" style="margin-left:8px"></span></div>
          <div class="muted" id="authState">Invité</div>
        </div>
        <span class="pill">SSL activé</span>
      </div>

      <div class="bd">
        <!-- Adresse -->
        <form id="addrForm" class="row cols-2" novalidate>
          <div>
            <label for="name" class="req">Nom complet</label>
            <input id="name" placeholder="Prénom Nom" required>
          </div>
          <div>
            <label for="email" class="req">Email</label>
            <input id="email" type="email" placeholder="vous@example.com" required>
          </div>
          <div>
            <label for="phone">Téléphone</label>
            <input id="phone" inputmode="tel" placeholder="+33 6 12 34 56 78">
          </div>
          <div>
            <label for="country">Pays</label>
            <input id="country" list="countries" placeholder="France">
            <datalist id="countries">
              <option value="France"/><option value="Belgique"/><option value="Suisse"/><option value="Luxembourg"/>
              <option value="Espagne"/><option value="Italie"/><option value="Allemagne"/><option value="Pays-Bas"/>
              <option value="Portugal"/><option value="Royaume-Uni"/>
            </datalist>
          </div>
          <div>
            <label for="address" class="req">Adresse</label>
            <input id="address" placeholder="10 Avenue de l’Europe" required>
          </div>
          <div class="cols-2">
            <div>
              <label for="city" class="req">Ville</label>
              <input id="city" placeholder="Paris" required>
            </div>
            <div>
              <label for="zip" class="req">Code postal</label>
              <input id="zip" inputmode="numeric" placeholder="75008" required>
            </div>
          </div>
        </form>

        <!-- Méthodes -->
        <div style="margin:14px 0 8px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div class="title" style="font-size:16px">Méthodes de paiement</div>
          <span class="muted">Carte & PayPal en maintenance — économies disponibles selon la méthode</span>
        </div>

        <div class="methods" role="tablist">
          <!-- Crypto -->
          <button class="tab" role="tab" aria-selected="true" data-method="crypto" title="Crypto">
            <span class="badge">Éco -2%</span>
            <div class="logos">
              <img alt="Bitcoin" src="https://cdn.simpleicons.org/bitcoin">
              <img alt="Ethereum" src="https://cdn.simpleicons.org/ethereum">
              <img alt="Tether" src="https://cdn.simpleicons.org/tether">
            </div>
            <div>Crypto</div>
            <div class="note">USDT, BTC, ETH</div>
          </button>

          <!-- SEPA -->
          <button class="tab" role="tab" aria-selected="false" data-method="sepa" title="Virement SEPA">
            <span class="badge">Éco -1%</span>
            <div class="logos">
              <img alt="SEPA" src="https://img.icons8.com/?size=100&id=7IJfqNBSaJ0N&format=png&color=000000">
              <img alt="IBAN" src="https://cdn.simpleicons.org/iban">
            </div>
            <div>Virement</div>
            <div class="note">SEPA / Swift</div>
          </button>

          <!-- CARD (maintenance) -->
          <button class="tab disabled" role="tab" aria-selected="false" data-method="card" title="Carte (maintenance)">
            <span class="badge maint">Maintenance</span>
            <div class="logos">
              <img alt="Visa" src="https://cdn.simpleicons.org/visa">
              <img alt="Mastercard" src="https://cdn.simpleicons.org/mastercard">
              <img alt="Amex" src="https://cdn.simpleicons.org/americanexpress">
            </div>
            <div>Carte bancaire</div>
            <div class="note">Indisponible provisoirement</div>
          </button>

          <!-- PayPal (maintenance) -->
          <button class="tab disabled" role="tab" aria-selected="false" data-method="paypal" title="PayPal (maintenance)">
            <span class="badge maint">Maintenance</span>
            <div class="logos">
              <img alt="PayPal" src="https://cdn.simpleicons.org/paypal">
            </div>
            <div>PayPal</div>
            <div class="note">Indisponible provisoirement</div>
          </button>
        </div>

        <!-- Panels -->
        <!-- CRYPTO -->
        <div id="pmCrypto" class="pm show" aria-labelledby="Crypto">
          <div class="pair">
            <div>
              <div class="row cols-2">
                <div>
                  <label for="ccy">Monnaie</label>
                  <select id="ccy">
                    <option value="USDT-TRC20" selected>USDT (TRC20)</option>
                    <option value="USDT-ERC20">USDT (ERC20)</option>
                    <option value="BTC">Bitcoin (BTC)</option>
                    <option value="ETH">Ethereum (ETH)</option>
                  </select>
                </div>
                <div>
                  <label for="amountEur">Montant à régler (EUR)</label>
                  <input id="amountEur" type="number" min="1" step="0.01" value="0" readonly>
                </div>
              </div>

              <div class="row">
                <div class="copyline">
                  <div>
                    <label for="wallet">Adresse de paiement</label>
                    <input id="wallet" readonly value="">
                  </div>
                  <button class="copy-btn" data-copy="#wallet">Copier</button>
                </div>

                <div class="copyline">
                  <div>
                    <label for="amountCcy">Montant à envoyer (<span id="ccyLabel">—</span>)</label>
                    <input id="amountCcy" readonly value="0">
                  </div>
                  <button class="copy-btn" data-copy="#amountCcy">Copier</button>
                </div>

                <div>
                  <label for="txid" class="req">Identifiant de transaction (TxID / Hash)</label>
                  <input id="txid" placeholder="Ex. 0xabc… / bc1… / TX123…" required>
                  <div class="muted" style="margin-top:6px">Requis pour accélérer la validation.</div>
                </div>

                <div>
                  <label>Paiement en plusieurs fois</label>
                  <div class="split" role="group" aria-label="Échelonnement crypto">
                    <label class="opt"><input type="radio" name="csplit" value="1" checked> 1× (plein)</label>
                    <label class="opt"><input type="radio" name="csplit" value="2"> 2× (aujourd’hui + 30j)</label>
                    <label class="opt"><input type="radio" name="csplit" value="3"> 3× (0/30/60j)</label>
                  </div>
                  <div id="csched" class="muted" style="margin-top:6px"></div>
                </div>

                <div style="display:flex;gap:10px;flex-wrap:wrap">
                  <button class="btn primary" id="confirmCrypto">Confirmer le paiement crypto</button>
                  <button class="btn secondary" id="refreshRate">Actualiser le taux</button>
                </div>
              </div>
            </div>

            <div>
              <div class="qr" aria-label="QR code de paiement">QR CODE</div>
              <div class="muted" style="text-align:center;margin-top:8px">Scannez pour pré-remplir l’adresse et le montant.</div>
            </div>
          </div>
        </div>

        <!-- SEPA -->
        <div id="pmSEPA" class="pm" aria-labelledby="Virement SEPA">
          <div class="pair">
            <div>
              <div class="row cols-2">
                <div>
                  <label>Bénéficiaire</label>
                  <input readonly value="GF STORE EU">
                </div>
                <div>
                  <label>Banque</label>
                  <input readonly value="Demo International Bank (FR)">
                </div>
                <div>
                  <label for="iban">IBAN</label>
                  <input id="iban" readonly value="FR76 3000 6000 0112 3456 7890 189">
                </div>
                <div>
                  <label for="swift">SWIFT/BIC</label>
                  <input id="swift" readonly value="DIBLFRPP">
                </div>
                <div>
                  <label for="vref">Référence virement</label>
                  <input id="vref" readonly value="GF-REF-XXXXX">
                </div>
                <div>
                  <label for="bankTotal">Montant à régler (EUR)</label>
                  <input id="bankTotal" readonly value="0">
                </div>
              </div>

              <div>
                <label>Paiement en plusieurs fois</label>
                <div class="split" role="group" aria-label="Échelonnement virement">
                  <label class="opt"><input type="radio" name="bsplit" value="1" checked> 1× (plein)</label>
                  <label class="opt"><input type="radio" name="bsplit" value="2"> 2× (aujourd’hui + 30j)</label>
                  <label class="opt"><input type="radio" name="bsplit" value="3"> 3× (0/30/60j)</label>
                </div>
                <div id="bsched" class="muted" style="margin-top:6px"></div>
              </div>

              <div class="row">
                <div>
                  <label for="proof" class="req">Preuve de virement (PDF / image)</label>
                  <input type="file" id="proof" accept="image/*,.pdf" required>
                </div>
                <div style="display:flex;gap:10px;flex-wrap:wrap">
                  <button class="btn ghost" data-copy="#iban">Copier IBAN</button>
                  <button class="btn ghost" data-copy="#swift">Copier BIC</button>
                  <button class="btn ghost" data-copy="#vref">Copier Référence</button>
                </div>
                <button class="btn primary" id="confirmBank">Confirmer le virement</button>
              </div>
            </div>

            <div>
              <div class="qr" aria-label="Conseils virement">SEPA</div>
              <div class="muted" style="text-align:center;margin-top:8px">Astuce : virement instantané = traitement plus rapide.</div>
            </div>
          </div>
        </div>

        <!-- Actions bas page -->
        <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;margin-top:14px">
          <button id="placeOrder" class="btn primary">Créer la commande</button>
          <button id="clearCart" class="btn ghost">Vider le panier</button>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="card">
      <div class="hd">
        <div class="title">Récapitulatif <span id="orderIdSummary" class="muted" style="margin-left:8px"></span></div>
        <span class="pill">Livraison ≤ 1 semaine</span>
      </div>
      <div class="bd">
        <div id="miniCart" class="mini" style="margin-bottom:10px"></div>
        <hr style="border:none;border-top:1px dashed var(--line);margin:10px 0">
        <div class="sum">
          <div class="sum-row"><span>Sous-total</span><span id="sub">—</span></div>
          <div class="sum-row"><span>Livraison</span><span id="ship">—</span></div>
          <div class="sum-row"><span>Avantage méthode</span><span id="benefit">—</span></div>
          <div class="sum-row"><span>Taxes incl.</span><span id="tax">—</span></div>
          <div class="sum-row total"><span>Total à payer</span><span id="total">—</span></div>
          <div id="saveLine" class="save" style="display:none"></div>
          <div class="muted">Retours sous 14 jours • Remboursement produits neufs • Paiement sécurisé</div>
        </div>
      </div>
    </aside>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <footer>
    <div class="fwrap">
      <div>© GF Store 2025 — Simplicité, sécurité, crypto-friendly.</div>
      <nav>
        <a id="aboutLink2">À propos</a> ·
        <a id="cgvLink2">CGV</a> ·
        <a id="legalLink2">Mentions légales</a> ·
        <a id="privacyLink2">Confidentialité</a> ·
        <a id="contactLink2">Contact</a>
      </nav>
    </div>
  </footer>

  <!-- (Optionnel) si connecté, pré-remplit depuis la session -->
  <script src="compte/js/auth.js" defer></script>

  <script>
  (async()=>{
    "use strict";
    const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));

    /* ---------- Root & Nav ---------- */
    const GH_ROOT=(()=>{const p=location.pathname.split('/').filter(Boolean);return (location.host.endsWith('github.io')&&p.length)?`/${p[0]}/`:'/';})();
    function link(id,path){ const el=$('#'+id); if(el) el.href=GH_ROOT+path; }
    link('homeLink','index.html'); link('accountLink','compte/index.html'); link('backShop','index.html');
    ['about','cgv','legal','privacy','contact'].forEach(k=>{link(k+'Link','pages/'+(k==='about'?'a-propos':k)+'.html');link(k+'Link2','pages/'+(k==='about'?'a-propos':k)+'.html');});
    const menuBtn=$('#menuBtn'), menuDrop=$('#menuDrop');
    if(menuBtn&&menuDrop){ menuBtn.addEventListener('click',e=>{e.stopPropagation();menuDrop.classList.toggle('show')}); document.addEventListener('click',e=>{if(!menuDrop.contains(e.target)&&e.target!==menuBtn)menuDrop.classList.remove('show');}); }

    /* ---------- Utils ---------- */
    const KEY_CART='gf_cart', KEY_ORDERS='gf_orders';
    const getCart=()=>{try{return JSON.parse(localStorage.getItem(KEY_CART)||'[]')}catch{return[]}};
    const setCart=arr=>localStorage.setItem(KEY_CART,JSON.stringify(arr));
    const EUR=v=>Number(v||0).toLocaleString('fr-FR',{style:'currency',currency:'EUR'});
    const vatIncluded=t=>{const r=0.20;return t-(t/(1+r));};
    const toast=msg=>{const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600); };
    const copySel=sel=>{const el=$(sel); if(!el) return; if(navigator.clipboard?.writeText){navigator.clipboard.writeText(el.value||'');}else{el.select();document.execCommand('copy');} toast('Copié');};

    // Order id
    const orderId = (()=>{ const d=new Date(), y=String(d.getFullYear()).slice(2), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'), rnd=Math.floor(Math.random()*9000)+1000; return `GF-${y}${mm}${dd}-${rnd}`; })();
    $('#orderIdHeader').textContent=orderId; $('#orderIdSummary').textContent=orderId;

    // Prefill from session if present
    (async function preload(){
      try{
        const sess=JSON.parse(localStorage.getItem('GF_SESSION')||'null');
        if(sess && sess.email){ $('#authState').textContent='Connecté'; $('#email').value=sess.email; if(sess.name) $('#name').value=sess.name; }
        else $('#authState').textContent='Invité';
        if(window.GFAuth?.api?.listUsers && sess?.email){
          const list=await GFAuth.api.listUsers();
          const me=(list||[]).find(u=>(u.email||'').toLowerCase()===(sess.email||'').toLowerCase());
          if(me){ ['phone','address','city','zip','country','name','email'].forEach(k=>{ const el=$('#'+k); if(el && !el.value && me[k]) el.value=me[k]; }); }
        }
      }catch{}
    })();

    /* ---------- Shipping & benefits ---------- */
    const shipping=6.90;
    function currentPM(){ return $('.tab[aria-selected="true"]')?.dataset.method || 'crypto'; }
    function benefitRate(){ return currentPM()==='crypto'?0.02 : currentPM()==='sepa'?0.01 : 0; }

    /* ---------- FX mock (crypto) ---------- */
    const fx={'USDT-TRC20':{symbol:'USDT',rate:1},'USDT-ERC20':{symbol:'USDT',rate:1},'BTC':{symbol:'BTC',rate:60000},'ETH':{symbol:'ETH',rate:3000}};
    function setCryptoAddress(ccy){
      const map={'USDT-TRC20':'TQf3k7s9h2x4y5z6a7b8c9d0e1f2g3h4i','USDT-ERC20':'0x3Fb8b7E6cA9f4D2E1b0C9a8F7e6D5c4B3a2F1E0','BTC':'bc1q9v8w7x6y5z4a3b2c1d0e9f8g7h6j5k4l3m2n','ETH':'0x9eF2B3cD4a5E6f7B8c9D0E1F2A3b4C5d6E7f8A9B'};
      $('#wallet').value=map[ccy]||'';
    }

    /* ---------- Summary ---------- */
    function computeSub(cart){ return cart.reduce((s,x)=>s+Number(x.price||0)*Number(x.qty||1),0); }
    function updateSummary(){
      const cart=getCart(), wrap=$('#miniCart');
      if(!cart.length){
        wrap.innerHTML='<div class="muted">Votre panier est vide.</div>';
        ['sub','ship','benefit','tax','total'].forEach(id=>$('#'+id).textContent='—');
        $('#amountEur').value=0; $('#bankTotal').value=0; $('#placeOrder').disabled=true; $('#saveLine').style.display='none';
        return;
      }
      $('#placeOrder').disabled=false;
      wrap.innerHTML=cart.map(x=>`
        <div class="ci">
          <img src="${x.image||''}" alt="${x.name||''}">
          <div>
            <div style="font-weight:700">${x.name||''}</div>
            <div class="muted" style="font-size:12px">${x.brand||''} • ${x.category||''}</div>
          </div>
          <div style="font-weight:800">${EUR(Number(x.price||0)*Number(x.qty||1))}</div>
        </div>`).join('');

      const sub=computeSub(cart), benefit=sub*benefitRate(), total=Math.max(0, sub+shipping-benefit), tax=vatIncluded(total);
      $('#sub').textContent=EUR(sub); $('#ship').textContent=EUR(shipping);
      $('#benefit').textContent= benefit ? '–'+EUR(benefit) : '—';
      $('#tax').textContent='≈ '+EUR(tax); $('#total').textContent=EUR(total);
      if(benefit>0){ $('#saveLine').style.display='block'; $('#saveLine').textContent=`Économie immédiate : ${EUR(benefit)}`; } else { $('#saveLine').style.display='none'; }

      // feed panels
      $('#amountEur').value=total.toFixed(2); $('#bankTotal').value=total.toFixed(2);
      const ccy=$('#ccy').value, r=fx[ccy]?.rate||1, amt=total/r;
      $('#amountCcy').value=(amt>0?amt:0).toFixed(6).replace(/0+$/,'').replace(/\.$/,''); $('#ccyLabel').textContent=fx[ccy]?.symbol||'';
      // schedule previews
      renderSchedules();
    }

    /* ---------- Split schedules ---------- */
    function scheduleText(total,parts){
      const now=new Date(); const steps=[0,30,60];
      const amounts=[]; // répartir proprement sans centimes perdus
      let remaining=Math.round(total*100);
      for(let i=0;i<parts;i++){
        const part=i===parts-1? remaining : Math.round((total/parts)*100);
        amounts.push(part); remaining-=part;
      }
      return amounts.map((cents,i)=>{
        const d=new Date(now); d.setDate(d.getDate()+steps[i]);
        return `${i+1}/${parts} — ${EUR(cents/100)} • ${d.toLocaleDateString('fr-FR')}`;
      }).join(' | ');
    }
    function renderSchedules(){
      const total=Number($('#amountEur').value||0);
      const cparts=Number(document.querySelector('input[name="csplit"]:checked')?.value||1);
      const bparts=Number(document.querySelector('input[name="bsplit"]:checked')?.value||1);
      $('#csched').textContent=total? scheduleText(total,cparts) : '';
      $('#bsched').textContent=total? scheduleText(total,bparts) : '';
    }

    /* ---------- Events ---------- */
    // Method tabs
    $$('.tab').forEach(tab=>{
      tab.addEventListener('click', ()=>{
        if(tab.classList.contains('disabled')){ toast('Indisponible pour le moment'); return; }
        $$('.tab').forEach(t=>t.setAttribute('aria-selected', String(t===tab)));
        $('#pmCrypto').classList.toggle('show', tab.dataset.method==='crypto');
        $('#pmSEPA').classList.toggle('show', tab.dataset.method==='sepa');
        updateSummary();
      });
    });

    // Copy buttons
    $$('[data-copy]').forEach(btn=> btn.addEventListener('click', ()=> copySel(btn.getAttribute('data-copy')) ));

    // Crypto controls
    $('#ccy').addEventListener('change', ()=>{ setCryptoAddress($('#ccy').value); updateSummary(); });
    let rateLock=15*60;
    setInterval(()=>{ if(rateLock>0){ rateLock--; } },1000);
    $('#refreshRate').addEventListener('click', ()=>{ rateLock=15*60; toast('Taux rafraîchi'); });

    // Split options
    $$('input[name="csplit"]').forEach(r=>r.addEventListener('change', renderSchedules));
    $$('input[name="bsplit"]').forEach(r=>r.addEventListener('change', renderSchedules));

    // Clear cart
    $('#clearCart').addEventListener('click', ()=>{ if(!confirm('Vider votre panier ?')) return; setCart([]); updateSummary(); toast('Panier vidé'); });

    // Validate address
    function validateAddress(){
      const req=['name','email','address','city','zip'];
      for(const id of req){ const el=$('#'+id); if(!el || !el.value.trim()){ el?.focus(); toast('Veuillez compléter vos informations.'); return false; } }
      return true;
    }

    // Confirmations
    $('#confirmCrypto').addEventListener('click', ()=>{
      if(!validateAddress()) return;
      if(!$('#txid').value.trim()){ $('#txid').focus(); toast('TxID requis.'); return; }
      toast('Paiement crypto enregistré — validation en cours');
    });
    $('#confirmBank').addEventListener('click', ()=>{
      if(!validateAddress()) return;
      const proof=$('#proof');
      if(!proof.files.length){ proof.focus(); toast('Preuve de virement requise.'); return; }
      toast('Preuve reçue — vérification en cours');
    });

    // Create order (save local + redirect compte)
    $('#placeOrder').addEventListener('click', ()=>{
      if(!validateAddress()) return;
      const pm=currentPM(); const cart=getCart(); if(!cart.length){ toast('Votre panier est vide.'); return; }
      // extra checks by method
      if(pm==='crypto' && !$('#txid').value.trim()){ $('#txid').focus(); toast('TxID requis.'); return; }
      if(pm==='sepa' && !$('#proof').files.length){ $('#proof').focus(); toast('Preuve de virement requise.'); return; }

      const sub=computeSub(cart), benefit=sub*benefitRate(), total=Math.max(0, sub+shipping-benefit);
      const sess=JSON.parse(localStorage.getItem('GF_SESSION')||'null');
      const parts = Number(document.querySelector(`input[name="${pm==='crypto'?'csplit':'bsplit'}"]:checked`)?.value||1);

      const order={
        id:orderId, date:new Date().toISOString(),
        status: pm==='crypto' ? 'Attente confirmation réseau' : 'Preuve reçue',
        userId: (sess?.email || 'guest'),
        items: cart,
        pricing:{sub, ship:shipping, benefit, total, currency:'EUR'},
        shipping:{
          name:$('#name').value.trim(), email:$('#email').value.trim(), phone:$('#phone').value.trim(),
          address:$('#address').value.trim(), city:$('#city').value.trim(), zip:$('#zip').value.trim(), country:$('#country').value.trim()
        },
        payment:{
          method: pm,
          split: parts,
          details: pm==='crypto'
            ? {ccy:$('#ccy').value, address:$('#wallet').value, amount:$('#amountCcy').value, txid:$('#txid').value.trim()}
            : {iban:$('#iban').value, ref:$('#vref').value}
        }
      };

      try{ const all=JSON.parse(localStorage.getItem(KEY_ORDERS)||'[]'); all.push(order); localStorage.setItem(KEY_ORDERS, JSON.stringify(all)); }catch{}
      setCart([]); updateSummary();
      toast('Commande '+order.id+' créée');
      setTimeout(()=>location.replace(GH_ROOT+'compte/index.html'), 900);
    });

    // Init
    setCryptoAddress($('#ccy').value);
    // Generate reference with order id for bank
    $('#vref').value='GF-'+orderId;
    updateSummary();

  })();
  </script>
</body>
</html>
