<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Changer le mot de passe ‚Äî GF Store</title>
  <meta name="description" content="Changez votre mot de passe GF Store en toute s√©curit√©.">
  <style>
    :root{--w:860px;--c:#0f172a;--a:#2563eb;--g:#10b981;--bg:#f5f7fb;--r:16px}
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;color:var(--c);background:var(--bg)}
    a{color:inherit}
    header{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid #e5e7eb;backdrop-filter:saturate(140%) blur(4px)}
    .hwrap{max-width:var(--w);margin:auto;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand .logo{height:34px;width:auto;display:block}
    .nav{display:flex;gap:8px;align-items:center}
    .iconbtn,.nav a{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid #e5e7eb;background:#fff;border-radius:12px;text-decoration:none;color:inherit}
    .iconbtn{cursor:pointer}
    .ic{width:16px;height:16px;display:inline-block}
    .dropdown{position:relative}
    .menu{position:absolute;right:0;top:calc(100% + 8px);background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:6px;min-width:220px;box-shadow:0 10px 24px rgba(0,0,0,.12);display:none;z-index:30}
    .menu.show{display:block}
    .menu a{display:block;padding:8px 10px;border-radius:8px;text-decoration:none}
    .menu a:hover{background:#f3f4f6}

    .banner{background:linear-gradient(90deg,#1e3a8a,#2563eb,#0ea5e9);color:#fff;text-align:center;padding:10px 14px}
    .banner .timer{font-weight:700;border-radius:999px;padding:2px 8px;background:rgba(255,255,255,.15);display:inline-block}
    .banner .sep{opacity:.6;padding:0 6px}

    .wrap{max-width:600px;margin:18px auto 28px;padding:0 12px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 1px 0 rgba(0,0,0,.02);padding:16px}
    h1{font-size:20px;margin:6px 0 2px}
    .muted{opacity:.7;font-size:13px;margin-bottom:12px}
    .who{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .chip{display:inline-block;line-height:1;padding:2px 6px;border-radius:999px;background:#f0f9ff;color:#0ea5e9;font-size:11px;border:1px solid #bae6fd}

    form{display:grid;gap:12px}
    .row{display:grid;gap:6px}
    label{font-weight:600}
    input[type=password]{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff}
    .pw{position:relative}
    .pw .toggle{position:absolute;right:8px;top:50%;transform:translateY(-50%);border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:6px 8px;cursor:pointer;font-size:12px}

    .meter{height:8px;background:#f1f5f9;border-radius:999px;overflow:hidden;border:1px solid #e5e7eb}
    .meter>i{display:block;height:100%;width:0;transition:width .2s}
    .meter[data-lvl="1"]>i{width:25%;background:#ef4444}
    .meter[data-lvl="2"]>i{width:50%;background:#f59e0b}
    .meter[data-lvl="3"]>i{width:75%;background:#10b981}
    .meter[data-lvl="4"]>i{width:100%;background:#10b981}

    .actions{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between}
    .btn{display:inline-flex;align-items:center;gap:8px;justify-content:center;padding:12px 14px;border:1px solid #1e40af;background:linear-gradient(180deg,#2563eb,#1e40af);color:#fff;border-radius:12px;cursor:pointer;min-width:160px}
    .btn.secondary{background:#fff;border:1px solid #e5e7eb;color:#111}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .msg{border-radius:12px;padding:10px 12px;display:none;margin-top:4px}
    #changeMsg{background:#fef2f2;border:1px solid #fee2e2;color:#991b1b} /* sera recolori√© par showMsg() */

    footer{background:#fff;border-top:1px solid #e5e7eb;margin-top:26px}
    .fwrap{max-width:var(--w);margin:0 auto;padding:16px 12px;display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center;font-size:12px}
    .fwrap a{text-decoration:none;color:inherit;opacity:.9}
    .fwrap a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="banner" role="status" aria-live="polite">
    üéâ Promo sp√©ciale rentr√©e : <b>-25% √† -30%</b> sur PC, t√©l√©phones et consoles
    <span class="sep">‚Ä¢</span>
    <span id="countdown" class="timer"></span>
  </div>

  <header>
    <div class="hwrap">
      <a id="homeLink" class="brand" aria-label="Aller √† l'accueil">
        <img src="../assets/img/logopnggfstore.png" class="logo" alt="GF Store" width="180" height="52" decoding="async">
      </a>
      <nav class="nav" aria-label="Navigation">
        <a id="accountLink"><img class="ic" id="icHome" alt="" role="presentation"> Mon compte</a>
        <button class="iconbtn" id="logoutBtn" title="Se d√©connecter"><img class="ic" id="icLogout" alt="" role="presentation"> D√©connexion</button>
        <div class="dropdown">
          <button class="iconbtn" id="menuBtn" aria-label="Menu" aria-haspopup="true" aria-expanded="false"><img class="ic" id="icMenu" alt="" role="presentation"></button>
          <div id="menuDrop" class="menu" role="menu">
            <a id="aboutLink" role="menuitem">√Ä propos</a>
            <a id="cgvLink" role="menuitem">CGV</a>
            <a id="legalLink" role="menuitem">Mentions l√©gales</a>
            <a id="privacyLink" role="menuitem">Confidentialit√©</a>
            <a id="contactLink" role="menuitem">Contact</a>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <h1>Changer le mot de passe</h1>
      <div class="who">
        Connect√© en tant que <strong id="whoEmail">‚Äî</strong> <span class="chip" id="since" style="display:none"></span>
      </div>
      <div class="muted">Pour des raisons de s√©curit√©, vous devez saisir votre mot de passe actuel. (Authentification via Google Apps Script.)</div>

      <!-- Zone messages utilis√©e par auth.js -->
      <div id="changeMsg" class="msg" role="status" aria-live="polite"></div>

      <!-- IMPORTANT : noms/ids attendus par auth.js -->
      <form id="changePasswordForm" novalidate>
        <div class="row pw">
          <label for="oldPassword">Mot de passe actuel</label>
          <input id="oldPassword" name="oldPassword" type="password" placeholder="Mot de passe actuel" autocomplete="current-password" required>
          <button type="button" class="toggle" data-target="oldPassword">Afficher</button>
        </div>

        <div class="row pw">
          <label for="newPassword">Nouveau mot de passe</label>
          <input id="newPassword" name="newPassword" type="password" placeholder="Au moins 6 caract√®res" autocomplete="new-password" minlength="6" required>
          <button type="button" class="toggle" data-target="newPassword">Afficher</button>
          <div class="meter" id="meter"><i></i></div>
        </div>

        <div class="row pw">
          <label for="newPassword2">Confirmez le nouveau mot de passe</label>
          <input id="newPassword2" name="newPassword2" type="password" placeholder="Ressaisissez le mot de passe" autocomplete="new-password" minlength="6" required>
          <button type="button" class="toggle" data-target="newPassword2">Afficher</button>
        </div>

        <div class="actions">
          <a class="btn secondary" id="backBtn">Annuler</a>
          <button id="saveBtn" class="btn" type="submit"><img class="ic" id="icSave" alt="" role="presentation"> Mettre √† jour</button>
        </div>
      </form>

      <hr style="border:none;border-top:1px dashed #e5e7eb;margin:14px 0">
      <div class="actions">
        <div class="muted">Mot de passe oubli√© ?</div>
        <a class="btn secondary" id="goReset">R√©initialiser via email</a>
      </div>
    </div>
  </main>

  <footer>
    <div class="fwrap">
      <div>¬© GF Store 2025 ‚Äî Simplicit√©, s√©curit√©, crypto-friendly.</div>
      <nav>
        <a id="aboutLink2">√Ä propos</a> ¬∑
        <a id="cgvLink2">CGV</a> ¬∑
        <a id="legalLink2">Mentions l√©gales</a> ¬∑
        <a id="privacyLink2">Confidentialit√©</a> ¬∑
        <a id="contactLink2">Contact</a>
      </nav>
    </div>
  </footer>

  <!-- Auth frontend (expose window.GFAuth et branche automatiquement #changePasswordForm) -->
  <script src="js/auth.js" defer></script>

  <script>
  (function(){
    "use strict";

    // Helpers
    const $ = (s,root)=> (root||document).querySelector(s);

    // GH Pages friendly root
    const GH_ROOT = (()=>{ 
      const parts = location.pathname.split('/').filter(Boolean);
      return (location.host.endsWith('github.io') && parts.length) ? `/${parts[0]}/` : '/';
    })();

    // Icons
    const ICONS={
      menu:'https://img.icons8.com/?size=100&id=RzDomvpIKGI9&format=png&color=000000',
      logout:'https://img.icons8.com/?size=100&id=IKneRwT2PRjz&format=png&color=000000',
      home:'https://img.icons8.com/?size=100&id=99667&format=png&color=000000',
      save:'https://img.icons8.com/?size=100&id=63257&format=png&color=ffffff'
    };
    function setSrc(id,src){ const el=document.getElementById(id); if(el) el.src=src; }

    // Links
    function wireLinks(){
      $('#homeLink').href = GH_ROOT;
      const link=(id,path)=>{ const el=document.getElementById(id); if(el) el.href=GH_ROOT+path; };
      link('accountLink','compte/index.html');
      link('backBtn','compte/index.html');
      link('goReset','compte/password-reset.html');

      const pages = {about:'a-propos', cgv:'cgv', legal:'mentions-legales', privacy:'confidentialite', contact:'contact'};
      Object.entries(pages).forEach(([k,slug])=>{
        link(k+'Link','pages/'+slug+'.html'); link(k+'Link2','pages/'+slug+'.html');
      });
    }

    // Menu
    function wireMenu(){
      const menuBtn=$('#menuBtn'), menuDrop=$('#menuDrop');
      if(!menuBtn || !menuDrop) return;
      menuBtn.addEventListener('click', e=>{
        e.stopPropagation();
        const shown = menuDrop.classList.toggle('show');
        menuBtn.setAttribute('aria-expanded', shown ? 'true' : 'false');
      });
      document.addEventListener('click', e=>{
        if(!menuDrop.contains(e.target) && e.target!==menuBtn){
          menuDrop.classList.remove('show');
          menuBtn.setAttribute('aria-expanded','false');
        }
      });
    }

    // Banner countdown (48h)
    const countdownEl = $('#countdown');
    const SALE_END = new Date(Date.now()+48*60*60*1000);
    const two = n => String(n).padStart(2,'0');
    function tick(){
      if(!countdownEl) return;
      const now=new Date(); let diff=SALE_END-now;
      if(diff<=0){ countdownEl.textContent='Derni√®res heures !'; return; }
      const d=Math.floor(diff/86400000); diff%=86400000;
      const h=Math.floor(diff/3600000); diff%=3600000;
      const m=Math.floor(diff/60000); const s=Math.floor((diff%60000)/1000);
      countdownEl.textContent=`${d?d+'j ':''}${two(h)}:${two(m)}:${two(s)} restants`;
    }

    // Password UI helpers (ne PAS interf√©rer avec submit auth.js)
    function wirePasswordUI(){
      // toggles
      document.querySelectorAll('.toggle').forEach(btn=>{
        btn.addEventListener('click',()=>{
          const id=btn.getAttribute('data-target');
          const input=document.getElementById(id);
          if(!input) return;
          const t=input.type==='password'?'text':'password';
          input.type=t;
          btn.textContent=t==='password'?'Afficher':'Masquer';
        });
      });

      // strength meter
      const meter = $('#meter');
      const newPw = $('#newPassword');
      function strength(v){
        let s=0; if(v.length>=6) s++; if(/[A-Z]/.test(v)) s++; if(/[a-z]/.test(v)) s++; if(/[0-9\W_]/.test(v)) s++;
        return Math.min(s,4);
      }
      function updateMeter(){ if(meter) meter.setAttribute('data-lvl', String(strength(newPw.value)||0)); }
      if(newPw){ newPw.addEventListener('input', updateMeter); updateMeter(); }

      // confirm validity
      const newPw2 = $('#newPassword2');
      function validateMatch(){
        if(!newPw || !newPw2) return;
        if(newPw2.value && newPw.value !== newPw2.value){
          newPw2.setCustomValidity('Les mots de passe ne correspondent pas.');
        }else{
          newPw2.setCustomValidity('');
        }
      }
      if(newPw && newPw2){
        newPw.addEventListener('input', validateMatch);
        newPw2.addEventListener('input', validateMatch);
      }
    }

    // Logout
    function wireLogout(){
      const btn = $('#logoutBtn');
      if(!btn) return;
      btn.addEventListener('click', (e)=>{
        e.preventDefault();
        try{ if(window.GFAuth && typeof window.GFAuth.clearSession==='function') window.GFAuth.clearSession(); }catch{}
        location.replace(GH_ROOT+'compte/login.html');
      });
    }

    // Session display
    function fillSessionHeader(){
      try{
        if(!window.GFAuth || typeof window.GFAuth.getSession!=='function') return;
        const s = window.GFAuth.getSession();
        if(!s || !s.email) return; // auth.js redirigera de toute fa√ßon
        const who = $('#whoEmail'); if(who) who.textContent = s.email;
        const since = $('#since');
        if(s.loggedAt && since){
          const d = new Date(s.loggedAt);
          if(!isNaN(+d)){ since.style.display='inline-block'; since.textContent='connect√© depuis ' + d.toLocaleString('fr-FR'); }
        }
      }catch{}
    }

    function init(){
      // icons
      setSrc('icMenu', ICONS.menu);
      setSrc('icLogout', ICONS.logout);
      setSrc('icHome', ICONS.home);
      setSrc('icSave', ICONS.save);

      wireLinks();
      wireMenu();
      wireLogout();
      wirePasswordUI();
      fillSessionHeader();

      tick(); setInterval(tick,1000);
    }

    document.addEventListener('DOMContentLoaded', init);
  })();
  </script>
</body>
</html>
