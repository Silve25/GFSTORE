<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mon compte ‚Äî GF Store</title>
  <meta name="description" content="Espace Mon Compte de GF Store : profil, commandes, adresses et s√©curit√© du compte." />
  <style>
    :root{--w:1200px;--c:#0f172a;--a:#2563eb;--g:#10b981;--bg:#f5f7fb;--r:16px}
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;color:var(--c);background:var(--bg)}
    a{color:inherit}
    header{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid #e5e7eb;backdrop-filter:saturate(140%) blur(4px)}
    .hwrap{max-width:var(--w);margin:auto;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand .logo{height:40px;width:auto;display:block}
    .nav{display:flex;gap:10px;align-items:center}
    .nav a,.iconbtn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid #e5e7eb;background:#fff;border-radius:12px;text-decoration:none;box-shadow:0 1px 0 rgba(0,0,0,.02)}
    .nav a:hover,.iconbtn:hover{box-shadow:0 2px 10px rgba(0,0,0,.06)}
    .iconbtn{cursor:pointer}
    .ic{width:16px;height:16px;display:inline-block}
    .dropdown{position:relative}
    .menu{position:absolute;right:0;top:calc(100% + 8px);background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:6px;min-width:220px;box-shadow:0 10px 24px rgba(0,0,0,.12);display:none;z-index:60}
    .menu.show{display:block}
    .menu a{display:block;padding:8px 10px;border-radius:8px;text-decoration:none}
    .menu a:hover{background:#f3f4f6}

    .banner{background:linear-gradient(90deg,#1e3a8a,#2563eb,#0ea5e9);color:#fff;text-align:center;padding:10px 14px}
    .banner .timer{font-weight:700;border-radius:999px;padding:2px 8px;background:rgba(255,255,255,.15);display:inline-block}
    .banner .sep{opacity:.6;padding:0 6px}

    .wrap{max-width:var(--w);margin:12px auto 28px;padding:0 12px;display:grid;gap:14px;grid-template-columns:1.1fr 1fr}
    @media (max-width:900px){ .wrap{grid-template-columns:1fr} }
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:12px;box-shadow:0 1px 0 rgba(0,0,0,.02)}
    .hdr{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    .avatar{width:56px;height:56px;border-radius:999px;display:grid;place-items:center;font-weight:800;background:#eff6ff;border:1px solid #dbeafe;color:#1d4ed8}
    h1{font-size:18px;margin:0}
    .muted{opacity:.7;font-size:12px}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff;cursor:pointer;text-decoration:none}
    .btn.primary{border-color:#1e40af;background:linear-gradient(180deg,#2563eb,#1e40af);color:#fff;box-shadow:0 6px 14px rgba(30,64,175,.25)}
    .btn.danger{border-color:#be123c;background:linear-gradient(180deg,#ef4444,#b91c1c);color:#fff;box-shadow:0 6px 14px rgba(185,28,28,.25)}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media (max-width:640px){ .kpis{grid-template-columns:1fr 1fr} }
    .kpi{background:linear-gradient(180deg,#ffffff,#f8fbff);border:1px solid #e5e7eb;border-radius:12px;padding:10px}
    .kpi .n{font-weight:800;font-size:18px}
    .list{display:grid;gap:10px}
    .order{border:1px solid #e5e7eb;border-radius:12px;padding:10px;display:grid;gap:6px}
    .order .top{display:flex;gap:8px;align-items:center;font-size:13px}
    .pill{display:inline-grid;place-items:center;border:1px solid #e5e7eb;padding:2px 8px;border-radius:999px;font-size:12px;background:#fff}
    .addr{border:1px dashed #e5e7eb;border-radius:12px;padding:10px;background:#fcfcfe}
    .empty{opacity:.7}
    .hint{font-size:12px;opacity:.8;margin-top:6px}
    .dangerzone{border:1px solid #fee2e2;background:#fff1f2}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:740px){ .grid2{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="banner" role="status" aria-live="polite">
    üéâ Promo sp√©ciale rentr√©e : <b>-25% √† -30%</b> sur PC, t√©l√©phones et consoles
    <span class="sep">‚Ä¢</span>
    <span id="countdown" class="timer"></span>
  </div>

  <header>
    <div class="hwrap">
      <a id="homeLink" class="brand" aria-label="Aller √† l'accueil">
        <img src="../assets/img/logopnggfstore.png" class="logo" alt="GF Store" width="180" height="52" decoding="async">
      </a>
      <nav class="nav" aria-label="Navigation principale">
        <a id="accountLink"><img class="ic" id="icUser" alt="" role="presentation"> Compte</a>
        <a id="cartBtn" class="iconbtn"><img id="cartIcon" class="ic" alt="" role="presentation"> Panier</a>
        <div class="dropdown">
          <button class="iconbtn" id="menuBtn" aria-haspopup="true" aria-expanded="false" aria-label="Menu">
            <img class="ic" id="icMenu" alt="" role="presentation">
          </button>
          <div id="menuDrop" class="menu" role="menu">
            <a id="aboutLink" role="menuitem">√Ä propos</a>
            <a id="cgvLink" role="menuitem">CGV</a>
            <a id="legalLink" role="menuitem">Mentions l√©gales</a>
            <a id="privacyLink" role="menuitem">Politique de confidentialit√©</a>
            <a id="contactLink" role="menuitem">Contact</a>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <main class="wrap" aria-live="polite">
    <!-- Colonne principale -->
    <section class="card">
      <div class="hdr">
        <div class="avatar" id="avatar" aria-hidden="true">?</div>
        <div>
          <h1>Bonjour <span id="userName">‚Äî</span></h1>
          <div class="muted" id="userEmail">‚Äî</div>
          <div class="muted" id="lastLogin" style="margin-top:2px"></div>
        </div>
      </div>

      <div class="row" style="gap:8px;margin-bottom:10px">
        <a id="btnProfile" class="btn"><img class="ic" id="icProfile" alt="" role="presentation"> Modifier mon profil</a>
        <a id="btnPwd" class="btn"><img class="ic" id="icKey" alt="" role="presentation"> Changer mon mot de passe</a>
        <button id="btnLogout" class="btn" type="button"><img class="ic" id="icLogout" alt="" role="presentation"> Se d√©connecter</button>
      </div>

      <div class="kpis" id="kpis" aria-label="Indicateurs">
        <div class="kpi"><div class="n" id="kpiOrders">0</div><div class="muted">Commandes</div></div>
        <div class="kpi"><div class="n" id="kpiAddresses">0</div><div class="muted">Adresses</div></div>
        <div class="kpi"><div class="n" id="kpiCart">0</div><div class="muted">Articles dans le panier</div></div>
      </div>
    </section>

    <!-- Colonne lat√©rale -->
    <aside class="grid2" aria-label="Informations et actions">
      <section class="card">
        <div class="hdr"><img class="ic" id="icBox" alt="" role="presentation"><strong>Mes derni√®res commandes</strong></div>
        <div id="ordersWrap" class="list empty">Aucune commande pour le moment.</div>
        <div class="hint">Astuce : passe une commande depuis la boutique, elle s‚Äôaffichera ici (d√©mo : stockage local).</div>
      </section>

      <section class="card">
        <div class="hdr"><img class="ic" id="icHome" alt="" role="presentation"><strong>Mon adresse principale</strong></div>
        <div id="addrBox" class="addr empty">Aucune adresse enregistr√©e.</div>
        <div class="row" style="margin-top:8px">
          <a id="btnEditAddress" class="btn"><img class="ic" id="icEdit" alt="" role="presentation"> Ajouter / Modifier</a>
        </div>
        <div class="hint">Adresse lue/√©crite via ton profil (Google Sheet). Pour la d√©mo, commandes & panier restent locaux.</div>
      </section>

      <section class="card dangerzone" aria-label="Zone sensible">
        <div class="hdr"><img class="ic" id="icWarning" alt="" role="presentation"><strong>Zone sensible</strong></div>
        <div class="muted">Supprimer les donn√©es locales (panier/commandes de d√©mo) et fermer la session.</div>
        <button id="btnDelete" class="btn danger" style="margin-top:8px" type="button">
          <img class="ic" id="icTrash" alt="" role="presentation"> Supprimer mes donn√©es locales
        </button>
      </section>
    </aside>
  </main>

  <footer style="background:#fff;border-top:1px solid #e5e7eb">
    <div class="hwrap" style="justify-content:space-between;font-size:12px">
      <div>¬© GF Store 2025 ‚Äî Simplicit√©, s√©curit√©, crypto-friendly.</div>
      <nav style="display:flex;gap:10px;flex-wrap:wrap" aria-label="Liens de pied de page">
        <a id="aboutLink2">√Ä propos</a> ¬∑ 
        <a id="cgvLink2">CGV</a> ¬∑ 
        <a id="legalLink2">Mentions l√©gales</a> ¬∑ 
        <a id="privacyLink2">Confidentialit√©</a> ¬∑ 
        <a id="contactLink2">Contact</a>
      </nav>
    </div>
  </footer>

  <!-- Ton auth frontend (expos√© global: window.GFAuth) -->
  <script src="js/auth.js" defer></script>

  <script>
  // Important : ce script suppose que js/auth.js est charg√© (defer) et expose window.GFAuth
  (function(){
    "use strict";

    // --- Utilitaires
    const $ = (s,root)=> (root||document).querySelector(s);
    const $all = (s,root)=> Array.from((root||document).querySelectorAll(s));
    const two = n => String(n).padStart(2,'0');

    // --- Racine (GitHub Pages friendly)
    const GH_ROOT = (()=>{ 
      const parts = location.pathname.split('/').filter(Boolean);
      return (location.host.endsWith('github.io') && parts.length) ? `/${parts[0]}/` : '/';
    })();

    // --- Compte √† rebours (48h √† partir du chargement)
    const SALE_END = new Date(Date.now()+48*60*60*1000);
    const countdownEl = $('#countdown');
    function tick(){
      if(!countdownEl) return;
      const now = new Date(); let diff = SALE_END - now;
      if(diff <= 0){ countdownEl.textContent = 'Derni√®res heures !'; return; }
      const d = Math.floor(diff/86400000); diff%=86400000;
      const h = Math.floor(diff/3600000); diff%=3600000;
      const m = Math.floor(diff/60000);   const s = Math.floor((diff%60000)/1000);
      countdownEl.textContent = `${d?d+'j ':''}${two(h)}:${two(m)}:${two(s)} restants`;
    }
    tick(); setInterval(tick, 1000);

    // --- Ic√¥nes
    const ICONS = {
      user:'https://img.icons8.com/?size=100&id=n8DrUm77sR3l&format=png&color=000000',
      menu:'https://img.icons8.com/?size=100&id=RzDomvpIKGI9&format=png&color=000000',
      cart:'https://img.icons8.com/?size=100&id=AaWM1DnCz2bQ&format=png&color=000000',
      cartFull:'https://img.icons8.com/?size=100&id=K5Jv3BfpxPYa&format=png&color=000000',
      profile:'https://img.icons8.com/?size=100&id=59853&format=png&color=000000',
      key:'https://img.icons8.com/?size=100&id=12217&format=png&color=000000',
      logout:'https://img.icons8.com/?size=100&id=IKneRwT2PRjz&format=png&color=000000',
      box:'https://img.icons8.com/?size=100&id=59812&format=png&color=000000',
      home:'https://img.icons8.com/?size=100&id=15869&format=png&color=000000',
      edit:'https://img.icons8.com/?size=100&id=67884&format=png&color=000000',
      warning:'https://img.icons8.com/?size=100&id=12259&format=png&color=000000',
      trash:'https://img.icons8.com/?size=100&id=xGanKhWh8MxC&format=png&color=000000'
    };
    const setSrc = (id,src)=>{ const el = document.getElementById(id); if(el) el.src = src; };
    function setIcons(){
      setSrc('icUser',ICONS.user); setSrc('icMenu',ICONS.menu);
      setSrc('cartIcon',ICONS.cart); setSrc('icProfile',ICONS.profile);
      setSrc('icKey',ICONS.key); setSrc('icLogout',ICONS.logout);
      setSrc('icBox',ICONS.box); setSrc('icHome',ICONS.home);
      setSrc('icEdit',ICONS.edit); setSrc('icWarning',ICONS.warning);
      setSrc('icTrash',ICONS.trash);
    }

    // --- Liens selon GH_ROOT
    function wireLinks(){
      $('#homeLink').href = GH_ROOT;
      const link = (id, path)=>{ const el = document.getElementById(id); if(el) el.href = GH_ROOT + path; };
      link('accountLink','compte/index.html');
      link('cartBtn','checkout.html');
      link('aboutLink','pages/a-propos.html'); link('aboutLink2','pages/a-propos.html');
      link('cgvLink','pages/cgv.html');        link('cgvLink2','pages/cgv.html');
      link('legalLink','pages/mentions-legales.html'); link('legalLink2','pages/mentions-legales.html');
      link('privacyLink','pages/confidentialite.html'); link('privacyLink2','pages/confidentialite.html');
      link('contactLink','pages/contact.html'); link('contactLink2','pages/contact.html');
    }

    // --- Menu d√©roulant
    function wireMenu(){
      const menuBtn = $('#menuBtn'); const menuDrop = $('#menuDrop');
      if(!menuBtn || !menuDrop) return;
      menuBtn.addEventListener('click', e=>{
        e.stopPropagation();
        const shown = menuDrop.classList.toggle('show');
        menuBtn.setAttribute('aria-expanded', shown ? 'true' : 'false');
      });
      document.addEventListener('click', e=>{
        if(!menuDrop.contains(e.target) && e.target!==menuBtn) {
          menuDrop.classList.remove('show');
          menuBtn.setAttribute('aria-expanded','false');
        }
      });
    }

    // --- Storage d√©mo (panier/commandes)
    const KEY_CART   = 'gf_cart';
    const KEY_ORDERS = 'gf_orders';
    const getCart = ()=>{ try{return JSON.parse(localStorage.getItem(KEY_CART)||'[]')}catch{return[]} };
    const saveCart = (v)=> localStorage.setItem(KEY_CART, JSON.stringify(v||[]));
    const cartCount = ()=> getCart().reduce((s,x)=> s + Number(x.qty||0), 0);
    const getOrders = ()=>{ try{return JSON.parse(localStorage.getItem(KEY_ORDERS)||'[]')}catch{return[]} };
    const saveOrders = (arr)=> localStorage.setItem(KEY_ORDERS, JSON.stringify(arr||[]));

    // --- Rendu commandes (local) + reorder
    function renderOrders(orders, sessionEmail){
      const ordersWrap = $('#ordersWrap');
      if(!ordersWrap) return;
      const EUR = v => Number(v||0).toLocaleString('fr-FR',{style:'currency',currency:'EUR'});

      const mine = orders.filter(o => String(o.userId||'').toLowerCase() === String(sessionEmail||'').toLowerCase());
      if(!mine.length){
        ordersWrap.classList.add('empty');
        ordersWrap.textContent = 'Aucune commande pour le moment.';
        return;
      }
      ordersWrap.classList.remove('empty');
      ordersWrap.innerHTML = mine.slice().reverse().map(o=>{
        const total = (o.items||[]).reduce((s,x)=> s + Number(x.price||0)*Number(x.qty||1), 0);
        return `
          <div class="order">
            <div class="top">
              <strong>Commande #${o.id||'‚Äî'}</strong>
              <span class="pill">${new Date(o.date||Date.now()).toLocaleString('fr-FR')}</span>
              <span class="pill">${o.status||'Pay√©e'}</span>
              <span style="margin-left:auto;font-weight:700">${EUR(total)}</span>
            </div>
            <div class="muted">${(o.items||[]).map(x=>`${x.qty}√ó ${x.name}`).join(' ‚Ä¢ ') || '‚Äî'}</div>
            <div class="row">
              <a class="btn" href="${GH_ROOT}checkout.html"><img class="ic" src="${ICONS.box}" alt="" role="presentation"> Voir les d√©tails</a>
              <button class="btn" data-reorder="${o.id}" type="button"><img class="ic" src="${ICONS.cart}" alt="" role="presentation"> Recommander</button>
            </div>
          </div>
        `;
      }).join('');

      // Reorder handler
      ordersWrap.addEventListener('click', e=>{
        const btn = e.target.closest('[data-reorder]');
        if(!btn) return;
        const id = btn.getAttribute('data-reorder');
        const found = mine.find(x=>String(x.id)===String(id));
        if(!found) return;
        const cart = getCart();
        for(const it of (found.items||[])){
          const idx = cart.findIndex(c=>c.id===it.id && c.name===it.name);
          if(idx>-1) cart[idx].qty += Number(it.qty||1);
          else cart.push({
            id: it.id, name: it.name, qty: Number(it.qty||1),
            price: Number(it.price||0), image: it.image||'',
            brand: it.brand||'', category: it.category||''
          });
        }
        saveCart(cart);
        $('#kpiCart').textContent = cartCount();
        const icon = $('#cartIcon'); if(icon) icon.src = ICONS.cartFull;
        alert('Les articles de la commande ont √©t√© ajout√©s au panier.');
      }, { once: true }); // on attache une fois pour √©viter les doublons
    }

    // --- Rendu adresse (profil Apps Script)
    function renderAddressFromProfile(profile, fallbackName){
      const addrBox = $('#addrBox'); if(!addrBox) return;
      const hasAddress = (profile.address||profile.city||profile.zip||profile.phone);
      if(!hasAddress){
        addrBox.classList.add('empty');
        addrBox.textContent = 'Aucune adresse enregistr√©e.';
        return;
      }
      addrBox.classList.remove('empty');
      const partsLine = [profile.address||'', profile.zip||'', profile.city||''].filter(Boolean).join(', ');
      addrBox.innerHTML = `
        <div><strong>${profile.name || fallbackName || 'Client'}</strong></div>
        <div>${partsLine || '‚Äî'}</div>
        <div>${profile.country || ''}</div>
        <div class="muted" style="margin-top:6px">${profile.phone ? '‚òé ' + profile.phone : ''}</div>
      `;
    }

    // --- D√©marrage
    async function init(){
      setIcons();
      wireLinks();
      wireMenu();

      // V√©rifie la pr√©sence de GFAuth
      if(!window.GFAuth || typeof window.GFAuth.getSession!=='function'){
        console.error('GFAuth introuvable. V√©rifie /compte/js/auth.js');
        alert('Erreur de chargement de l‚Äôauthentification. R√©essaie plus tard.');
        return;
      }

      // Session requise sinon redirection vers login.html?next=‚Ä¶
      const sess = window.GFAuth.getSession();
      if(!sess || !sess.email){
        const next = encodeURIComponent(location.href);
        location.replace(GH_ROOT + 'compte/login.html?next=' + next);
        return;
      }

      // Ent√™te & actions
      const go = path => location.href = GH_ROOT + path;
      $('#btnProfile').addEventListener('click', ()=> go('compte/profile.html'));
      $('#btnPwd').addEventListener('click', ()=> go('compte/password-change.html'));
      $('#btnEditAddress').addEventListener('click', ()=> go('compte/profile.html#adresse'));

      $('#btnLogout').addEventListener('click', ()=>{
        window.GFAuth.clearSession();
        location.replace(GH_ROOT + 'compte/login.html');
      });

      $('#btnDelete').addEventListener('click', ()=>{
        if(!confirm('Confirmer la suppression des donn√©es locales (panier/commandes d√©mo) et la fermeture de session ?')) return;
        // Efface les donn√©es locales de d√©mo
        saveCart([]);
        const remaining = getOrders().filter(o => String(o.userId||'').toLowerCase() !== String(sess.email||'').toLowerCase());
        saveOrders(remaining);
        // Ferme la session
        window.GFAuth.clearSession();
        location.replace(GH_ROOT + 'compte/register.html');
      });

      // Lien Panier => checkout
      $('#cartBtn').addEventListener('click', e=>{
        e.preventDefault();
        go('checkout.html');
      });

      // Remplit infos de session
      const nameFromSess = sess.name || (sess.email?.split('@')[0]) || 'Client';
      $('#userName').textContent = nameFromSess;
      $('#userEmail').textContent = sess.email || '‚Äî';
      const initial = (nameFromSess||'?').trim().charAt(0).toUpperCase();
      $('#avatar').textContent = initial;
      if(sess.loggedAt){
        const d = new Date(sess.loggedAt);
        if(!isNaN(+d)) $('#lastLogin').textContent = 'Derni√®re connexion : ' + d.toLocaleString('fr-FR');
      }

      // KPIs (panier + commandes locales)
      const ordersAll = getOrders();
      const mine = ordersAll.filter(o => String(o.userId||'').toLowerCase() === String(sess.email||'').toLowerCase());
      $('#kpiOrders').textContent = mine.length;
      $('#kpiCart').textContent = cartCount();

      // Ic√¥ne panier selon contenu
      const icon = $('#cartIcon'); if(icon) icon.src = cartCount() > 0 ? ICONS.cartFull : ICONS.cart;

      // Commandes (local)
      renderOrders(ordersAll, sess.email);

      // Profil depuis la base (Apps Script / Google Sheet)
      try{
        const list = await window.GFAuth.api.listUsers(); // retourne un tableau [{email, name, phone, address, city, zip, ...}]
        const me = (list || []).find(u => (u.email||'').toLowerCase() === (sess.email||'').toLowerCase());
        // Met √† jour l‚Äôaffichage du nom si pr√©sent c√¥t√© base
        if(me && me.name){
          $('#userName').textContent = me.name;
          $('#avatar').textContent = (me.name.trim().charAt(0) || initial).toUpperCase();
        }
        // KPI adresse & bloc adresse
        const hasAddr = me && (me.address || me.city || me.zip || me.phone);
        $('#kpiAddresses').textContent = hasAddr ? 1 : 0;
        renderAddressFromProfile(me || {}, $('#userName').textContent);
      }catch(err){
        console.warn('Impossible de r√©cup√©rer le profil via API:', err);
        // Fallback : KPI adresse = 0
        $('#kpiAddresses').textContent = 0;
        renderAddressFromProfile({}, nameFromSess);
      }
    }

    // Lance quand le DOM est pr√™t (auth.js est charg√© avec defer)
    document.addEventListener('DOMContentLoaded', init);
  })();
  </script>
</body>
</html>
