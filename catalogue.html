<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Catalogue — GF Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

  <!-- Vendor + Theme CSS -->
  <link rel="stylesheet" href="css/vendor.css">
  <link rel="stylesheet" href="style.css">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;700&family=Marcellus&display=swap" rel="stylesheet" />

  <style>
    /* Ajustements spécifiques catalogue */
    body{scroll-behavior:smooth}
    .navbar.fixed-top{backdrop-filter:saturate(1.8) blur(6px)}
    .catalog-hero{
      background:#0f0f10 url('images/banner-image-6.jpg') center/cover no-repeat;
      color:#fff; padding:92px 0 56px; margin-top:56px; position:relative;
    }
    .catalog-hero::after{content:""; position:absolute; inset:0; background:rgba(0,0,0,.35)}
    .catalog-hero .container{position:relative; z-index:2}
    .product-card .ratio img{object-fit:cover}
    .badge-new{background:#111}
    .cursor-pointer{cursor:pointer}
    .skeleton{background:linear-gradient(90deg,#eee 25%,#f6f6f6 37%,#eee 63%); background-size:400% 100%; animation:shimmer 1.1s infinite linear}
    @keyframes shimmer{0%{background-position:100% 0}100%{background-position:0 0}}
    .offcanvas .price-sm{font-variant-numeric:tabular-nums}
    .filter-chip{display:inline-flex;gap:.5rem;align-items:center;border:1px solid #ddd;border-radius:999px;padding:.25rem .6rem;font-size:.875rem}
    .filter-chip button{border:0;background:transparent;padding:0 .2rem;line-height:1}
    .footer-mini-logo{height:22px;opacity:.8}
  </style>
</head>
<body class="homepage">

  <!-- Icônes SVG -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display:none">
    <defs>
      <symbol id="search" viewBox="0 0 24 24"><path fill="currentColor" d="M21.71 20.29 18 16.61A9 9 0 1 0 16.61 18l3.68 3.68a1 1 0 0 0 1.42 0 1 1 0 0 0 0-1.39ZM11 18a7 7 0 1 1 7-7 7 7 0 0 1-7 7Z"/></symbol>
      <symbol id="cart" viewBox="0 0 24 24"><path fill="currentColor" d="M8.5 19a1.5 1.5 0 1 0 1.5 1.5A1.5 1.5 0 0 0 8.5 19ZM19 16H7a1 1 0 0 1 0-2h8.49a3 3 0 0 0 2.89-2.18l1.58-5.55A1 1 0 0 0 19 5H6.74a3 3 0 0 0-2.82-2H3a1 1 0 0 0 0 2h.92l.16.55 1.64 5.74A3 3 0 0 0 7 18h12a1 1 0 0 0 0-2Z"/></symbol>
      <symbol id="heart" viewBox="0 0 24 24"><path fill="currentColor" d="M20.16 4.61A6.27 6.27 0 0 0 12 4a6.27 6.27 0 0 0-8.16 9.48l7.45 7.45a1 1 0 0 0 1.42 0l7.45-7.45a6.27 6.27 0 0 0 0-8.87Z"/></symbol>
      <symbol id="close" viewBox="0 0 24 24"><path fill="currentColor" d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></symbol>
    </defs>
  </svg>

  <!-- Overlay Recherche -->
  <div class="search-popup" aria-hidden="true">
    <div class="search-popup-container">
      <form role="search" class="form-group" action="">
        <input type="search" id="overlay-search" class="form-control border-0 border-bottom" placeholder="Rechercher un article…"/>
        <button type="submit" class="search-submit border-0 position-absolute bg-white" style="top:15px;right:15px;">
          <svg width="24" height="24"><use xlink:href="#search"/></svg>
        </button>
      </form>
      <h5 class="cat-list-title mt-4">Catégories populaires</h5>
      <ul class="cat-list">
        <li class="cat-list-item"><a href="#" data-filter="homme">Hommes</a></li>
        <li class="cat-list-item"><a href="#" data-filter="femme">Femmes</a></li>
        <li class="cat-list-item"><a href="#" data-filter="enfant">Enfants</a></li>
        <li class="cat-list-item"><a href="#" data-filter="accessoires">Accessoires</a></li>
      </ul>
    </div>
  </div>

  <!-- HEADER -->
  <nav class="navbar navbar-expand-lg bg-light text-uppercase fs-6 p-3 border-bottom align-items-center fixed-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">GF Store</a>

      <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-label="Ouvrir le menu">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNavbar">
        <div class="offcanvas-header">
          <h5 class="offcanvas-title">Menu</h5>
          <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Fermer"></button>
        </div>
        <div class="offcanvas-body">
          <ul class="navbar-nav ms-auto gap-3">
            <li class="nav-item"><a class="nav-link" href="index.html#hommes">Hommes</a></li>
            <li class="nav-item"><a class="nav-link" href="index.html#femmes">Femmes</a></li>
            <li class="nav-item"><a class="nav-link" href="index.html#enfants">Enfants</a></li>
            <li class="nav-item"><a class="nav-link active" href="catalogue.html">Catalogue</a></li>
          </ul>
        </div>
      </div>

      <ul class="list-unstyled d-flex m-0 ms-3 align-items-center">
        <li class="search-box me-3">
          <a class="search-button" href="#search" aria-label="Recherche"><svg width="24" height="24"><use xlink:href="#search"/></svg></a>
        </li>
        <li class="me-3 d-none d-lg-block"><a href="#" aria-label="Wishlist"><svg width="24" height="24"><use xlink:href="#heart"/></svg></a></li>
        <li class="d-none d-lg-block">
          <a href="#" data-bs-toggle="offcanvas" data-bs-target="#offcanvasCart" aria-controls="offcanvasCart" aria-label="Ouvrir le panier">
            <svg width="24" height="24"><use xlink:href="#cart"/></svg>
            <span class="badge bg-dark ms-1 cart-count align-middle">0</span>
          </a>
        </li>
      </ul>
    </div>
  </nav>

  <!-- Panier -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasCart">
    <div class="offcanvas-header justify-content-between">
      <h5 class="m-0">Votre panier</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Fermer"></button>
    </div>
    <div class="offcanvas-body">
      <ul id="cart-list" class="list-group mb-3 small"></ul>
      <div class="d-flex justify-content-between align-items-center">
        <strong>Total</strong>
        <strong class="price-sm" id="cart-total">—</strong>
      </div>
      <div class="d-grid gap-2 mt-3">
        <a class="btn btn-dark btn-lg" href="checkout.html">Passer au paiement</a>
        <button class="btn btn-outline-secondary" id="cart-sync">Sauvegarder mon panier</button>
      </div>
    </div>
  </div>

  <!-- HERO + Fil d'Ariane -->
  <header class="catalog-hero text-center">
    <div class="container">
      <nav aria-label="breadcrumb" class="mb-2">
        <ol class="breadcrumb justify-content-center">
          <li class="breadcrumb-item"><a class="link-light text-decoration-none" href="index.html">Accueil</a></li>
          <li class="breadcrumb-item active text-white-50" aria-current="page">Catalogue</li>
        </ol>
      </nav>
      <h1 class="display-5 mb-1">Catalogue Hiver 2025</h1>
      <p class="mb-0">Doudounes, parkas, mailles & accessoires</p>
    </div>
  </header>

  <main id="content">

    <!-- Filtres / Recherche / Tri -->
    <section class="py-4">
      <div class="container">
        <div class="row g-3 align-items-end">
          <div class="col-lg-4">
            <label class="form-label">Recherche</label>
            <input id="q" type="search" class="form-control" placeholder="Doudoune, parka, bonnet…">
          </div>
          <div class="col-6 col-lg-2">
            <label class="form-label">Catégorie</label>
            <select id="filter" class="form-select">
              <option value="all">Tout</option>
              <option value="homme">Hommes</option>
              <option value="femme">Femmes</option>
              <option value="enfant">Enfants</option>
              <option value="accessoires">Accessoires</option>
            </select>
          </div>
          <div class="col-6 col-lg-2">
            <label class="form-label">Tri</label>
            <select id="sort" class="form-select">
              <option value="relevance">Pertinence</option>
              <option value="price-asc">Prix : croissant</option>
              <option value="price-desc">Prix : décroissant</option>
              <option value="newest">Nouveautés</option>
            </select>
          </div>
          <div class="col-6 col-lg-2">
            <label class="form-label">Prix min (€)</label>
            <input type="number" id="min" class="form-control" placeholder="0" min="0" step="1">
          </div>
          <div class="col-6 col-lg-2">
            <label class="form-label">Prix max (€)</label>
            <input type="number" id="max" class="form-control" placeholder="2000" min="0" step="1">
          </div>

          <div class="col-6 col-lg-2">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="only-new">
              <label class="form-check-label" for="only-new">Nouveaux</label>
            </div>
          </div>
          <div class="col-6 col-lg-2">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="in-stock">
              <label class="form-check-label" for="in-stock">En stock</label>
            </div>
          </div>

          <div class="col-lg-2 ms-auto d-grid">
            <button id="reset" class="btn btn-outline-secondary">Réinitialiser</button>
          </div>
        </div>

        <!-- chips de filtres actifs -->
        <div id="chips" class="d-flex flex-wrap gap-2 mt-3"></div>
      </div>
    </section>

    <!-- Résultats -->
    <section class="pb-5">
      <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div id="count" class="small text-secondary">Chargement…</div>
          <div class="small text-secondary">Livraison & retours gratuits</div>
        </div>

        <div id="grid" class="row g-4">
          <!-- skeletons init -->
          <template id="tpl-skel">
            <div class="col-6 col-md-4 col-lg-3">
              <div class="card h-100 border-0">
                <div class="ratio ratio-4x3 skeleton rounded"></div>
                <div class="card-body">
                  <div class="skeleton" style="height:16px;width:70%;border-radius:6px"></div>
                  <div class="skeleton mt-2" style="height:12px;width:40%;border-radius:6px"></div>
                </div>
              </div>
            </div>
          </template>
        </div>

        <!-- Pagination -->
        <nav class="d-flex justify-content-center mt-4">
          <ul id="pager" class="pagination m-0"></ul>
        </nav>
      </div>
    </section>

  </main>

  <!-- Template carte produit -->
  <template id="tpl-card">
    <div class="col-6 col-md-4 col-lg-3">
      <div class="card product-card h-100 border-0 shadow-sm">
        <a class="stretched-link text-reset text-decoration-none p-link" href="#">
          <div class="position-relative">
            <span class="position-absolute top-0 start-0 m-2 badge badge-new text-uppercase d-none">Nouveau</span>
            <div class="ratio ratio-4x3">
              <img class="w-100 h-100" alt="">
            </div>
          </div>
        </a>
        <div class="card-body">
          <h6 class="text-uppercase mb-1 name"></h6>
          <div class="small text-secondary mb-2 meta"></div>
          <div class="d-flex justify-content-between align-items-center">
            <div class="fw-semibold price"></div>
            <button class="btn btn-sm btn-dark text-uppercase add cursor-pointer">Ajouter</button>
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- FOOTER -->
  <footer class="border-top">
    <div class="container">
      <div class="row py-5">
        <div class="col-md-4">
          <h5 class="text-uppercase mb-3">GF Store</h5>
          <p>Du suivi expert aux rendez-vous sur mesure : une expérience entièrement dédiée à l’hiver.</p>
          <div class="d-flex gap-3">
            <img src="images/visa-card.png" class="footer-mini-logo" alt="Visa">
            <img src="images/paypal-card.png" class="footer-mini-logo" alt="PayPal">
            <img src="images/master-card.png" class="footer-mini-logo" alt="Mastercard">
          </div>
        </div>
        <div class="col-6 col-md-2">
          <h6 class="text-uppercase mb-3">Boutique</h6>
          <ul class="list-unstyled">
            <li><a href="index.html#hommes">Hommes</a></li>
            <li><a href="index.html#femmes">Femmes</a></li>
            <li><a href="index.html#enfants">Enfants</a></li>
            <li><a href="catalogue.html">Catalogue</a></li>
          </ul>
        </div>
        <div class="col-6 col-md-3">
          <h6 class="text-uppercase mb-3">Aide</h6>
          <ul class="list-unstyled">
            <li><a href="#">Livraison</a></li>
            <li><a href="#">Retours & échanges</a></li>
            <li><a href="#">FAQ</a></li>
            <li><a href="contact.html">Contact</a></li>
          </ul>
        </div>
        <div class="col-md-3">
          <h6 class="text-uppercase mb-3">Newsletter</h6>
          <form class="d-flex gap-2">
            <input type="email" class="form-control" placeholder="Votre email" required>
            <button class="btn btn-dark" type="submit">OK</button>
          </form>
          <small class="text-secondary d-block mt-2">En vous inscrivant, vous acceptez notre politique de confidentialité.</small>
        </div>
      </div>
      <div class="d-flex flex-wrap justify-content-between align-items-center py-3 border-top small">
        <span>© 2025 GF Store. Tous droits réservés.</span>
        <span>Livraison & retours gratuits • Service client dédié</span>
      </div>
    </div>
  </footer>

  <!-- JS vendor -->
  <script src="js/jquery.min.js"></script>
  <script src="js/modernizr.js"></script>
  <script src="js/plugins.js"></script>
  <script src="js/SmoothScroll.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <!-- App + Products helpers -->
  <script src="app.js"></script>
  <script src="data/products.js"></script>

  <!-- App Catalogue (frontend léger, basé sur Products.js) -->
  <script>
  (function () {
    // ---- DOM
    const grid = document.getElementById('grid');
    const pager = document.getElementById('pager');
    const count = document.getElementById('count');
    const q = document.getElementById('q');
    const filter = document.getElementById('filter');
    const sort = document.getElementById('sort');
    const min = document.getElementById('min');
    const max = document.getElementById('max');
    const onlyNew = document.getElementById('only-new');
    const inStock = document.getElementById('in-stock');
    const resetBtn = document.getElementById('reset');
    const chips = document.getElementById('chips');

    const overlay = document.querySelector('.search-popup');
    document.querySelectorAll('.search-button').forEach(a=>{
      a.addEventListener('click', (e)=>{ e.preventDefault(); overlay.classList.add('is-visible'); });
    });
    overlay?.addEventListener('click', (e)=> { if(e.target === overlay) overlay.classList.remove('is-visible'); });
    document.getElementById('overlay-search')?.addEventListener('input',(e)=>{ q.value = e.target.value; apply(); });

    // Panier (minimal local si App.js n’est pas chargé)
    const cart = { items: [] };
    const cartCountEls = document.querySelectorAll('.cart-count');
    const cartList = document.getElementById('cart-list');
    const cartTotal = document.getElementById('cart-total');
    document.getElementById('cart-sync')?.addEventListener('click', ()=> { window.App?.syncCart?.(cart.items); });

    // ---- Config
    const DETAIL_PAGE = 'produit.html'; // si tu préfères 'products.html', change juste cette ligne
    const PAGE_SIZE = 12;
    let all = [];   // produits source
    let view = [];  // produits filtrés
    let page = 1;

    // ---- Utils produits
    const getName = p => p.title || p.name || 'Produit';
    const getPrice = p => Number(p.price ?? 0);
    const getCategory = p => {
      const raw = (p.category || '').toString().toLowerCase();
      const map = { kids:'Enfants', men:'Hommes', women:'Femmes', enfant:'Enfants', homme:'Hommes', femme:'Femmes' };
      return map[raw] || (raw ? raw.charAt(0).toUpperCase()+raw.slice(1) : 'Produit');
    };
    const getCatKey = p => (p.category || '').toString().toLowerCase();
    const isNew = p => (p.is_new === true) || (p.tags||[]).some(t=>String(t).toLowerCase().includes('nouveau'));
    const isStock = p => {
      if (p.stock && typeof p.stock === 'object') return Object.values(p.stock).some(v=>Number(v)>0);
      if (typeof p.stock === 'number') return p.stock > 0;
      return true;
    };
    const formatPrice = (n, cur='EUR') => Number(n||0).toLocaleString('fr-FR', {style:'currency', currency:cur});
    const matchesQuery = (p, text) => {
      if (!text) return true;
      const hay = (getName(p) + ' ' + (p.subtitle || '') + ' ' + (p.brand || '') + ' ' + getCategory(p)).toLowerCase();
      return hay.includes(text.toLowerCase());
    };
    const matchFilter = (p, val) => {
      if (val === 'all') return true;
      const c = getCatKey(p);
      const map = {
        'homme': ['homme','hommes','men','man'],
        'femme': ['femme','femmes','women','woman'],
        'enfant': ['enfant','enfants','kids','kid','junior','boy','girl'],
        'accessoires': ['accessoires','accessory','accessories','cap','hat','gloves','bonnet','echarpe','scarf']
      };
      return (map[val] || [val]).some(k => c.includes(k));
    };
    const firstImage = p => (window.Products?.utils.firstImage(p)) || 'images/product-item-1.jpg';
    const productHref = p => {
      if (window.Products?.utils?.productUrl) {
        const color = p.colors?.[0]?.code;
        const url = window.Products.utils.productUrl(p, { color });
        return url.replace('produit.html', DETAIL_PAGE);
      }
      // Fallback si products.js absent
      const sku = encodeURIComponent(p.sku || '');
      return `${DETAIL_PAGE}?sku=${sku}`;
    };

    // ---- Panier UI (fallback local)
    function updateCartUI(){
      const totalQty = cart.items.reduce((s,i)=>s+i.qty,0);
      cartCountEls.forEach(el=> el.textContent = totalQty);
      cartList.innerHTML = '';
      if(!cart.items.length){
        cartList.innerHTML = '<li class="list-group-item d-flex justify-content-between align-items-center">Panier vide</li>';
        cartTotal.textContent = '—';
        return;
      }
      let total = 0;
      cart.items.forEach(item=>{
        total += item.qty * item.price;
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.innerHTML = `
          <div class="me-2 flex-fill">
            <div class="fw-semibold small text-uppercase">${item.name}</div>
            <div class="text-secondary small">${item.category || ''}</div>
            <div class="small price-sm">${(item.price).toLocaleString('fr-FR',{style:'currency', currency:'EUR'})} × ${item.qty}</div>
          </div>
          <button class="btn btn-sm btn-outline-secondary me-2 minus">–</button>
          <button class="btn btn-sm btn-outline-secondary me-2 plus">+</button>
          <button class="btn btn-sm btn-outline-danger" title="Retirer">Supprimer</button>
        `;
        li.querySelector('.plus').addEventListener('click', ()=>{ item.qty++; updateCartUI(); window.App?.addToCart?.(item,1); });
        li.querySelector('.minus').addEventListener('click', ()=>{ item.qty=Math.max(1,item.qty-1); updateCartUI(); window.App?.addToCart?.(item,-1); });
        li.querySelector('.btn-outline-danger').addEventListener('click', ()=> {
          cart.items = cart.items.filter(i=>i.id!==item.id);
          updateCartUI();
          window.App?.removeFromCart?.(item);
        });
        cartList.appendChild(li);
      });
      cartTotal.textContent = total.toLocaleString('fr-FR',{style:'currency', currency:'EUR'});
    }
    function addToCart(p){
      const id = (p.sku || getName(p));
      const existing = cart.items.find(i=>i.id===id);
      const payload = { id, name:getName(p), price:getPrice(p), category:getCategory(p) || '', qty:1 };
      if(existing){ existing.qty++; } else { cart.items.push(payload); }
      updateCartUI();
      window.App?.addToCart?.(payload, 1);
    }

    // ---- Rendu
    function render() {
      const PAGE_SIZE = Number(window.App?.pageSize || 12);
      const total = view.length;
      const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      if (page > pages) page = pages;

      count.textContent = total ? `${total} article${total>1?'s':''} — page ${page}/${pages}` : 'Aucun article';

      const start = (page - 1) * PAGE_SIZE;
      const slice = view.slice(start, start + PAGE_SIZE);

      grid.innerHTML = '';
      const tpl = document.getElementById('tpl-card');
      slice.forEach(p => {
        const node = tpl.content.cloneNode(true);
        const link = node.querySelector('.p-link');
        const img = node.querySelector('img');
        const name = node.querySelector('.name');
        const meta = node.querySelector('.meta');
        const price = node.querySelector('.price');
        const badge = node.querySelector('.badge-new');
        const addBtn = node.querySelector('.add');

        link.href = productHref(p);
        img.src = firstImage(p);
        img.alt = getName(p);
        name.textContent = getName(p);
        meta.textContent = getCategory(p) || '—';
        price.textContent = formatPrice(getPrice(p), p.currency || 'EUR');
        if (isNew(p)) badge.classList.remove('d-none');

        addBtn.addEventListener('click', (e) => {
          e.preventDefault();
          addBtn.textContent = 'Ajouté ✓';
          addBtn.disabled = true;
          addToCart(p);
          setTimeout(() => { addBtn.textContent = 'Ajouter'; addBtn.disabled = false; }, 900);
        });

        grid.appendChild(node);
      });

      // pager
      pager.innerHTML = '';
      const makeItem = (label, p, disabled=false, active=false) => {
        const li = document.createElement('li');
        li.className = `page-item ${disabled?'disabled':''} ${active?'active':''}`;
        const a = document.createElement('a');
        a.className = 'page-link';
        a.href = '#';
        a.textContent = label;
        a.addEventListener('click', (e)=>{e.preventDefault(); if(!disabled){ page=p; render(); window.scrollTo({top:0,behavior:'smooth'});} });
        li.appendChild(a);
        return li;
      };
      pager.appendChild(makeItem('«', 1, page===1));
      pager.appendChild(makeItem('‹', page-1, page===1));
      const windowSize = 3;
      let from = Math.max(1, page - windowSize);
      let to = Math.min(pages, page + windowSize);
      for (let i=from; i<=to; i++) pager.appendChild(makeItem(String(i), i, false, i===page));
      pager.appendChild(makeItem('›', page+1, page===pages));
      pager.appendChild(makeItem('»', pages, page===pages));
    }

    function refreshChips(){
      chips.innerHTML = '';
      const addChip = (label, onX) => {
        const chip = document.createElement('span');
        chip.className = 'filter-chip';
        chip.innerHTML = `<span>${label}</span><button title="Retirer"><svg width="16" height="16"><use xlink:href="#close"/></svg></button>`;
        chip.querySelector('button').addEventListener('click', onX);
        chips.appendChild(chip);
      };
      if(q.value) addChip(`Recherche: "${q.value}"`, ()=>{ q.value=''; apply(); });
      if(filter.value!=='all') addChip(`Catégorie: ${filter.options[filter.selectedIndex].text}`, ()=>{ filter.value='all'; apply(); });
      if(sort.value!=='relevance') addChip(`Tri: ${sort.options[sort.selectedIndex].text}`, ()=>{ sort.value='relevance'; apply(); }); /* ← fix d’index */
      if(min.value) addChip(`Min: ${min.value}€`, ()=>{ min.value=''; apply(); });
      if(max.value) addChip(`Max: ${max.value}€`, ()=>{ max.value=''; apply(); });
      if(onlyNew.checked) addChip('Nouveaux', ()=>{ onlyNew.checked=false; apply(); });
      if(inStock.checked) addChip('En stock', ()=>{ inStock.checked=false; apply(); });
    }

    function apply() {
      // filtres
      const text = q.value.trim();
      const f = filter.value;
      const minV = Number(min.value || 0);
      const maxV = Number(max.value || Infinity);

      view = all.filter(p => {
        const okQuery = matchesQuery(p, text);
        const okCat = matchFilter(p, f);
        const price = getPrice(p);
        const okPrice = price >= minV && price <= maxV;
        const okNew = !onlyNew.checked || isNew(p);
        const okStock = !inStock.checked || isStock(p);
        return okQuery && okCat && okPrice && okNew && okStock;
      });

      // tri
      switch (sort.value) {
        case 'price-asc': view.sort((a,b)=> getPrice(a)-getPrice(b)); break;
        case 'price-desc': view.sort((a,b)=> getPrice(b)-getPrice(a)); break;
        case 'newest':
          view.sort((a,b)=> (new Date(b.created_at||b.date||0)) - (new Date(a.created_at||a.date||0)));
          break;
        default:
          view.sort((a,b)=>{
            const wa = (isNew(a)?1:0) + (matchesQuery(a, q.value)?1:0);
            const wb = (isNew(b)?1:0) + (matchesQuery(b, q.value)?1:0);
            return wb - wa;
          });
      }

      page = 1;
      refreshChips();
      render();
    }

    // ---- Événements UI
    [q, min, max].forEach(el=> el.addEventListener('input', apply));
    [filter, sort, onlyNew, inStock].forEach(el=> el.addEventListener('change', apply));
    resetBtn.addEventListener('click', () => {
      q.value
