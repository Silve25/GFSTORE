<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GF Store — Test chargement produits</title>
  <style>
    body{font-family:system-ui,Arial;margin:20px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px}
    .card{border:1px solid #ddd;border-radius:10px;padding:10px;background:#fafafa}
    .card img{max-width:100%;height:140px;object-fit:contain;background:#fff;border-radius:8px}
    #status{padding:10px;border-radius:8px;margin:10px 0;background:#f1f5f9}
    code{background:#eef;padding:2px 6px;border-radius:6px}
  </style>
</head>
<body>
  <h1>GF Store — Chargement des produits</h1>

  <!-- Zone d'état : succès / erreurs -->
  <div id="status">Chargement…</div>

  <!-- Conteneur des produits -->
  <div id="list" class="grid"></div>

  <script>
  // ——————————————————————————————————————————————————————————
  //  Page test MINIMALE pour charger un JSON de produits
  //  1) Placez votre fichier ici :  data/products.json
  //  2) Ou passez une URL en paramètre : ?data=/GFSTORE/data/products.json
  //  3) N'ouvrez PAS le fichier en file:// (Chrome bloque fetch). Servez en http(s).
  // ——————————————————————————————————————————————————————————

  const $ = sel => document.querySelector(sel);
  const fmt = n => typeof n === "number"
    ? new Intl.NumberFormat("fr-FR",{style:"currency",currency:"EUR"}).format(n)
    : (n ?? "");

  // Permet de forcer une URL via ?data=...
  const override = new URLSearchParams(location.search).get("data");

  // Chemins testés (compatibles GitHub Pages)
  const CANDIDATES = [
    override,
    "data/products.json","./data/products.json",
    "data/produits.json","./data/produits.json",
    "products.json","./products.json",
    "/GFSTORE/data/products.json","/GFSTORE/products.json","/GFSTORE/data/produits.json"
  ].filter(Boolean);

  // Accepte : [] ou {products:[]}/{items:[]}/{data:[]}
  const normalize = (j)=> Array.isArray(j) ? j
    : (Array.isArray(j?.products) ? j.products
    : (Array.isArray(j?.items) ? j.items
    : (Array.isArray(j?.data) ? j.data : null)));

  async function tryFetch(url){
    try{
      const r = await fetch(url, {cache:"no-store"});
      if(!r.ok) throw new Error("HTTP "+r.status);
      // ⚠️ Si votre JSON contient des virgules décimales (ex: 179,99),
      // c'est invalide en JSON → JSON.parse échouera ici.
      const raw = await r.json();
      const arr = normalize(raw);
      if(!arr) throw new Error("JSON non conforme (attendu: tableau ou {products|items|data}[])");
      return {ok:true, data:arr, url};
    }catch(e){
      return {ok:false, url, error: e?.message || String(e)};
    }
  }

  function render(list){
    const box = $("#list"); box.innerHTML = "";
    list.forEach(p=>{
      const img = p.imageCover || (Array.isArray(p.images) && p.images[0]) || p.image || "https://via.placeholder.com/400x300?text=GF+Store";
      const price = Number(p.promoPrice ?? p.price ?? 0);
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <img src="${img}" alt="">
        <h3 style="font-size:1rem;margin:.6rem 0">${p.name || p.nom || p.title || "Produit"}</h3>
        <div style="color:#555">${p.brand || p.marque || ""} ${p.category ? "• "+p.category : ""}</div>
        <p style="font-weight:800;margin:.4rem 0">${price ? fmt(price) : ""}</p>
      `;
      box.appendChild(card);
    });
  }

  (async function(){
    const status = $("#status");
    const attempts = [];
    let found = null;

    // Information utile si ouvert en file://
    if(location.protocol === "file:"){
      status.innerHTML = "⚠️ Cette page est ouverte en <code>file://</code>. Les navigateurs bloquent <code>fetch</code> sur fichiers locaux. Lancez un petit serveur (ex. <code>python -m http.server</code>) puis rechargez.";
    }

    // Essaie chaque chemin, s'arrête au premier succès
    for(const u of CANDIDATES){
      const res = await tryFetch(u);
      attempts.push(res);
      if(res.ok){ found = res; break; }
    }

    if(found){
      // ✅ Succès : on indique la source utilisée
      status.innerHTML = "✅ Produits chargés depuis : <code>"+found.url+"</code> ("+found.data.length+" éléments)";
      render(found.data);
    }else{
      // ❌ Échec : on affiche un résumé lisible + le détail des erreurs
      const lines = attempts.map(a => `${a.url} → ${a.ok ? "OK" : a.error}`).join("\n");
      status.innerHTML = `
        ❌ Impossible de charger les produits.<br>
        Essayés : <code>${CANDIDATES.join("</code>, <code>")}</code><br>
        <details style="margin-top:.5rem"><summary>Voir le détail des erreurs</summary>
          <pre style="white-space:pre-wrap">${lines}</pre>
        </details>
        <small>Vérifiez le chemin, le nom du fichier et le <code>Content-Type: application/json</code> sur GitHub Pages.</small>
      `;
      $("#list").innerHTML = "";
    }
  })();
  </script>
</body>
</html>
