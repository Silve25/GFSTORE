<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Réinitialiser le mot de passe — GF Store</title>
  <style>
    :root{--w:860px;--c:#0f172a;--a:#2563eb;--g:#10b981;--bg:#f5f7fb;--r:16px}
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;color:var(--c);background:var(--bg)}
    a{color:inherit}
    header{position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid #e5e7eb;backdrop-filter:saturate(140%) blur(4px)}
    .hwrap{max-width:var(--w);margin:auto;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand .logo{height:34px;width:auto;display:block}
    .nav{display:flex;gap:8px;align-items:center}
    .iconbtn,.nav a{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid #e5e7eb;background:#fff;border-radius:12px;text-decoration:none;color:inherit}
    .iconbtn{cursor:pointer}
    .ic{width:16px;height:16px;display:inline-block}
    .dropdown{position:relative}
    .menu{position:absolute;right:0;top:calc(100% + 8px);background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:6px;min-width:220px;box-shadow:0 10px 24px rgba(0,0,0,.12);display:none;z-index:30}
    .menu.show{display:block}
    .menu a{display:block;padding:8px 10px;border-radius:8px;text-decoration:none}
    .menu a:hover{background:#f3f4f6}

    .wrap{max-width:600px;margin:18px auto 28px;padding:0 12px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 1px 0 rgba(0,0,0,.02);padding:16px}
    h1{font-size:20px;margin:6px 0 2px}
    .muted{opacity:.7;font-size:13px;margin-bottom:12px}

    form{display:grid;gap:12px}
    .row{display:grid;gap:6px}
    label{font-weight:600}
    input[type=text],input[type=email],input[type=password],input[type=number]{width:100%;padding:12px;border:1px solid #e5e7eb;border-radius:12px;background:#fff}
    .hint{font-size:12px;opacity:.7}

    .pw{position:relative}
    .pw .toggle{position:absolute;right:8px;top:50%;transform:translateY(-50%);border:1px solid #e5e7eb;background:#fff;border-radius:10px;padding:6px 8px;cursor:pointer;font-size:12px}

    .meter{height:8px;background:#f1f5f9;border-radius:999px;overflow:hidden;border:1px solid #e5e7eb}
    .meter>i{display:block;height:100%;width:0;transition:width .2s}
    .meter[data-lvl="1"]>i{width:25%;background:#ef4444}
    .meter[data-lvl="2"]>i{width:50%;background:#f59e0b}
    .meter[data-lvl="3"]>i{width:75%;background:#10b981}
    .meter[data-lvl="4"]>i{width:100%;background:#10b981}

    .actions{display:flex;flex-wrap:wrap;gap:8px;align-items:center;justify-content:space-between}
    .btn{display:inline-flex;align-items:center;gap:8px;justify-content:center;padding:12px 14px;border:1px solid #1e40af;background:linear-gradient(180deg,#2563eb,#1e40af);color:#fff;border-radius:12px;cursor:pointer;min-width:160px}
    .btn.secondary{background:#fff;border:1px solid #e5e7eb;color:#111}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .alert{border-radius:12px;padding:10px 12px;border:1px solid #fecaca;background:#fef2f2;color:#991b1b;display:none}
    .alert.show{display:block}
    .ok{border-radius:12px;padding:10px 12px;border:1px solid #bbf7d0;background:#f0fdf4;color:#166534;display:none}
    .ok.show{display:block}

    .codebox{display:flex;gap:8px;align-items:center}
    .countdown{font-size:12px;opacity:.7}

    footer{background:#fff;border-top:1px solid #e5e7eb;margin-top:26px}
    .fwrap{max-width:var(--w);margin:0 auto;padding:16px 12px;display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center;font-size:12px}
    .fwrap a{text-decoration:none;color:inherit;opacity:.9}
    .fwrap a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <header>
    <div class="hwrap">
      <a href="../index.html" class="brand">
        <img src="../assets/img/logopnggfstore.png" class="logo" alt="GF Store" width="180" height="52" decoding="async">
      </a>
      <nav class="nav">
        <a href="./login.html"><img class="ic" id="icUser" alt=""> Retour connexion</a>
        <div class="dropdown">
          <button class="iconbtn" id="menuBtn" aria-label="Menu"><img class="ic" id="icMenu" alt=""></button>
          <div id="menuDrop" class="menu">
            <a href="../a-propos.html">À propos</a>
            <a href="../cgv.html">CGV</a>
            <a href="../mentions-legales.html">Mentions légales</a>
            <a href="../confidentialite.html">Confidentialité</a>
            <a href="../contact.html">Contact</a>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <h1>Réinitialiser le mot de passe</h1>
      <div class="muted">Entrez votre email pour recevoir un code puis choisissez un nouveau mot de passe.<br>
        <strong>Démo locale :</strong> le code s’affichera ci-dessous (pas d’envoi email).</div>

      <div id="err" class="alert" role="alert"></div>
      <div id="ok" class="ok" role="status"></div>

      <form id="form" novalidate>
        <!-- Étape 1: Email -->
        <div id="step1">
          <div class="row">
            <label for="email">Votre email</label>
            <input id="email" name="email" type="email" placeholder="vous@exemple.com" autocomplete="email" required>
            <div class="hint">Si un compte existe pour cet email, un code sera généré.</div>
          </div>
          <div class="actions">
            <a class="btn secondary" href="./login.html">Annuler</a>
            <button id="sendBtn" class="btn" type="button"><img class="ic" id="icSend" alt=""> Envoyer le code</button>
          </div>

          <div id="demoCode" class="ok" style="margin-top:10px" aria-live="polite"></div>
          <div id="resendWrap" class="countdown" style="display:none">Renvoyer dans <span id="wait">60</span>s…</div>
        </div>

        <!-- Étape 2: Code + nouveau mot de passe -->
        <div id="step2" style="display:none; margin-top:10px">
          <div class="row">
            <label for="code">Code de vérification (6 chiffres)</label>
            <input id="code" name="code" type="number" inputmode="numeric" pattern="[0-9]*" placeholder="Ex. 123456" required>
          </div>

          <div class="row pw">
            <label for="password">Nouveau mot de passe</label>
            <input id="password" name="password" type="password" placeholder="Au moins 8 caractères" autocomplete="new-password" required>
            <button type="button" class="toggle" data-target="password">Afficher</button>
            <div class="meter" id="meter"><i></i></div>
            <div class="hint">Utilisez majuscules, minuscules, chiffres et symbole.</div>
          </div>

          <div class="row pw">
            <label for="password2">Confirmer le nouveau mot de passe</label>
            <input id="password2" name="password2" type="password" placeholder="Ressaisissez le mot de passe" autocomplete="new-password" required>
            <button type="button" class="toggle" data-target="password2">Afficher</button>
          </div>

          <div class="actions">
            <button id="backBtn" class="btn secondary" type="button">← Modifier l’email</button>
            <button id="resetBtn" class="btn" type="submit"><img class="ic" id="icReset" alt=""> Mettre à jour</button>
          </div>
        </div>
      </form>
    </div>
  </main>

  <footer>
    <div class="fwrap">
      <div>© GF Store 2025 — Simplicité, sécurité, crypto-friendly.</div>
      <nav>
        <a href="../a-propos.html">À propos</a> ·
        <a href="../cgv.html">CGV</a> ·
        <a href="../mentions-legales.html">Mentions légales</a> ·
        <a href="../confidentialite.html">Confidentialité</a> ·
        <a href="../contact.html">Contact</a>
      </nav>
    </div>
  </footer>

  <script>
  (async()=>{
    // --- Icônes ---
    const ICONS={
      user:'https://img.icons8.com/?size=100&id=n8DrUm77sR3l&format=png&color=000000',
      menu:'https://img.icons8.com/?size=100&id=RzDomvpIKGI9&format=png&color=000000',
      send:'https://img.icons8.com/?size=100&id=86855&format=png&color=ffffff',
      reset:'https://img.icons8.com/?size=100&id=63257&format=png&color=ffffff'
    };
    const setSrc=(id,src)=>{const el=document.getElementById(id); if(el) el.src=src};
    setSrc('icUser', ICONS.user);
    setSrc('icMenu', ICONS.menu);
    setSrc('icSend', ICONS.send);
    setSrc('icReset', ICONS.reset);

    // --- Menu ---
    const menuBtn=document.getElementById('menuBtn'), menuDrop=document.getElementById('menuDrop');
    if(menuBtn&&menuDrop){
      menuBtn.addEventListener('click',e=>{e.stopPropagation();menuDrop.classList.toggle('show')});
      document.addEventListener('click',e=>{ if(!menuDrop.contains(e.target) && e.target!==menuBtn) menuDrop.classList.remove('show'); });
    }

    // --- Helpers (démo, front-only) ---
    const PEPPER='gfstore-pepper-demo-v1'; // ⚠️ Démo : en vrai, stocké côté serveur uniquement.
    const te=new TextEncoder();
    const toB64=buf=>btoa(String.fromCharCode(...new Uint8Array(buf)));
    async function sha256(str){ const buf=await crypto.subtle.digest('SHA-256', te.encode(str)); return toB64(buf); }
    async function hashPassword(password,saltB64){ return sha256(`${saltB64}:${password}:${PEPPER}`); }
    const rndInt=(min,max)=>Math.floor(min+crypto.getRandomValues(new Uint32Array(1))[0]/(2**32)*(max-min+1));
    const code6=()=>String(rndInt(0,999999)).padStart(6,'0');

    function getUsers(){ try{return JSON.parse(localStorage.getItem('gf_users')||'[]')}catch{return[]} }
    function setUsers(arr){ localStorage.setItem('gf_users', JSON.stringify(arr)); }

    function getTokens(){ try{return JSON.parse(localStorage.getItem('gf_reset_tokens')||'[]')}catch{return[]} }
    function setTokens(arr){ localStorage.setItem('gf_reset_tokens', JSON.stringify(arr)); }

    // Nettoyer les tokens expirés
    (function cleanupTokens(){
      const now=Date.now(); const t=getTokens().filter(x=>x.exp>now); setTokens(t);
    })();

    // --- DOM ---
    const $=s=>document.querySelector(s);
    const err=$('#err'), ok=$('#ok');
    const form=$('#form');
    const step1=$('#step1'), step2=$('#step2');
    const email=$('#email');
    const sendBtn=$('#sendBtn');
    const demoCode=$('#demoCode');
    const resendWrap=$('#resendWrap'), waitEl=$('#wait');
    const code=$('#code');
    const pw=$('#password'), pw2=$('#password2'), meter=$('#meter');
    const backBtn=$('#backBtn'), resetBtn=$('#resetBtn');

    function showErr(msg){ err.textContent=msg; err.classList.add('show'); ok.classList.remove('show'); }
    function showOk(msg){ ok.textContent=msg; ok.classList.add('show'); err.classList.remove('show'); }
    function clr(){ err.classList.remove('show'); ok.classList.remove('show'); demoCode.classList.remove('show'); }

    function isEmail(s){ return /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(String(s||'').trim()); }
    function strength(v){
      let s=0; if(v.length>=8) s++; if(/[A-Z]/.test(v)) s++; if(/[a-z]/.test(v)) s++; if(/[0-9\W_]/.test(v)) s++; return Math.min(s,4);
    }
    function updateMeter(){ meter.setAttribute('data-lvl', String(strength(pw.value)||0)); }
    pw.addEventListener('input', updateMeter); updateMeter();

    document.querySelectorAll('.toggle').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id=btn.getAttribute('data-target'); const input=document.getElementById(id);
        if(!input) return;
        const t=input.getAttribute('type')==='password'?'text':'password';
        input.setAttribute('type',t);
        btn.textContent=t==='password'?'Afficher':'Masquer';
      });
    });

    // --- Étape 1: envoyer code ---
    let countdown=null, remain=60;
    function startCountdown(){
      resendWrap.style.display='block';
      remain=60; waitEl.textContent=remain;
      sendBtn.disabled=true;
      clearInterval(countdown);
      countdown=setInterval(()=>{
        remain--; waitEl.textContent=remain;
        if(remain<=0){ clearInterval(countdown); resendWrap.style.display='none'; sendBtn.disabled=false; }
      },1000);
    }

    sendBtn.addEventListener('click',()=>{
      clr();
      const em=(email.value||'').trim().toLowerCase();
      if(!isEmail(em)){ showErr('Adresse email invalide.'); return; }

      // Générer token même si email inconnu (ne pas révéler l’existence)
      const codeVal=code6();
      const exp=Date.now()+10*60*1000; // 10 min
      let tokens=getTokens().filter(t=>t.email!==em); // 1 token actif par email
      tokens.push({email:em, code:codeVal, exp}); setTokens(tokens);

      // UI démo (pas d’email réel)
      demoCode.innerHTML=`<strong>Code généré :</strong> <span style="font-family:ui-monospace,monospace">${codeVal}</span> — valable 10 minutes.`;
      demoCode.classList.add('show');

      // Passer à l’étape 2
      step1.style.display='none'; step2.style.display='block';
      startCountdown();
      showOk('Si un compte existe pour cet email, un code vient d’être généré.');
    });

    backBtn.addEventListener('click',()=>{
      clr(); step2.style.display='none'; step1.style.display='block';
      code.value=''; pw.value=''; pw2.value=''; updateMeter();
    });

    // --- Étape 2: vérifier et réinitialiser ---
    form.addEventListener('submit', async (e)=>{
      e.preventDefault(); clr();
      resetBtn.disabled=true;

      const em=(email.value||'').trim().toLowerCase();
      const c=(code.value||'').trim();
      const p1=String(pw.value||''); const p2=String(pw2.value||'');

      if(!/^\d{6}$/.test(c)){ showErr('Code invalide.'); resetBtn.disabled=false; return; }
      if(p1.length<8 || strength(p1)<3){ showErr('Mot de passe trop faible.'); resetBtn.disabled=false; return; }
      if(p1!==p2){ showErr('Les mots de passe ne correspondent pas.'); resetBtn.disabled=false; return; }

      const tokens=getTokens();
      const t=tokens.find(x=>x.email===em && x.code===c);
      if(!t || t.exp<=Date.now()){ showErr('Code expiré ou incorrect.'); resetBtn.disabled=false; return; }

      // Mettre à jour l’utilisateur s’il existe
      const users=getUsers();
      const idx=users.findIndex(u=>String(u.email).toLowerCase()===em);
      if(idx===-1){
        // Ne pas révéler; on "consomme" le token quand même
        setTokens(tokens.filter(x=>!(x.email===em && x.code===c)));
        showOk('Si un compte existe, le mot de passe a été mis à jour.');
        setTimeout(()=>location.replace('./login.html'), 800);
        return;
      }

      try{
        const salt=btoa(String.fromCharCode(...crypto.getRandomValues(new Uint8Array(16))));
        const hash=await hashPassword(p1, salt);
        users[idx].salt=salt; users[idx].hash=hash; users[idx].updatedAt=new Date().toISOString();
        setUsers(users);

        // Invalider le token
        setTokens(tokens.filter(x=>!(x.email===em && x.code===c)));

        // Si l’utilisateur était connecté avec l’ancien mot de passe, on invalide la session locale par prudence
        const cur=JSON.parse(localStorage.getItem('gf_user')||'null');
        if(cur && (cur.email||'').toLowerCase()===em){
          localStorage.removeItem('gf_user');
        }

        showOk('Mot de passe mis à jour. Vous pouvez vous reconnecter.');
        setTimeout(()=>location.replace('./login.html'), 800);
      }catch(ex){
        console.error(ex);
        showErr('Erreur lors de la mise à jour. Réessayez.');
        resetBtn.disabled=false;
      }
    });
  })();
  </script>
</body>
</html>
