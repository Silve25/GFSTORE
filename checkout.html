<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Finaliser ma commande ‚Äî GF Store</title>
  <meta name="description" content="Paiement s√©curis√© GF Store. Crypto & Virement prioris√©s (bonus imm√©diat). Carte & PayPal en maintenance. Responsive, rapide, moderne.">
  <style>
    :root{
      --bg:#f6f8fb; --panel:#ffffff; --muted:#6b7280; --text:#0f172a; --brand:#2563eb; --ok:#059669; --warn:#d97706; --danger:#dc2626; --line:#e5e7eb;
      --shadow: 0 10px 30px rgba(15,23,36,.06); --radius:16px; --radius-sm:12px; --accent:linear-gradient(90deg,#2563eb,#1e40af);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:15px/1.5 Inter, system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu}
    a{color:inherit;text-decoration:none}

    /* Header */
    header{position:sticky;top:0;z-index:40;background:#fff;border-bottom:1px solid var(--line);backdrop-filter:saturate(140%) blur(6px)}
    .hwrap{max-width:1200px;margin:auto;padding:10px 12px;display:flex;gap:12px;align-items:center;justify-content:space-between}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{height:40px;width:auto;display:block}
    .nav{display:flex;gap:10px;flex-wrap:wrap}
    .nav a,.iconbtn{display:inline-flex;align-items:center;gap:8px;padding:9px 12px;border:1px solid var(--line);background:#fff;border-radius:12px;box-shadow:0 1px 0 rgba(0,0,0,.02)}
    .iconbtn{cursor:pointer}
    .ic{width:16px;height:16px;display:inline-block}
    .dropdown{position:relative}
    .menu{position:absolute;right:0;top:calc(100% + 8px);background:#fff;border:1px solid var(--line);border-radius:12px;padding:6px;min-width:220px;box-shadow:0 10px 24px rgba(0,0,0,.12);display:none;z-index:60}
    .menu.show{display:block}
    .menu a{display:block;padding:8px 10px;border-radius:10px}
    .menu a:hover{background:#f3f4f6}

    /* Banner */
    .banner{background:linear-gradient(90deg,#1e3a8a,#2563eb,#0ea5e9);color:#fff;text-align:center;padding:10px 14px}
    .banner .timer{font-weight:700;border-radius:999px;padding:2px 8px;background:rgba(255,255,255,.15);display:inline-block}
    .banner .sep{opacity:.6;padding:0 6px}

    /* Layout */
    .wrap{max-width:1200px;margin:16px auto 28px;padding:0 12px;display:grid;gap:16px;grid-template-columns:1.2fr .8fr}
    @media (max-width:980px){ .wrap{grid-template-columns:1fr} }
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
    .bd{padding:14px 16px}

    .title{font-weight:800;font-size:18px}
    .muted{color:var(--muted);font-size:13px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:#f3f6ff;border:1px solid #e1e9ff;font-size:12px;color:#0a56d8}
    .chip{display:inline-grid;place-items:center;border:1px solid var(--line);background:#fff;border-radius:999px;padding:2px 8px;font-size:11px;color:#0a56d8}

    /* Forms */
    form{display:grid;gap:12px}
    label{display:block;font-weight:700;margin:4px 0}
    input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);background:#fbfdff;outline:none}
    input::placeholder{color:#a3abb8}
    input:focus,select:focus,textarea:focus{box-shadow:0 8px 24px rgba(37,99,235,.08);border-color:rgba(37,99,235,.38)}
    .row{display:grid;gap:12px}
    .cols-2{grid-template-columns:1fr 1fr}
    .cols-3{grid-template-columns:1fr 1fr 1fr}
    @media (max-width:760px){.cols-2,.cols-3{grid-template-columns:1fr}}

    /* Methods - Decoy effect */
    .methods{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width:900px){.methods{grid-template-columns:repeat(2,1fr)}}
    .tab{position:relative;border:1px solid var(--line);background:#ffffff;border-radius:14px;padding:12px;display:flex;flex-direction:column;align-items:center;gap:8px;cursor:pointer;transition:transform .12s ease, box-shadow .12s ease}
    .tab:hover{transform:translateY(-3px);box-shadow:0 10px 26px rgba(0,0,0,.06)}
    .tab[aria-selected="true"]{border-color:#0a56d8;box-shadow:0 16px 40px rgba(37,99,235,.12)}
    .tab .ico{width:26px;height:26px}
    .tab .badge{position:absolute;top:8px;right:8px;font-size:11px;background:#fff;border:1px solid #eef2ff;color:#0a56d8;padding:4px 8px;border-radius:999px}
    .tab .badge.best{background:#ecfdf5;border-color:#bbf7d0;color:#065f46}
    .tab .badge.maint{background:#fff6e6;border-color:#ffe3b8;color:var(--warn)}
    .tab .sub{font-size:11px;color:#0a56d8;opacity:.85}
    .tab.disabled{opacity:.5;cursor:not-allowed}
    .tab.disabled::after{
      content:"Maintenance"; position:absolute; inset:0; display:grid; place-items:center;
      background:rgba(255,255,255,.7); border-radius:14px; font-weight:700; color:#a16207; letter-spacing:.02em
    }

    /* Panels */
    .pm-panel{display:none;margin-top:12px;border:1px dashed var(--line);background:#fbfdff;border-radius:14px;padding:12px}
    .pm-panel.show{display:block}
    .pair{display:grid;gap:10px}
    @media(min-width:720px){.pair{grid-template-columns:1.2fr .8fr}}
    .copyline{display:grid;grid-template-columns:1fr auto;gap:10px}
    .copy-btn{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:700}
    .copy-btn:hover{box-shadow:0 6px 18px rgba(1,97,234,.06)}
    .qr{display:flex;align-items:center;justify-content:center;height:210px;border-radius:12px;border:1px dashed #dbe7ff;background:#f3f6ff;color:var(--muted);font-weight:700}

    /* Summary */
    .mini{display:flex;flex-direction:column;gap:10px}
    .ci{display:grid;grid-template-columns:60px 1fr auto;gap:8px}
    .ci img{width:60px;height:60px;object-fit:cover;border-radius:10px;border:1px solid var(--line);background:#f8fafc}
    .sum{display:grid;gap:10px;margin-top:10px}
    .sum-row{display:flex;align-items:center;justify-content:space-between}
    .total{font-size:18px;font-weight:900}
    .save{font-size:12px;color:#065f46;background:#ecfdf5;border:1px solid #bbf7d0;border-radius:12px;padding:6px 8px}

    /* Buttons */
    .btn{display:inline-flex;gap:10px;align-items:center;justify-content:center;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;color:var(--text);cursor:pointer;font-weight:800}
    .btn:hover{transform:translateY(-1px)}
    .btn.primary{background:var(--accent);border:none;color:#fff;box-shadow:0 14px 34px rgba(37,99,235,.25)}
    .btn.secondary{background:#fff;border:1px solid var(--line);color:#0f172a}
    .btn.ghost{background:#fafcff}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    /* Toast */
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#111;color:#fff;padding:10px 14px;border-radius:12px;box-shadow:0 12px 24px rgba(0,0,0,.25);display:none;z-index:20000}
    .toast.show{display:block}

    /* Footer */
    footer{background:#fff;border-top:1px solid var(--line);margin-top:16px}
    .fwrap{max-width:1200px;margin:0 auto;padding:16px 12px;display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center;font-size:12px}
    .fwrap a{opacity:.9}
    .fwrap a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="banner">üéâ Promo sp√©ciale : <b>-25% √† -30%</b> sur PC, t√©l√©phones et consoles <span class="sep">‚Ä¢</span> <span id="countdown" class="timer" aria-live="polite"></span></div>

  <header>
    <div class="hwrap">
      <a id="homeLink" class="brand" aria-label="Accueil">
        <img src="assets/img/logopnggfstore.png" class="logo" alt="GF Store" width="180" height="52" decoding="async">
      </a>
      <nav class="nav" aria-label="Navigation principale">
        <a id="accountLink"><svg class="ic" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4.418 3.582-8 8-8s8 3.582 8 8"/></svg> Compte</a>
        <a id="backShop"><svg class="ic" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M15 18l-6-6 6-6"/></svg> Continuer mes achats</a>
        <div class="dropdown">
          <button class="iconbtn" id="menuBtn" aria-label="Menu"><svg class="ic" viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h16M4 12h16M4 18h16"/></svg> </button>
          <div id="menuDrop" class="menu">
            <a id="aboutLink">√Ä propos</a>
            <a id="cgvLink">CGV</a>
            <a id="legalLink">Mentions l√©gales</a>
            <a id="privacyLink">Confidentialit√©</a>
            <a id="contactLink">Contact</a>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <main class="wrap" aria-live="polite">
    <!-- LEFT -->
    <section class="card">
      <div class="hd">
        <div>
          <div class="title">Paiement s√©curis√© <span id="orderIdHeader" class="muted" style="margin-left:8px"></span></div>
          <div class="muted" id="authState">Identification rapide (invit√©)</div>
        </div>
        <span class="pill">SSL activ√©</span>
      </div>

      <div class="bd">
        <!-- Address -->
        <form id="addrForm" class="row cols-2" novalidate>
          <div>
            <label>Nom complet</label>
            <input id="name" placeholder="Pr√©nom Nom" required>
          </div>
          <div>
            <label>Email</label>
            <input id="email" type="email" placeholder="vous@example.com" required>
          </div>
          <div>
            <label>T√©l√©phone</label>
            <input id="phone" inputmode="tel" placeholder="+33 6 12 34 56 78">
          </div>
          <div>
            <label>Pays</label>
            <input id="country" list="countries" placeholder="France">
            <datalist id="countries">
              <option value="France"></option><option value="Belgique"></option><option value="Suisse"></option>
              <option value="Luxembourg"></option><option value="Espagne"></option><option value="Italie"></option>
              <option value="Allemagne"></option><option value="Pays-Bas"></option><option value="Portugal"></option>
              <option value="Royaume-Uni"></option>
            </datalist>
          </div>
          <div>
            <label>Adresse</label>
            <input id="address" placeholder="10 Avenue de l‚ÄôEurope" required>
          </div>
          <div class="cols-2">
            <div>
              <label>Ville</label>
              <input id="city" placeholder="Paris" required>
            </div>
            <div>
              <label>Code postal</label>
              <input id="zip" inputmode="numeric" placeholder="75008" required>
            </div>
          </div>
        </form>

        <!-- Methods (Decoy: highlight Crypto & Virement, show Card/PayPal as maintenance with fees note) -->
        <div style="margin:14px 0 8px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div class="title" style="font-size:16px">M√©thodes de paiement</div>
          <span class="muted">Carte & PayPal en maintenance ‚Äî profitez des <b>bonus imm√©diats</b> Crypto & Virement</span>
        </div>

        <div class="methods" role="tablist">
          <button class="tab" role="tab" aria-selected="true" data-method="crypto" title="Crypto ‚Äî bonus -2%">
            <span class="badge best">Recommand√©</span>
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><circle cx="12" cy="12" r="9"/></svg>
            <div>Crypto</div>
            <div class="sub">0% frais GF ‚Ä¢ <b>-2%</b> imm√©diat</div>
          </button>

          <button class="tab" role="tab" aria-selected="false" data-method="sepa" title="Virement SEPA ‚Äî bonus -1%">
            <span class="badge">Zen</span>
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M3 10l9-6 9 6"/><path d="M4 10v8h16v-8"/></svg>
            <div>Virement</div>
            <div class="sub">0% frais GF ‚Ä¢ <b>-1%</b> imm√©diat</div>
          </button>

          <button class="tab disabled" role="tab" aria-selected="false" data-method="card" title="Carte (maintenance)">
            <span class="badge maint">Maintenance</span>
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><rect x="3" y="5" width="18" height="14" rx="2"/><path d="M3 10h18"/></svg>
            <div>Carte</div>
            <div class="sub">habituellement <s>+2.9% + 0,30‚Ç¨</s></div>
          </button>

          <button class="tab disabled" role="tab" aria-selected="false" data-method="paypal" title="PayPal (maintenance)">
            <span class="badge maint">Maintenance</span>
            <svg class="ico" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M6 18h6a6 6 0 0 0 0-12H8"/></svg>
            <div>PayPal</div>
            <div class="sub">frais variables ‚Ä¢ non dispo</div>
          </button>
        </div>

        <!-- Panels -->
        <div id="pmCrypto" class="pm-panel show" aria-labelledby="Crypto">
          <div class="pair">
            <div>
              <div class="row cols-2">
                <div>
                  <label>Monnaie</label>
                  <select id="ccy">
                    <option value="USDT-TRC20" selected>USDT (TRC20)</option>
                    <option value="USDT-ERC20">USDT (ERC20)</option>
                    <option value="BTC">Bitcoin (BTC)</option>
                    <option value="ETH">Ethereum (ETH)</option>
                  </select>
                </div>
                <div>
                  <label>Montant √† r√©gler (EUR)</label>
                  <input id="amountEur" type="number" min="1" step="0.01" value="0" readonly>
                </div>
              </div>

              <div class="row">
                <div class="copyline">
                  <div>
                    <label>Adresse de paiement</label>
                    <input id="wallet" readonly value="TQf3k7s9h2x4y5z6a7b8c9d0e1f2g3h4i">
                  </div>
                  <button class="copy-btn" data-copy="#wallet">Copier</button>
                </div>

                <div class="copyline">
                  <div>
                    <label>Montant √† envoyer (<span id="ccyLabel">USDT</span>)</label>
                    <input id="amountCcy" readonly value="0">
                  </div>
                  <button class="copy-btn" data-copy="#amountCcy">Copier</button>
                </div>

                <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
                  <span class="chip">Taux verrouill√© : <span id="rateLock">15:00</span></span>
                  <span class="chip" style="color:#065f46;border-color:#bbf7d0;background:#ecfdf5">Bonus -2% appliqu√©</span>
                  <span class="muted">Frais r√©seau non inclus</span>
                </div>
              </div>

              <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:6px">
                <button class="btn primary" id="confirmCrypto">J‚Äôai pay√© ‚Äî confirmer</button>
                <button class="btn secondary" id="refreshRate">Actualiser le taux</button>
              </div>
            </div>

            <div>
              <div class="qr" aria-label="QR code de paiement">QR DE PAIEMENT</div>
              <div class="muted" style="text-align:center;margin-top:8px">Scannez pour pr√©-remplir l‚Äôadresse et le montant</div>
            </div>
          </div>
        </div>

        <div id="pmSEPA" class="pm-panel" aria-labelledby="Virement SEPA">
          <div class="row">
            <div class="pair" style="gap:12px">
              <div>
                <div class="row cols-2">
                  <div>
                    <label>B√©n√©ficiaire</label>
                    <input id="bene" readonly value="GF STORE EU">
                  </div>
                  <div>
                    <label>Banque</label>
                    <input readonly value="Demo International Bank (FR)">
                  </div>
                  <div>
                    <label>IBAN</label>
                    <input id="iban" readonly value="FR76 3000 6000 0112 3456 7890 189">
                  </div>
                  <div>
                    <label>SWIFT/BIC</label>
                    <input id="swift" readonly value="DIBLFRPP">
                  </div>
                  <div>
                    <label>R√©f√©rence virement</label>
                    <input id="vref" readonly value="GF-REF-123456">
                  </div>
                  <div>
                    <label>Total √† r√©gler (EUR)</label>
                    <input id="bankTotal" readonly value="0">
                  </div>
                </div>
                <div style="display:flex;gap:10px;flex-wrap:wrap">
                  <button class="btn ghost" data-copy="#iban">Copier IBAN</button>
                  <button class="btn ghost" data-copy="#swift">Copier BIC</button>
                  <button class="btn ghost" data-copy="#vref">Copier R√©f√©rence</button>
                </div>
                <div class="muted">Conseil : virement instantan√© = traitement plus rapide. <b>Bonus -1% appliqu√©.</b></div>
              </div>

              <div>
                <label>Preuve de virement (facultatif)</label>
                <input type="file" id="proof" accept="image/*,.pdf">
                <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
                  <button class="btn primary" id="confirmBank">J‚Äôai vir√© ‚Äî confirmer</button>
                  <button class="btn secondary" id="askSplit">√âtaler en 2x (sans frais)</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- CTA bottom -->
        <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;margin-top:14px">
          <button id="placeOrder" class="btn primary"><svg class="ic" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="1.8"><path d="M5 12h14"/><path d="M12 5l7 7-7 7"/></svg> Confirmer la commande</button>
          <button id="clearCart" class="btn ghost"><svg class="ic" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6"><path d="M3 6h18"/><path d="M8 6v14a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2V6"/><path d="M10 11v6M14 11v6"/></svg> Vider le panier</button>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="card">
      <div class="hd">
        <div class="title">R√©capitulatif <span id="orderIdSummary" class="muted" style="margin-left:8px"></span></div>
        <span class="pill">Livraison ‚â§ 1 semaine</span>
      </div>
      <div class="bd">
        <div id="miniCart" class="mini" style="margin-bottom:10px"></div>
        <hr style="border:none;border-top:1px dashed var(--line);margin:10px 0">
        <div class="sum">
          <div class="sum-row"><span>Sous-total</span><span id="sub">‚Äî</span></div>
          <div class="sum-row"><span>Livraison</span><span id="ship">‚Äî</span></div>
          <div class="sum-row"><span>Avantage m√©thode</span><span id="benefit">‚Äî</span></div>
          <div class="sum-row"><span>Taxes incl.</span><span id="tax">‚Äî</span></div>
          <div class="sum-row total"><span>Total √† payer</span><span id="total">‚Äî</span></div>
          <div id="saveLine" class="save" style="display:none"></div>
          <div class="muted">üîÅ Retours sous 14 jours ‚Ä¢ üí∏ Remboursement produits neufs ‚Ä¢ üîê Paiement s√©curis√©</div>
        </div>
      </div>
    </aside>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <footer>
    <div class="fwrap">
      <div>¬© GF Store 2025 ‚Äî Simplicit√©, s√©curit√©, crypto-friendly.</div>
      <nav>
        <a id="aboutLink2">√Ä propos</a> ¬∑
        <a id="cgvLink2">CGV</a> ¬∑
        <a id="legalLink2">Mentions l√©gales</a> ¬∑
        <a id="privacyLink2">Confidentialit√©</a> ¬∑
        <a id="contactLink2">Contact</a>
      </nav>
    </div>
  </footer>

  <!-- (Optionnel) pour pr√©remplir depuis le compte si connect√© -->
  <script src="compte/js/auth.js" defer></script>

  <script>
  (async()=>{
    "use strict";
    const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));

    /* --------- GH Root & Nav --------- */
    const GH_ROOT = (()=>{ const p=location.pathname.split('/').filter(Boolean); return (location.host.endsWith('github.io') && p.length)? `/${p[0]}/` : '/'; })();
    function link(id,path){ const el=$('#'+id); if(el) el.href=GH_ROOT+path; }
    link('homeLink','index.html'); link('accountLink','compte/index.html'); link('backShop','index.html');
    ['about','cgv','legal','privacy','contact'].forEach(k=>{ link(k+'Link','pages/'+(k==='about'?'a-propos':k)+'.html'); link(k+'Link2','pages/'+(k==='about'?'a-propos':k)+'.html'); });

    const menuBtn=$('#menuBtn'), menuDrop=$('#menuDrop');
    if(menuBtn&&menuDrop){ menuBtn.addEventListener('click',e=>{e.stopPropagation();menuDrop.classList.toggle('show')}); document.addEventListener('click',e=>{ if(!menuDrop.contains(e.target)&&e.target!==menuBtn) menuDrop.classList.remove('show'); }); }

    /* --------- Promo countdown --------- */
    (function(){ const el=$('#countdown'); if(!el) return; const END=new Date(Date.now()+48*60*60*1000); const two=n=>String(n).padStart(2,'0');
      function tick(){ let d=END-new Date(); if(d<=0){el.textContent='Derni√®res heures !';return} const dj=Math.floor(d/86400000); d%=86400000; const h=Math.floor(d/3600000); d%=3600000; const m=Math.floor(d/60000); const s=Math.floor((d%60000)/1000); el.textContent=`${dj?dj+'j ':''}${two(h)}:${two(m)}:${two(s)} restants`; }
      tick(); setInterval(tick,1000);
    })();

    /* --------- Utils --------- */
    const KEY_CART='gf_cart', KEY_ORDERS='gf_orders';
    const getCart=()=>{try{return JSON.parse(localStorage.getItem(KEY_CART)||'[]')}catch{return[]}};
    const setCart=arr=>localStorage.setItem(KEY_CART,JSON.stringify(arr));
    const EUR=v=>Number(v||0).toLocaleString('fr-FR',{style:'currency',currency:'EUR'});
    const vatIncluded=t=> { const rate=0.20; return t - (t/(1+rate)); };
    const toast=msg=>{const t=$('#toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600); };

    // Order id
    const orderId = (()=>{ const d=new Date(), y=String(d.getFullYear()).slice(2), mm=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'), rnd=Math.floor(Math.random()*9000)+1000; return `GF-${y}${mm}${dd}-${rnd}`; })();
    $('#orderIdHeader').textContent=orderId; $('#orderIdSummary').textContent=orderId;

    /* --------- Prefill from session / Apps Script --------- */
    (async function preload(){
      try{
        const sess=JSON.parse(localStorage.getItem('GF_SESSION')||'null');
        if(sess && sess.email){ $('#authState').textContent='Connect√©'; $('#email').value=sess.email; if(sess.name) $('#name').value=sess.name; }
        else $('#authState').textContent='Invit√©';
        if(window.GFAuth?.api?.listUsers && sess?.email){
          const list=await GFAuth.api.listUsers();
          const me=(list||[]).find(u=>(u.email||'').toLowerCase()===(sess.email||'').toLowerCase());
          if(me){ ['phone','address','city','zip','country','name','email'].forEach(k=>{ if(me[k] && $('#'+k) && !$('#'+k).value) $('#'+k).value=me[k]; }); }
        }
      }catch{}
    })();

    /* --------- Shipping (flat for demo) --------- */
    const shipping=6.90; // Standard forfaitaire (d√©j√† optimis√©)

    /* --------- Method benefits (Decoy effect) --------- */
    // Crypto: -2%, SEPA: -1%, others: 0 (others disabled)
    function benefitRate(){ return currentPM()==='crypto' ? 0.02 : currentPM()==='sepa' ? 0.01 : 0; }

    /* --------- FX mock for crypto --------- */
    const fx = {
      'USDT-TRC20': {symbol:'USDT', rate:1.00}, // assume 1 USDT = 1 EUR (d√©mo)
      'USDT-ERC20': {symbol:'USDT', rate:1.00},
      'BTC': {symbol:'BTC', rate: 60000 },   // 1 BTC ‚âà 60k EUR (d√©mo)
      'ETH': {symbol:'ETH', rate: 3000 }     // 1 ETH ‚âà 3k EUR (d√©mo)
    };
    function setCryptoAddress(ccy){
      const map={
        'USDT-TRC20':'TQf3k7s9h2x4y5z6a7b8c9d0e1f2g3h4i',
        'USDT-ERC20':'0x3Fb8b7E6cA9f4D2E1b0C9a8F7e6D5c4B3a2F1E0',
        'BTC':'bc1q9v8w7x6y5z4a3b2c1d0e9f8g7h6j5k4l3m2n',
        'ETH':'0x9eF2B3cD4a5E6f7B8c9D0E1F2A3b4C5d6E7f8A9B'
      };
      $('#wallet').value=map[ccy]||'';
    }

    /* --------- Summary rendering --------- */
    function computeSub(cart){ return cart.reduce((s,x)=>s+Number(x.price||0)*Number(x.qty||1),0); }
    function currentPM(){ return $('.tab[aria-selected="true"]')?.dataset.method || 'crypto'; }
    function updateSummary(){
      const cart=getCart();
      const wrap=$('#miniCart');
      if(!cart.length){
        wrap.innerHTML='<div class="muted">Votre panier est vide.</div>';
        ['sub','ship','benefit','tax','total'].forEach(id=>$('#'+id).textContent='‚Äî');
        $('#amountEur').value=0; $('#bankTotal').value=0; $('#placeOrder').disabled=true; $('#saveLine').style.display='none';
        return;
      }
      $('#placeOrder').disabled=false;
      wrap.innerHTML=cart.map(x=>`
        <div class="ci">
          <img src="${x.image||''}" alt="${x.name||''}">
          <div>
            <div style="font-weight:700">${x.name||''}</div>
            <div class="muted" style="font-size:12px">${x.brand||''} ‚Ä¢ ${x.category||''}</div>
          </div>
          <div style="font-weight:800">${EUR(Number(x.price||0)*Number(x.qty||1))}</div>
        </div>`).join('');

      const sub=computeSub(cart);
      const benefit = sub * benefitRate();
      const total = Math.max(0, sub + shipping - benefit);
      const tax = vatIncluded(total);

      $('#sub').textContent=EUR(sub);
      $('#ship').textContent=EUR(shipping);
      $('#benefit').textContent= benefit ? '‚Äì'+EUR(benefit) : '‚Äî';
      $('#tax').textContent='‚âà '+EUR(tax);
      $('#total').textContent=EUR(total);

      // Save line (marketing nudge)
      if(benefit>0){
        $('#saveLine').style.display='block';
        const label = currentPM()==='crypto' ? 'crypto' : 'virement';
        $('#saveLine').textContent = `Vous √©conomisez ${EUR(benefit)} en choisissant le ${label}. Intelligent üëè`;
      }else{
        $('#saveLine').style.display='none';
      }

      // Feed panels
      $('#amountEur').value = total.toFixed(2);
      $('#bankTotal').value = total.toFixed(2);

      const ccy=$('#ccy').value; const r=fx[ccy]?.rate||1; const amt = total / r;
      $('#amountCcy').value = (amt>0? amt : 0).toFixed(6).replace(/0+$/,'').replace(/\.$/,'');
      $('#ccyLabel').textContent = fx[ccy]?.symbol || '';
    }

    /* --------- Methods tabs --------- */
    $$('.tab').forEach(tab=>{
      tab.addEventListener('click', ()=>{
        if(tab.classList.contains('disabled')){
          toast('Indisponible. Astuce : Crypto (-2%) ou Virement (-1%) = meilleur prix.');
          return;
        }
        $$('.tab').forEach(t=>t.setAttribute('aria-selected', String(t===tab)));
        // Panels
        $('#pmCrypto').classList.toggle('show', tab.dataset.method==='crypto');
        $('#pmSEPA').classList.toggle('show', tab.dataset.method==='sepa');
        // Recompute benefit & amounts
        updateSummary();
      });
    });

    // Crypto controls
    $('#ccy').addEventListener('change', ()=>{
      const ccy=$('#ccy').value;
      setCryptoAddress(ccy);
      updateSummary();
    });
    $('#refreshRate').addEventListener('click', ()=>{ rateLock=15*60; toast('Taux rafra√Æchi'); });

    // Rate lock 15:00
    let rateLock=15*60;
    setInterval(()=>{ if(rateLock>0){ rateLock--; const m=String(Math.floor(rateLock/60)).padStart(2,'0'), s=String(rateLock%60).padStart(2,'0'); $('#rateLock').textContent=`${m}:${s}`; } else { $('#rateLock').textContent='expir√©'; } },1000);

    // Copy helpers
    function copySel(sel){
      const el=$(sel); if(!el) return;
      if(navigator.clipboard?.writeText){ navigator.clipboard.writeText(el.value||''); toast('Copi√© ‚úÖ'); }
      else{ el.select(); document.execCommand('copy'); toast('Copi√© ‚úÖ'); }
    }
    $$('[data-copy]').forEach(btn=> btn.addEventListener('click', ()=> copySel(btn.getAttribute('data-copy')) ));

    // Ask Split (SEPA)
    $('#askSplit').addEventListener('click', ()=>{
      const totalRaw = Number($('#bankTotal').value||0);
      if(!totalRaw) return;
      const half = Math.round(totalRaw*50)/100;
      toast(`Proposition : 2 √©ch√©ances de ${EUR(half)} (aujourd‚Äôhui) puis ${EUR(totalRaw-half)} dans 30 jours.`);
    });

    // Clear cart
    $('#clearCart').addEventListener('click', ()=>{
      if(!confirm('Vider votre panier ?')) return;
      setCart([]); updateSummary(); toast('Panier vid√©.');
    });

    // Confirmations
    function validateAddress(){
      const req=['name','email','address','city','zip'];
      for(const id of req){ const el=$('#'+id); if(!el || !el.value.trim()){ el?.focus(); toast('Veuillez compl√©ter vos informations.'); return false; } }
      return true;
    }

    $('#confirmCrypto').addEventListener('click', ()=>{
      if(!validateAddress()) return;
      toast('Paiement crypto d√©tect√© ‚Äî en attente de confirmation r√©seau ‚è≥');
    });
    $('#confirmBank').addEventListener('click', ()=>{
      if(!validateAddress()) return;
      toast($('#proof').files.length? 'Preuve re√ßue ‚Äî v√©rification sous 24h' : 'Virement signal√© ‚Äî traitement sous 24‚Äì48h');
    });

    // Place order (save locally & redirect to compte)
    $('#placeOrder').addEventListener('click', ()=>{
      if(!validateAddress()) return;
      const pm = currentPM(); // 'crypto' | 'sepa'
      const cart=getCart(); if(!cart.length){ toast('Votre panier est vide.'); return; }
      const sub=computeSub(cart), benefit=sub*benefitRate(), total=Math.max(0, sub+shipping-benefit);

      const sess=JSON.parse(localStorage.getItem('GF_SESSION')||'null');
      const order={
        id:orderId, date:new Date().toISOString(),
        status: pm==='crypto' ? 'En attente de r√©seau' : 'En attente de r√©ception',
        userId: (sess?.email || 'guest'),
        items: cart,
        pricing:{sub, ship:shipping, benefit, total, currency:'EUR'},
        shipping:{
          name:$('#name').value.trim(), email:$('#email').value.trim(), phone:$('#phone').value.trim(),
          address:$('#address').value.trim(), city:$('#city').value.trim(), zip:$('#zip').value.trim(), country:$('#country').value.trim(),
          method:'standard'
        },
        payment:{method: pm, details: pm==='crypto' ? {ccy:$('#ccy').value, address:$('#wallet').value, amount:$('#amountCcy').value} : {iban:$('#iban').value, ref:$('#vref').value}}
      };

      try{ const all=JSON.parse(localStorage.getItem(KEY_ORDERS)||'[]'); all.push(order); localStorage.setItem(KEY_ORDERS, JSON.stringify(all)); }catch{}

      setCart([]); updateSummary();
      toast('Commande '+order.id+' cr√©√©e ‚úÖ');
      setTimeout(()=>location.replace(GH_ROOT+'compte/index.html'), 900);
    });

    // Initial
    setCryptoAddress($('#ccy').value);
    updateSummary();

  })();
  </script>
</body>
</html>
