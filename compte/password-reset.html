<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>R√©initialiser le mot de passe ‚Äî GF Store</title>
  <meta name="description" content="V√©rifiez votre email et d√©finissez un nouveau mot de passe pour votre compte GF Store.">
  <style>
    :root{
      --w:1200px; --c:#0f172a; --a:#2563eb; --a2:#1e40af; --bg:#f5f7fb;
      --r:16px; --eyeBtn:24px; --eyeIcon:12px;
      --bd:#e5e7eb;
    }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;color:var(--c);background:var(--bg)}
    a{color:inherit}

    /* Header */
    header{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid var(--bd);backdrop-filter:saturate(140%) blur(4px)}
    .hwrap{max-width:var(--w);margin:auto;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;gap:10px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;text-decoration:none}
    .brand .logo{height:40px;width:auto;display:block}
    .nav{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .nav a,.iconbtn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border:1px solid var(--bd);background:#fff;border-radius:12px;text-decoration:none;box-shadow:0 1px 0 rgba(0,0,0,.02)}
    .nav a:hover,.iconbtn:hover{box-shadow:0 2px 10px rgba(0,0,0,.06)}
    .iconbtn{cursor:pointer}
    .ic{width:16px;height:16px;display:inline-block}
    .dropdown{position:relative}
    .menu{position:absolute;right:0;top:calc(100% + 8px);background:#fff;border:1px solid var(--bd);border-radius:12px;padding:6px;min-width:220px;box-shadow:0 10px 24px rgba(0,0,0,.12);display:none;z-index:60}
    .menu.show{display:block}
    .menu a{display:block;padding:8px 10px;border-radius:8px;text-decoration:none}
    .menu a:hover{background:#f3f4f6}

    /* Bandeau info */
    .banner{background:linear-gradient(90deg,#1e3a8a,#2563eb,#0ea5e9);color:#fff;text-align:center;padding:10px 14px}
    .banner .timer{font-weight:700;border-radius:999px;padding:2px 8px;background:rgba(255,255,255,.15);display:inline-block}
    .banner .sep{opacity:.6;padding:0 6px}

    /* Carte / Form */
    .wrap{max-width:560px;margin:18px auto 40px;padding:0 12px}
    .card{background:#fff;border:1px solid var(--bd);border-radius:16px;padding:16px;box-shadow:0 1px 0 rgba(0,0,0,.02)}
    h1{font-size:18px;margin:0 0 8px}
    h2{font-size:15px;margin:14px 0 6px}
    .muted{opacity:.75;font-size:12px}

    form{display:grid;gap:10px}
    label{display:block;font-weight:600;margin:6px 0 4px}
    input, select{width:100%;padding:12px;border:1px solid var(--bd);border-radius:12px;background:#fff}

    .row{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;gap:8px;justify-content:center;width:100%;padding:12px;border:1px solid #1e40af;background:linear-gradient(180deg,#2563eb,#1e40af);color:#fff;border-radius:12px;cursor:pointer;box-shadow:0 6px 14px rgba(30,64,175,.25)}
    .btn.secondary{background:#fff;border:1px solid var(--bd);color:#111}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .msg{margin-top:6px;padding:10px;border-radius:12px;display:none}
    .msg.ok{display:block;background:#ecfdf5;border:1px solid #bbf7d0;color:#065f46}
    .msg.err{display:block;background:#fef2f2;border:1px solid #fee2e2;color:#991b1b}

    /* Password UI */
    .pw{position:relative}
    .pw .toggle{
      position:absolute;right:8px;top:50%;transform:translateY(-50%);
      width:var(--eyeBtn);height:var(--eyeBtn);
      border:1px solid var(--bd);background:#fff;border-radius:10px;
      cursor:pointer;line-height:0;padding:0;
      background-repeat:no-repeat;background-position:center;
      background-size:var(--eyeIcon) var(--eyeIcon);
    }
    .meter{height:8px;background:#f1f5f9;border-radius:999px;overflow:hidden;border:1px solid var(--bd)}
    .meter>i{display:block;height:100%;width:0;transition:width .2s}
    .meter[data-lvl="1"]>i{width:25%;background:#ef4444}
    .meter[data-lvl="2"]>i{width:50%;background:#f59e0b}
    .meter[data-lvl="3"]>i{width:75%;background:#10b981}
    .meter[data-lvl="4"]>i{width:100%;background:#10b981}

    /* Overlay v√©rification */
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);backdrop-filter:blur(2px);display:none;z-index:10000;align-items:center;justify-content:center}
    .overlay.show{display:flex}
    .sheet{background:#fff;border:1px solid var(--bd);border-radius:14px;padding:16px;min-width:min(460px,95%);box-shadow:0 18px 38px rgba(0,0,0,.25);text-align:center}
    .spin{width:38px;height:38px;border:3px solid #e5e7eb;border-top-color:#1e40af;border-radius:50%;animation:spin 1s linear infinite;margin:8px auto}
    @keyframes spin{to{transform:rotate(360deg)}}
    .ov-title{font-weight:700}
    .ov-sub{color:#6b7280;font-size:13px}
    .ov-ok{display:none;font-size:32px;margin:6px 0}

    footer{background:#fff;border-top:1px solid var(--bd)}
    .fwrap{max-width:var(--w);margin:0 auto;padding:16px 12px;display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center;font-size:12px}
    .fwrap a{text-decoration:none;color:inherit;opacity:.9}
    .fwrap a:hover{text-decoration:underline}

    /* √âtape 2 masqu√©e tant que non v√©rifi√© */
    #step2[aria-hidden="true"]{display:none}
  </style>
</head>
<body>
  <div class="banner">üîê R√©initialisez votre mot de passe en 2 √©tapes : <b>v√©rifiez votre email</b> puis <b>d√©finissez un nouveau mot de passe</b> <span class="sep">‚Ä¢</span> <span id="countdown" class="timer" aria-live="polite"></span></div>

  <header>
    <div class="hwrap">
      <a id="homeLink" class="brand" aria-label="Accueil">
        <img src="../assets/img/logopnggfstore.png" class="logo" alt="GF Store" width="180" height="52" decoding="async">
      </a>
      <nav class="nav" aria-label="Navigation">
        <a id="loginLink"><img class="ic" id="icUser" alt=""> Connexion</a>
        <a id="shopLink"><img class="ic" id="icHome" alt=""> Boutique</a>
        <div class="dropdown">
          <button class="iconbtn" id="menuBtn" aria-label="Menu"><img class="ic" id="icMenu" alt=""></button>
          <div id="menuDrop" class="menu">
            <a id="aboutLink">√Ä propos</a>
            <a id="cgvLink">CGV</a>
            <a id="legalLink">Mentions l√©gales</a>
            <a id="privacyLink">Confidentialit√©</a>
            <a id="contactLink">Contact</a>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <div class="card">
      <h1>R√©initialiser le mot de passe</h1>
      <div class="muted">√âtape 1&nbsp;: v√©rifiez votre email. √âtape 2&nbsp;: choisissez un nouveau mot de passe.</div>

      <!-- √âtape 1 : V√©rifier l'email -->
      <h2>√âtape 1 ‚Äî V√©rifier mon email</h2>
      <form id="verifyForm" novalidate>
        <label for="email">Votre email</label>
        <input id="email" name="email" type="email" placeholder="vous@example.com" autocomplete="email" required>
        <button class="btn" type="submit"><img class="ic" id="icSend" alt=""> V√©rifier mon email</button>
        <div id="verifyMsg" class="msg" role="status" aria-live="polite"></div>
      </form>

      <hr style="border:none;border-top:1px dashed #e5e7eb;margin:16px 0">

      <!-- √âtape 2 : Nouveau mot de passe (d√©bloqu√©e si email v√©rifi√©) -->
      <section id="step2" aria-hidden="true" aria-labelledby="h2-step2">
        <h2 id="h2-step2">√âtape 2 ‚Äî D√©finir un nouveau mot de passe</h2>
        <form id="newPwForm" novalidate>
          <label for="email2">Email</label>
          <input id="email2" name="email" type="email" placeholder="vous@example.com" autocomplete="email" required readonly>

          <label for="newPassword">Nouveau mot de passe</label>
          <div class="pw">
            <input id="newPassword" name="newPassword" type="password" placeholder="Au moins 6 caract√®res" autocomplete="new-password" required>
            <button type="button" class="toggle" data-target="newPassword" aria-label="Afficher/Masquer"></button>
          </div>
          <div class="meter" id="meter"><i></i></div>

          <label for="newPassword2">Confirmer le mot de passe</label>
          <div class="pw">
            <input id="newPassword2" type="password" placeholder="Ressaisissez le mot de passe" autocomplete="new-password" required>
            <button type="button" class="toggle" data-target="newPassword2" aria-label="Afficher/Masquer"></button>
          </div>

          <div class="row">
            <a class="btn secondary" id="backToLogin">Retour connexion</a>
            <button class="btn" type="submit"><img class="ic" id="icReset" alt=""> Mettre √† jour</button>
          </div>

          <div id="resetMsg" class="msg" role="status" aria-live="polite"></div>
        </form>
      </section>
    </div>
  </main>

  <!-- Overlay de v√©rification -->
  <div id="verifyOverlay" class="overlay" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="sheet" role="status" aria-live="polite">
      <div class="ov-title" id="ovTitle">V√©rification en cours‚Ä¶</div>
      <div class="spin" aria-hidden="true"></div>
      <div class="ov-sub" id="ovSub">Nous cherchons votre compte dans notre base.</div>
      <div class="ov-ok" id="ovOk">‚úÖ</div>
    </div>
  </div>

  <footer>
    <div class="fwrap">
      <div>¬© GF Store 2025 ‚Äî Simplicit√©, s√©curit√©, crypto-friendly.</div>
      <nav>
        <a id="aboutLink2">√Ä propos</a> ¬∑
        <a id="cgvLink2">CGV</a> ¬∑
        <a id="legalLink2">Mentions l√©gales</a> ¬∑
        <a id="privacyLink2">Confidentialit√©</a> ¬∑
        <a id="contactLink2">Contact</a>
      </nav>
    </div>
  </footer>

  <!-- API / session logic -->
  <script src="js/auth.js" defer></script>

  <script>
  (function(){
    "use strict";
    const $=(s,root)=> (root||document).querySelector(s);
    const $$=(s,root)=> Array.from((root||document).querySelectorAll(s));

    // GH_ROOT (GitHub Pages friendly)
    const GH_ROOT = (()=>{ 
      const parts = location.pathname.split('/').filter(Boolean);
      return (location.host.endsWith('github.io') && parts.length) ? '/' + parts[0] + '/' : '/';
    })();

    // Ic√¥nes
    const ICONS = {
      user:'https://img.icons8.com/?size=100&id=60655&format=png&color=000000',
      home:'https://img.icons8.com/?size=100&id=98956&format=png&color=000000',
      menu:'https://img.icons8.com/?size=100&id=RzDomvpIKGI9&format=png&color=000000',
      send:'https://img.icons8.com/?size=100&id=86855&format=png&color=000000',
      reset:'https://img.icons8.com/?size=100&id=12491&format=png&color=000000',
      eye:'https://img.icons8.com/?size=100&id=986&format=png&color=000000',
      eyeOff:'https://img.icons8.com/?size=100&id=59814&format=png&color=000000'
    };
    const setSrc=(id,src)=>{const el=document.getElementById(id); if(el) el.src=src};

    // Liens
    function link(id,path){ const el=document.getElementById(id); if(el) el.href=GH_ROOT+path; }
    function wireLinks(){
      $('#homeLink').href = GH_ROOT;
      link('loginLink','compte/login.html');
      link('shopLink','index.html');
      link('backToLogin','compte/login.html');
      const pages = {about:'a-propos', cgv:'cgv', legal:'mentions-legales', privacy:'confidentialite', contact:'contact'};
      Object.entries(pages).forEach(([k,slug])=>{
        link(k+'Link','pages/'+slug+'.html');
        link(k+'Link2','pages/'+slug+'.html');
      });
    }

    // Menu
    function wireMenu(){
      const btn=$('#menuBtn'), drop=$('#menuDrop');
      if(!btn||!drop) return;
      btn.addEventListener('click',e=>{e.stopPropagation();drop.classList.toggle('show')});
      document.addEventListener('click',e=>{ if(!drop.contains(e.target) && e.target!==btn) drop.classList.remove('show'); });
    }

    // Compte √† rebours (48h)
    function wireCountdown(){
      const el=$('#countdown'); if(!el) return;
      const END=new Date(Date.now()+48*60*60*1000); const two=n=>String(n).padStart(2,'0');
      function tick(){
        const now=new Date(); let diff=END-now;
        if(diff<=0){ el.textContent='Derni√®res heures !'; return; }
        const d=Math.floor(diff/86400000); diff%=86400000;
        const h=Math.floor(diff/3600000); diff%=3600000;
        const m=Math.floor(diff/60000); const s=Math.floor((diff%60000)/1000);
        el.textContent=`${d?d+'j ':''}${two(h)}:${two(m)}:${two(s)} restants`;
      }
      tick(); setInterval(tick,1000);
    }

    // Helpers UI
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    function showMsg(el, txt, ok=false){
      if(!el) return;
      el.className = 'msg ' + (txt ? (ok?'ok':'err') : '');
      el.textContent = txt || '';
      el.style.display = txt ? 'block' : 'none';
    }
    function setDisabled(form,on){ if(!form) return; $$('input,button,select,textarea',form).forEach(el=>el.disabled=!!on); }
    function isEmail(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v||'').trim()); }

    // Overlay
    const overlay = $('#verifyOverlay'), ovTitle=$('#ovTitle'), ovSub=$('#ovSub'), ovOk=$('#ovOk');
    function showOverlay(title,sub,asOk=false){
      if(ovTitle) ovTitle.textContent = title || 'V√©rification en cours‚Ä¶';
      if(ovSub) ovSub.textContent = sub || 'Nous cherchons votre compte dans notre base.';
      if(ovOk) ovOk.style.display = asOk ? 'block' : 'none';
      overlay?.classList.add('show');
      overlay?.setAttribute('aria-hidden','false');
    }
    function hideOverlay(){
      overlay?.classList.remove('show');
      overlay?.setAttribute('aria-hidden','true');
    }

    // Password UI (≈ìil + force + confirmation)
    function wirePasswordUI(){
      $$('.pw .toggle').forEach(btn=>{
        const id=btn.getAttribute('data-target');
        const input=document.getElementById(id);
        if(!input) return;
        btn.style.backgroundImage = `url(${ICONS.eye})`;
        btn.addEventListener('click',()=>{
          const show = input.type === 'password';
          input.type = show ? 'text' : 'password';
          btn.style.backgroundImage = `url(${show ? ICONS.eyeOff : ICONS.eye})`;
        });
      });

      const meter = document.getElementById('meter');
      const pw = document.getElementById('newPassword');
      function strength(v){
        let s=0; if(v.length>=6) s++; if(/[A-Z]/.test(v)) s++; if(/[a-z]/.test(v)) s++; if(/[0-9\W_]/.test(v)) s++;
        return Math.min(s,4);
      }
      function updateMeter(){ if(meter && pw) meter.setAttribute('data-lvl', String(strength(pw.value)||0)); }
      if(pw){ pw.addEventListener('input', updateMeter); updateMeter(); }

      const pw2 = document.getElementById('newPassword2');
      function validateMatch(){
        if(!pw || !pw2) return;
        if(pw2.value && pw.value !== pw2.value){
          pw2.setCustomValidity('Les mots de passe ne correspondent pas.');
        }else{
          pw2.setCustomValidity('');
        }
      }
      if(pw && pw2){
        pw.addEventListener('input', validateMatch);
        pw2.addEventListener('input', validateMatch);
      }
    }

    // Ic√¥nes & liens
    function setIcons(){
      setSrc('icUser', ICONS.user);
      setSrc('icHome', ICONS.home);
      setSrc('icMenu', ICONS.menu);
      setSrc('icSend', ICONS.send);
      setSrc('icReset', ICONS.reset);
    }

    // -------- Logique "sans code" --------
    // 1) V√©rifier email ‚Üí d√©bloque √©tape 2
    function wireVerify(){
      const form = $('#verifyForm'); if(!form) return;
      const msg  = $('#verifyMsg');
      form.addEventListener('submit', async (e)=>{
        e.preventDefault(); setDisabled(form,true); showMsg(msg,'');
        try{
          const email = form.email?.value?.trim();
          if(!isEmail(email)) throw new Error('Email invalide.');
          showOverlay('V√©rification en cours‚Ä¶','Nous cherchons votre compte dans notre base.');

          // Utilise l‚ÄôAPI expos√©e par auth.js
          const API = (window.GFAuth && window.GFAuth.api) ? window.GFAuth.api : null;
          if(!API || !API.listUsers) throw new Error('API indisponible.');

          const users = await API.listUsers(); // tableau "sanitized"
          const found = Array.isArray(users) && users.find(u => (u.email||'').toLowerCase() === email.toLowerCase());

          if(!found){
            hideOverlay();
            throw new Error('Aucun compte associ√© √† cet email.');
          }

          // OK ‚Üí afficher succ√®s overlay court puis d√©bloquer l‚Äô√©tape 2
          ovTitle.textContent = 'Compte trouv√©';
          ovSub.textContent   = 'Vous pouvez d√©finir un nouveau mot de passe.';
          ovOk.style.display  = 'block';
          await sleep(500);
          hideOverlay();

          // D√©bloquer √©tape 2
          const step2 = document.getElementById('step2');
          if(step2){
            step2.setAttribute('aria-hidden','false');
            const e2 = document.getElementById('email2'); if(e2) e2.value = email;
            // Focus sur le champ mot de passe
            setTimeout(()=>document.getElementById('newPassword')?.focus(), 50);
          }
          showMsg(msg, 'Email v√©rifi√©. Vous pouvez d√©finir un nouveau mot de passe.', true);
        }catch(err){
          showMsg(msg, err.message || 'Erreur.');
        }finally{
          setDisabled(form,false);
          hideOverlay();
        }
      });
    }

    // 2) Mettre √† jour le mot de passe (sans token)
    //    -> on s‚Äôappuie ici sur updateProfile c√¥t√© Apps Script (updates.password)
    function wireNewPassword(){
      const form = $('#newPwForm'); if(!form) return;
      const msg  = $('#resetMsg');

      form.addEventListener('submit', async (e)=>{
        e.preventDefault(); setDisabled(form,true); showMsg(msg,'');

        try{
          const email = form.email?.value?.trim();
          const newPassword = form.newPassword?.value || '';
          const newPassword2 = $('#newPassword2')?.value || '';
          if(!isEmail(email)) throw new Error('Email invalide.');
          if(String(newPassword).length < 6) throw new Error('Mot de passe trop court (‚â• 6 caract√®res).');
          if(newPassword !== newPassword2) throw new Error('Les mots de passe ne correspondent pas.');

          const API = (window.GFAuth && window.GFAuth.api) ? window.GFAuth.api : null;
          if(!API || !API.updateProfile) throw new Error('API indisponible.');

          // Mettre √† jour via updateProfile (le backend doit accepter updates.password)
          const resp = await API.updateProfile({ email, updates:{ password: newPassword } });
          if(!resp || !resp.ok){
            // Codes possibles : NOT_FOUND / FORBIDDEN... selon ton Apps Script
            throw new Error(resp?.error || 'Mise √† jour impossible.');
          }

          showMsg(msg, 'Mot de passe mis √† jour. Vous pouvez vous connecter.', true);
          await sleep(500);
          // Redirection connexion
          location.href = GH_ROOT + 'compte/login.html';
        }catch(err){
          showMsg(msg, err.message || 'Erreur.');
        }finally{
          setDisabled(form,false);
        }
      });
    }

    // -------- INIT --------
    function init(){
      wireLinks(); wireMenu(); wireCountdown(); setIcons();
      wirePasswordUI();
      // Pr√©-remplir email2 si query ?email=...
      const q = new URL(location.href).searchParams.get('email');
      if(q){ const e1=$('#email'); const e2=$('#email2'); if(e1 && !e1.value) e1.value=q; if(e2 && !e2.value) e2.value=q; }

      wireVerify();
      wireNewPassword();
    }
    document.addEventListener('DOMContentLoaded', init);
  })();
  </script>
</body>
</html>
