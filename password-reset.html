<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>R√©initialiser le mot de passe ‚Äî GF Store</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="R√©initialisez le mot de passe de votre compte GF Store en toute s√©curit√©." />
  <meta name="format-detection" content="telephone=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />

  <!-- CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
  <link rel="stylesheet" href="css/vendor.css">
  <link rel="stylesheet" href="style.css">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Jost:wght@300;400;500;700&family=Marcellus&display=swap" rel="stylesheet" />

  <style>
    :root{ --cardW: 720px; }
    body{ background:#fafafa; }
    .auth-wrap{ min-height:100vh; display:flex; align-items:center; padding:32px 0; }
    .brand-mini{ font-family: "Marcellus", serif; letter-spacing:.02em; }
    .card-auth{ max-width:var(--cardW); margin:0 auto; border:1px solid #eee; box-shadow:0 12px 40px rgba(0,0,0,.06); }
    .muted-link{ color:inherit; opacity:.75; text-decoration:none }
    .muted-link:hover{ opacity:1 }
    .pw-eye{ position:absolute; right:.75rem; top:50%; transform:translateY(-50%); border:0; background:transparent }
    .pw-wrap{ position:relative }
    .pw-meter{ height:8px; border-radius:6px; background:#eee; overflow:hidden }
    .pw-meter > div{ height:100%; width:0%; background:#22c55e; transition:width .25s ease }
    .req-list{ margin:.25rem 0 0 0; padding-left:1.1rem; }
    .req-list li{ font-size:.9rem }
    .req-ok{ color:#16a34a }
    .req-ko{ color:#991b1b }
    .toast-container{ z-index:1080 }
  </style>
</head>
<body>

  <!-- Header simple -->
  <nav class="navbar navbar-expand-lg bg-white border-bottom fixed-top">
    <div class="container">
      <a class="navbar-brand brand-mini" href="index.html">GF Store</a>
      <div class="d-flex gap-2">
        <a class="btn btn-sm btn-outline-secondary d-none d-md-inline" href="catalogue.html">Catalogue</a>
        <a class="btn btn-sm btn-dark" href="login.html">Se connecter</a>
      </div>
    </div>
  </nav>

  <main class="auth-wrap">
    <div class="container">
      <div class="card card-auth rounded-4">
        <div class="row g-0">
          <!-- Visuel (masqu√© en mobile) -->
          <div class="col-lg-5 d-none d-lg-block">
            <div class="h-100 w-100" style="background:url('images/single-image-2.jpg') center/cover no-repeat; border-top-left-radius:1rem; border-bottom-left-radius:1rem;"></div>
          </div>

          <!-- Contenu -->
          <div class="col-lg-7">
            <div class="p-4 p-md-5">
              <!-- STEP 1: Demande de r√©init -->
              <section id="step-request" hidden>
                <h1 class="h3 mb-1">R√©initialiser votre mot de passe</h1>
                <p class="text-secondary mb-4">Entrez l‚Äôadresse email associ√©e √† votre compte. Nous vous enverrons un lien s√©curis√©.</p>

                <form id="requestForm" novalidate>
                  <div class="row g-3">
                    <div class="col-12">
                      <label class="form-label" for="reqEmail">Email</label>
                      <input class="form-control" id="reqEmail" name="email" type="email" autocomplete="email" required>
                      <div class="invalid-feedback">Adresse email invalide.</div>
                    </div>

                    <div class="col-12">
                      <button class="btn btn-dark w-100" type="submit">Envoyer le lien de r√©initialisation</button>
                    </div>

                    <div class="col-12">
                      <p class="small text-secondary mb-0">
                        Vous n‚Äôavez pas de compte ? <a class="muted-link" href="register.html">Cr√©er un compte</a>
                        ¬∑ Besoin d‚Äôaide ? <a class="muted-link" href="contact.html">Contact</a>
                      </p>
                    </div>
                  </div>
                </form>
              </section>

              <!-- STEP 2: Formulaire avec token -->
              <section id="step-reset" hidden>
                <h1 class="h3 mb-1">D√©finir un nouveau mot de passe</h1>
                <p class="text-secondary mb-4">
                  Cr√©ez un mot de passe fort pour s√©curiser votre compte.
                </p>

                <form id="resetForm" novalidate>
                  <input type="hidden" id="token">
                  <input type="hidden" id="email">
                  <div class="row g-3">
                    <div class="col-12">
                      <label class="form-label" for="newPassword">Nouveau mot de passe</label>
                      <div class="pw-wrap">
                        <input class="form-control" id="newPassword" name="password" type="password" autocomplete="new-password" required>
                        <button class="pw-eye" type="button" aria-label="Afficher/masquer">üëÅÔ∏è</button>
                        <div class="invalid-feedback">Mot de passe requis.</div>
                      </div>
                      <div class="pw-meter mt-2" aria-hidden="true"><div id="pwBar"></div></div>
                      <ul class="req-list mt-2">
                        <li id="rqLen" class="req-ko">Au moins 8 caract√®res</li>
                        <li id="rqCase" class="req-ko">Majuscules et minuscules</li>
                        <li id="rqNum" class="req-ko">Au moins un chiffre</li>
                        <li id="rqSpec" class="req-ko">Au moins un caract√®re sp√©cial</li>
                      </ul>
                    </div>

                    <div class="col-12">
                      <label class="form-label" for="confirmPassword">Confirmer le mot de passe</label>
                      <div class="pw-wrap">
                        <input class="form-control" id="confirmPassword" type="password" autocomplete="new-password" required>
                        <button class="pw-eye" type="button" aria-label="Afficher/masquer">üëÅÔ∏è</button>
                        <div class="invalid-feedback">La confirmation ne correspond pas.</div>
                      </div>
                    </div>

                    <div class="col-12">
                      <button class="btn btn-dark w-100" type="submit">Mettre √† jour le mot de passe</button>
                    </div>

                    <div class="col-12">
                      <p class="small text-secondary mb-0">
                        Un souci avec le lien ? <a class="muted-link" href="password-reset.html">Demander un nouveau lien</a>
                      </p>
                    </div>
                  </div>
                </form>
              </section>

              <hr class="my-4">
              <div class="d-flex justify-content-between">
                <a class="btn btn-outline-secondary" href="login.html">Se connecter</a>
                <a class="btn btn-outline-secondary" href="register.html">Cr√©er un compte</a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- toasts -->
      <div class="position-fixed top-0 end-0 p-3 toast-container">
        <div id="toastOK" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">Op√©ration r√©ussie.</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fermer"></button>
          </div>
        </div>
        <div id="toastInfo" class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">Si un compte existe, un email a √©t√© envoy√©.</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fermer"></button>
          </div>
        </div>
        <div id="toastErr" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">Une erreur est survenue.</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fermer"></button>
          </div>
        </div>
        <div id="toastWarn" class="toast align-items-center text-bg-warning border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">Fonction indisponible : chargez <code>app.js</code>.</div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Fermer"></button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer mini -->
  <footer class="py-4 border-top">
    <div class="container d-flex flex-wrap justify-content-between align-items-center gap-3">
      <small>¬© 2025 GF Store</small>
      <div class="small text-secondary">Paiement accept√© : <strong>Virement bancaire uniquement</strong></div>
    </div>
  </footer>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="js/app.js"></script>

  <script>
    (function(){
      // Helpers
      const $ = sel => document.querySelector(sel);
      const show = (el, v=true) => { el.hidden = !v; };
      const emailRx = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      const toast = (id, msg) => {
        const t = document.getElementById(id);
        if(msg) t.querySelector('.toast-body').textContent = msg;
        new bootstrap.Toast(t, {delay:2000}).show();
      };

      // Elements
      const stepReq = $('#step-request');
      const stepReset = $('#step-reset');
      const reqForm = $('#requestForm');
      const reqEmail = $('#reqEmail');

      const resetForm = $('#resetForm');
      const tokenEl = $('#token');
      const emailEl = $('#email');
      const newPw = $('#newPassword');
      const cfmPw = $('#confirmPassword');
      const bar = $('#pwBar');

      // Mode: request vs reset
      const url = new URL(window.location.href);
      const token = url.searchParams.get('token');
      const email = url.searchParams.get('email') || '';

      if(token){
        show(stepReset, true);
        show(stepReq, false);
        tokenEl.value = token;
        emailEl.value = email; // optionnel
      } else {
        show(stepReq, true);
        show(stepReset, false);
      }

      // Toggle eyes
      document.querySelectorAll('.pw-eye').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const input = btn.previousElementSibling;
          input.type = input.type === 'password' ? 'text' : 'password';
        });
      });

      // Password strength validator
      function pwScore(v){
        let s = 0;
        if(v.length >= 8) s++;
        if(/[a-z]/.test(v) && /[A-Z]/.test(v)) s++;
        if(/\d/.test(v)) s++;
        if(/[^\w\s]/.test(v)) s++;
        return s; // 0..4
      }
      function updateReqs(v){
        const set = (id, ok)=>{ const el = document.getElementById(id); el.className = ok ? 'req-ok' : 'req-ko'; };
        set('rqLen', v.length>=8);
        set('rqCase', /[a-z]/.test(v) && /[A-Z]/.test(v));
        set('rqNum', /\d/.test(v));
        set('rqSpec', /[^\w\s]/.test(v));
      }
      newPw?.addEventListener('input', ()=>{
        const v = newPw.value;
        const s = pwScore(v);
        bar.style.width = (s*25)+'%';
        bar.style.background = s<2 ? '#ef4444' : s<3 ? '#f59e0b' : s<4 ? '#22c55e' : '#16a34a';
        updateReqs(v);
      });

      // STEP 1 submit
      reqForm?.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const val = reqEmail.value.trim().toLowerCase();
        if(!emailRx.test(val)){
          reqEmail.classList.add('is-invalid'); 
          return;
        }
        reqEmail.classList.remove('is-invalid');

        try{
          if(!(window.App && typeof App.requestPasswordReset === 'function')){
            toast('toastWarn', 'Fonction indisponible : chargez app.js');
            return;
          }
          await App.requestPasswordReset({ email: val });
          toast('toastInfo', 'Si un compte existe, un email a √©t√© envoy√©.');
          // UX: proposer de v√©rifier la bo√Æte mail
          setTimeout(()=>{ window.location.href = 'login.html'; }, 1800);
        }catch(err){
          console.error(err);
          toast('toastErr', 'Impossible d‚Äôenvoyer l‚Äôemail pour le moment.');
        }
      });

      // STEP 2 submit
      resetForm?.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const p1 = newPw.value;
        const p2 = cfmPw.value;

        // validations basiques
        const okLen  = p1.length>=8;
        const okCase = /[a-z]/.test(p1) && /[A-Z]/.test(p1);
        const okNum  = /\d/.test(p1);
        const okSpec = /[^\w\s]/.test(p1);
        const okAll  = okLen && okCase && okNum && okSpec;

        if(!okAll){ newPw.classList.add('is-invalid'); return; } else { newPw.classList.remove('is-invalid'); }
        if(p1 !== p2){ cfmPw.classList.add('is-invalid'); return; } else { cfmPw.classList.remove('is-invalid'); }

        const payload = {
          token: tokenEl.value,
          email: emailEl.value || undefined,
          password: p1
        };

        try{
          if(!(window.App && typeof App.resetPassword === 'function')){
            toast('toastWarn', 'Fonction indisponible : chargez app.js');
            return;
          }
          await App.resetPassword(payload);
          toast('toastOK', 'Mot de passe mis √† jour. Vous pouvez vous connecter.');
          setTimeout(()=>{ window.location.href = 'login.html'; }, 1200);
        }catch(err){
          console.error(err);
          const msg = (err && err.code === 'TOKEN_INVALID') 
            ? 'Lien invalide ou expir√©. Demandez un nouveau lien.'
            : 'R√©initialisation impossible pour le moment.';
          toast('toastErr', msg);
        }
      });
    })();
  </script>
</body>
</html>
